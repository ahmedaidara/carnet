<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carnet de l'√©l√®ve</title>
    <style>
        :root {
            --primary: #6C63FF;
            --secondary: #4FC3F7;
            --accent: #FF6B9D;
            --success: #4CD97B;
            --warning: #FFB74D;
            --danger: #FF5252;
            --dark: #2D3047;
            --light: #F9F7FE;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --primary: #8B80F8;
            --secondary: #66D3FA;
            --accent: #FF8BB5;
            --success: #6AE395;
            --warning: #FFC870;
            --danger: #FF6B6B;
            --dark: #1A1C2B;
            --light: #25283D;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--light) 0%, #E8EAF6 100%);
            color: var(--dark);
            min-height: 100vh;
            padding-bottom: 80px;
            transition: var(--transition);
        }

        body.dark-mode {
            background: linear-gradient(135deg, var(--dark) 0%, #1E1F2E 100%);
            color: var(--light);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--shadow);
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #5A52E0;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            opacity: 0.7;
        }

        .btn-danger:hover {
            opacity: 1;
        }

        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
            text-decoration: none;
            font-size: 12px;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .subject-card {
            position: relative;
            overflow: hidden;
        }

        .subject-color {
            height: 4px;
            background: var(--primary);
            margin-bottom: 12px;
            border-radius: 2px;
        }

        .sparkline {
            height: 40px;
            margin-top: 12px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            font-size: 14px;
            margin: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--light);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .dark-mode .modal-content {
            background: var(--dark);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            background: var(--glass);
            color: var(--dark);
            transition: var(--transition);
        }

        .dark-mode .form-input {
            color: var(--light);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
        }

        .file-preview {
            margin-top: 20px;
            padding: 20px;
            background: var(--glass);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .timetable {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 1px;
            background: var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .timetable-header {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .timetable-cell {
            background: var(--light);
            padding: 8px;
            min-height: 60px;
            font-size: 12px;
        }

        .dark-mode .timetable-cell {
            background: var(--dark);
        }

        .time-slot {
            background: var(--secondary);
            color: white;
            padding: 6px 8px;
            border-radius: 8px;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .pdf-viewer {
            width: 100%;
            height: 600px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .streak {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--glass);
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--accent);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .subject-grid {
                grid-template-columns: 1fr;
            }
            
            .timetable {
                grid-template-columns: 50px repeat(7, 1fr);
                font-size: 11px;
            }
            
            .pdf-viewer {
                height: 400px;
            }
        }

        .ripple {
            position: relative;
            overflow: hidden;
            transform: translate3d(0, 0, 0);
        }

        .ripple:after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }

        .ripple:active:after {
            transform: scale(0, 0);
            opacity: .2;
            transition: 0s;
        }
      
      @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
      
      .timetable-cell {
    min-height: 80px;
    position: relative;
    transition: all 0.2s ease;
}

.timetable-cell:hover {
    background: rgba(108, 99, 255, 0.05);
}

.time-slot {
    padding: 6px 8px;
    border-radius: 8px;
    margin-bottom: 4px;
    font-size: 11px;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.time-slot:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.timetable-header {
    background: var(--primary);
    color: white;
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    font-size: 12px;
    position: sticky;
    top: 0;
}

/* Responsive */
@media (max-width: 768px) {
    .timetable {
        font-size: 10px;
    }
    
    .timetable-header {
        padding: 8px 4px;
        font-size: 10px;
    }
    
    .time-slot {
        padding: 4px 6px;
        font-size: 9px;
    }
    
    .timetable-cell {
        min-height: 60px;
    }
}
      
      /* Ajoutez ce CSS */
.drag-over {
    background: rgba(108, 99, 255, 0.1) !important;
    border: 2px dashed var(--primary) !important;
}

.file-upload-area {
    border: 2px dashed var(--glass-border);
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    margin-bottom: 20px;
    transition: var(--transition);
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: var(--primary);
    background: rgba(108, 99, 255, 0.05);
}

.file-upload-area.drag-over {
    border-color: var(--primary);
    background: rgba(108, 99, 255, 0.1);
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Page d'accueil -->
        <div id="home-page" class="page active">
            <div class="card glass">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                    <h1>Bonjour, <span id="user-name">√âl√®ve</span></h1>
                    <button class="btn btn-secondary" onclick="showFormules()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 18h2V6H7v12zM11 18h2V6h-2v12zM15 18h2V6h-2v12z"/>
                        </svg>
                        FORMULES
                    </button>
                </div>
                <div class="streak">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="#FFB74D">
                        <path d="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.967-7.417 3.967 1.481-8.279-6.064-5.828 8.332-1.151z"/>
                    </svg>
                    <span>S√©rie de r√©vision : <strong id="streak-count">0</strong> jours</span>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.8;">Chaque ligne apprise aujourd'hui allume une √©toile pour demain.</p>
            </div>

            <div id="subjects-overview">
                <!-- Les mati√®res seront ajout√©es ici dynamiquement -->
            </div>
        </div>

        <!-- Page Mati√®res -->
        <div id="subjects-page" class="page">
            <div class="card glass">
                <h2>Mati√®res</h2>
                <p style="margin-bottom: 20px; opacity: 0.8;">Organisez votre savoir, construisez votre avenir.</p>
                <button class="btn btn-primary" onclick="showAddSubjectModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Nouvelle mati√®re
                </button>
            </div>

            <div id="subjects-list" class="subject-grid">
                <!-- Les mati√®res seront ajout√©es ici dynamiquement -->
            </div>
        </div>

        <!-- Page Formules (Nouvelle) -->
        <div id="formules-page" class="page">
            <div class="card glass">
                <h2>Formules par Mati√®re</h2>
                <p style="margin-bottom: 20px; opacity: 0.8;">Ma√Ætrisez les concepts fondamentaux de chaque discipline.</p>
            </div>

            <div id="formules-list" class="subject-grid">
                <!-- Les formules par mati√®re seront ajout√©es ici dynamiquement -->
            </div>
        </div>

        <!-- Page D√©tail Mati√®re/Formules -->
        <div id="subject-detail-page" class="page">
            <div class="card glass">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                    <h2 id="subject-detail-title">Mati√®re</h2>
                    <button class="btn btn-secondary" onclick="goBack()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                        </svg>
                        Retour
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="photo">PHOTO</div>
                    <div class="tab" data-tab="video">VIDEO</div>
                    <div class="tab" data-tab="note">NOTE</div>
                    <div class="tab" data-tab="document">DOCUMENT</div>
                </div>

                <div id="categories-section">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 16px;">
                        <h4>Cat√©gories</h4>
                        <button class="btn btn-primary" onclick="showAddCategoryModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                            Cat√©gorie
                        </button>
                    </div>
                    <div id="categories-list">
                        <!-- Cat√©gories dynamiques -->
                    </div>
                </div>

                <div id="content-area">
                    <!-- Contenu dynamique par onglet et cat√©gorie -->
                </div>
            </div>
        </div>

        <!-- Page Emploi du temps -->
        <div id="timetable-page" class="page">
            <div class="card glass">
                <h2>Emploi du temps</h2>
                <p style="margin-bottom: 20px; opacity: 0.8;">Organisez votre temps, maximisez votre potentiel.</p>
                
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <button class="btn btn-primary" id="school-context-btn" onclick="switchTimetableContext('school')">
                        √Ä l'√©cole/Universit√©
                    </button>
                    <button class="btn btn-secondary" id="home-context-btn" onclick="switchTimetableContext('home')">
                        √Ä la maison
                    </button>
                </div>

                <button class="btn btn-primary" onclick="showAddTimeslotModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Nouveau cr√©neau
                </button>
            </div>

            <div id="timetable-container" class="card glass">
                <!-- Emploi du temps dynamique -->
            </div>
        </div>

        <!-- Page Biblioth√®que -->
        <div id="library-page" class="page">
            <div class="card glass">
                <h2>Biblioth√®que</h2>
                <p style="margin-bottom: 20px; opacity: 0.8;">Votre savoir en un seul endroit.</p>
                
                <input type="file" id="pdf-upload" accept=".pdf" style="display: none;" onchange="handlePdfUpload(this.files[0])">
                <button class="btn btn-primary" onclick="document.getElementById('pdf-upload').click()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Importer PDF
                </button>
            </div>

            <div id="library-list" class="subject-grid">
                <!-- Liste des PDFs dynamique -->
            </div>
        </div>

        <!-- Page Param√®tres -->
        <div id="settings-page" class="page">
            <div class="card glass">
                <h2>Param√®tres</h2>
                <p style="margin-bottom: 20px; opacity: 0.8;">Personnalisez votre exp√©rience d'apprentissage.</p>

                <div class="form-group">
                    <label class="form-label">Mode sombre</label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                        <span>Activer/d√©sactiver</span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">R√©tention corbeille (jours)</label>
                    <input type="number" id="trash-retention" class="form-input" value="30" min="1">
                </div>

                <div class="form-group">
                    <label class="form-label">Export/Import</label>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="exportData()">Exporter donn√©es</button>
                        <input type="file" id="import-file" accept=".json,.carnet" style="display: none;" onchange="importData(this.files[0])">
                        <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">Importer donn√©es</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Mode D√©veloppeur</label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="dev-mode-toggle" onchange="toggleDevMode()">
                        <span>Activer/d√©sactiver</span>
                    </label>
                </div>

                <button class="btn btn-danger" onclick="showResetModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    R√©initialiser l'application
                </button>
            </div>
          <!-- Ajoutez cette section apr√®s le bouton de r√©initialisation -->
<div class="card glass" style="margin-top: 30px;">
    <h3>üóëÔ∏è Corbeille</h3>
    <p style="margin-bottom: 20px; opacity: 0.8;">√âl√©ments supprim√©s - Retention: <span id="trash-days-display">30</span> jours</p>
    
    <div id="trash-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
        <!-- Liste des √©l√©ments supprim√©s -->
    </div>
    
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="loadTrash()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
            </svg>
            Actualiser
        </button>
        <button class="btn btn-secondary" onclick="restoreAllFromTrash()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
            </svg>
            Tout restaurer
        </button>
        <button class="btn btn-danger" onclick="emptyTrash()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
            Vider la corbeille
        </button>
    </div>
</div>
        </div>
    </div>

    <!-- Navigation inf√©rieure -->
    <div class="nav-bottom">
        <div class="nav-item active" data-page="home-page">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
            <span>Accueil</span>
        </div>
        <div class="nav-item" data-page="subjects-page">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/>
            </svg>
            <span>Mati√®res</span>
        </div>
        <div class="nav-item" data-page="timetable-page">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
            </svg>
            <span>Emploi du temps</span>
        </div>
        <div class="nav-item" data-page="library-page">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/>
            </svg>
            <span>Biblioth√®que</span>
        </div>
        <div class="nav-item" data-page="settings-page">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
            <span>Param√®tres</span>
        </div>
    </div>

    <!-- Modals -->
    <div id="onboarding-modal" class="modal active">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; text-align: center;">Bienvenue dans votre Carnet</h2>
            <p style="margin-bottom: 30px; text-align: center; opacity: 0.8;">Commencez par personnaliser votre profil</p>
            
            <div class="form-group">
                <label class="form-label">Votre nom</label>
                <input type="text" id="user-name-input" class="form-input" placeholder="Votre nom">
            </div>
            
            <div class="form-group">
                <label class="form-label">Je suis</label>
                <select id="user-status" class="form-input">
                    <option value="school">√âcolier</option>
                    <option value="student">√âtudiant</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Classe/Niveau</label>
                <input type="text" id="user-class" class="form-input" placeholder="Ex: Terminale S, Licence 2...">
            </div>
            
            <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="completeOnboarding()">
                Commencer l'aventure
            </button>
        </div>
    </div>

    <!-- Autres modals seront ajout√©s dynamiquement -->

    <script>
        // =============================================================================
        // README INTERNE - Structure et Documentation
        // =============================================================================
        /*
        CARNET DE L'√âL√àVE/√âTUDIANT - Application Web Compl√®te
        
        STRUCTURE DES STORES INDEXEDDB:
        - profile: { id: 1, name, status, class, streak, settings }
        - subjects: { id, name, color, coefficient, createdAt }
        - categories: { id, subjectId, name, type (photo/video/note/document), order }
        - items: { id, categoryId, type, title, content, fileBlob, order, createdAt }
        - grades: { id, subjectId, title, grade, coefficient, date, category }
        - timetable: { id, context (school/home), day, startTime, endTime, subjectId, room, notes, reminder }
        - library: { id, title, fileName, fileBlob, lastPage, totalPages, createdAt }
        - backups: { id, timestamp, data, hash, encrypted }
        - trash: { id, originalStore, originalData, deletedAt }
        - logs: { id, action, timestamp, details }
        
        ALGORITHMES DE CALCUL DES MOYENNES:
        - Moyenne mati√®re: Œ£(grade * coefficient) / Œ£(coefficient)
        - Moyenne g√©n√©rale: Œ£(moyenne_mati√®re * coefficient_mati√®re) / Œ£(coefficient_mati√®re)
        - Arrondi √† 2 d√©cimales, drop lowest n optionnel
        - Conversion automatique sur 20
        
        FLOW DE SUPPRESSION / CORBEILLE:
        1. Premi√®re confirmation modale "√ätes-vous s√ªr ?"
        2. Deuxi√®me confirmation avec saisie "SUPPRIMER" ou nom
        3. Soft delete: d√©placement vers trash avec deletedAt
        4. Retention: 30 jours par d√©faut (configurable)
        5. Restauration possible depuis corbeille
        
        BACKUPS & LASTPAGE:
        - Export: JSON chiffr√© (AES-GCM) ou non avec mot de passe optionnel
        - Import: Support .carnet (chiffr√©) et JSON, merge/overwrite
        - LastPage PDF: Stock√©e dans IndexedDB + localStorage + backups
        - R√©initialisation: Pr√©serve lastPage via backup si disponible
        - Si donn√©es navigateur supprim√©es manuellement: restauration impossible
        
        TRASH RETENTION DAYS:
        - Modifiable dans Settings -> trash-retention input
        - Valeur par d√©faut: 30 jours
        
        PBKDF2 ITERATIONS:
        - Valeur production: 100000
        - Pour debug: r√©duire √† 1000 dans encryptJSON/decryptJSON
        */

        // =============================================================================
        // VARIABLES GLOBALES ET INITIALISATION
        // =============================================================================
        let db = null;
        let currentSubjectId = null;
        let currentTab = 'photo';
        let currentContext = 'school';

        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
          // Dans DOMContentLoaded, apr√®s initDB()
await cleanupTrash();
            await checkOnboarding();
            setupNavigation();
            loadAllData();
        });

        // =============================================================================
        // BASE DE DONN√âES INDEXEDDB
        // =============================================================================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('StudentNotebook', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Stores principaux
                    if (!db.objectStoreNames.contains('profile')) {
                        db.createObjectStore('profile', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('subjects')) {
                        db.createObjectStore('subjects', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('categories')) {
                        db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('items')) {
                        db.createObjectStore('items', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('grades')) {
                        db.createObjectStore('grades', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('timetable')) {
                        db.createObjectStore('timetable', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('library')) {
                        db.createObjectStore('library', { keyPath: 'id', autoIncrement: true });
                    }
                    
                    // Stores syst√®me
                    if (!db.objectStoreNames.contains('backups')) {
                        db.createObjectStore('backups', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('trash')) {
                        db.createObjectStore('trash', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('logs')) {
                        db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        // =============================================================================
        // FONCTIONS UTILITAIRES POUR INDEXEDDB
        // =============================================================================
        function dbAction(storeName, action, data = null) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                let request;
                switch (action) {
                    case 'add':
                        request = store.add(data);
                        break;
                    case 'put':
                        request = store.put(data);
                        break;
                    case 'get':
                        request = store.get(data);
                        break;
                    case 'getAll':
                        request = store.getAll();
                        break;
                    case 'delete':
                        request = store.delete(data);
                        break;
                }
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // =============================================================================
        // GESTION DE L'ONBOARDING
        // =============================================================================
        async function checkOnboarding() {
            const profile = await dbAction('profile', 'get', 1);
            if (!profile) {
                showModal('onboarding-modal');
            } else {
                document.getElementById('user-name').textContent = profile.name;
                document.getElementById('streak-count').textContent = profile.streak || 0;
                
                // Appliquer les param√®tres
                if (profile.settings?.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('dark-mode-toggle').checked = true;
                }
            }
        }

        async function completeOnboarding() {
            const name = document.getElementById('user-name-input').value;
            const status = document.getElementById('user-status').value;
            const userClass = document.getElementById('user-class').value;
            
            if (!name.trim()) {
                alert('Veuillez entrer votre nom');
                return;
            }
            
            const profile = {
                id: 1,
                name: name.trim(),
                status: status,
                class: userClass.trim(),
                streak: 0,
                settings: {
                    darkMode: false,
                    trashRetentionDays: 30
                },
                createdAt: new Date()
            };
            
            await dbAction('profile', 'put', profile);
            document.getElementById('user-name').textContent = profile.name;
            hideModal('onboarding-modal');
            loadAllData();
        }

        // =============================================================================
        // NAVIGATION ET UI
        // =============================================================================
        function setupNavigation() {
            // Navigation principale
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    // Mettre √† jour l'√©tat actif
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Afficher la page correspondante
                    const pageId = this.getAttribute('data-page');
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                });
            });

            // Gestion des onglets dans le d√©tail mati√®re
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('tab')) {
                    const tabs = e.target.parentElement.querySelectorAll('.tab');
                    tabs.forEach(tab => tab.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    currentTab = e.target.getAttribute('data-tab');
                    loadSubjectDetailContent();
                }
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${pageId}"]`).classList.add('active');
        }

        function goBack() {
            showPage('subjects-page');
        }

        function showFormules() {
            loadFormulesPage();
            showPage('formules-page');
        }

        // =============================================================================
        // GESTION DES MATI√àRES
        // =============================================================================
        async function loadAllData() {
            await loadHomePage();
            await loadSubjectsPage();
            await loadTimetablePage();
            await loadLibraryPage();
        }

        async function loadHomePage() {
            const subjects = await dbAction('subjects', 'getAll');
            const grades = await dbAction('grades', 'getAll');
            
            const container = document.getElementById('subjects-overview');
            container.innerHTML = '';
            
            subjects.forEach(subject => {
                const subjectGrades = grades.filter(g => g.subjectId === subject.id);
                const average = calculateSubjectAverage(subjectGrades);
                
                const card = document.createElement('div');
                card.className = 'card subject-card glass';
                card.innerHTML = `
                    <div class="subject-color" style="background: ${subject.color || '#6C63FF'}"></div>
                    <h3>${subject.name}</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                        <span style="font-size: 24px; font-weight: bold;">${average}</span>
                        <canvas class="sparkline" width="100" height="40"></canvas>
                    </div>
                    <p style="margin-top: 8px; opacity: 0.7; font-size: 14px;">Coefficient: ${subject.coefficient || 1}</p>
                `;
                
                card.addEventListener('click', () => openSubjectDetail(subject.id));
                container.appendChild(card);
                
                // Dessiner le sparkline
                setTimeout(() => drawSparkline(card.querySelector('.sparkline'), subjectGrades), 100);
            });
        }

        async function loadSubjectsPage() {
            const subjects = await dbAction('subjects', 'getAll');
            const container = document.getElementById('subjects-list');
            container.innerHTML = '';
            
            subjects.forEach(subject => {
                const card = document.createElement('div');
                card.className = 'card subject-card glass ripple';
                card.innerHTML = `
                    <div class="subject-color" style="background: ${subject.color || '#6C63FF'}"></div>
                    <h3>${subject.name}</h3>
                    <p style="margin: 12px 0; opacity: 0.7;">${subject.description || 'Aucune description'}</p>
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        <button class="btn btn-primary" onclick="openSubjectDetail(${subject.id})">Ouvrir</button>
                        <button class="btn btn-danger" onclick="deleteSubject(${subject.id})">Supprimer</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function showAddSubjectModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Nouvelle mati√®re</h3>
                    <div class="form-group">
                        <label class="form-label">Nom de la mati√®re</label>
                        <input type="text" id="subject-name" class="form-input" placeholder="Math√©matiques, Physique...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Couleur</label>
                        <input type="color" id="subject-color" class="form-input" value="#6C63FF">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Coefficient</label>
                        <input type="number" id="subject-coefficient" class="form-input" value="1" min="1" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="subject-description" class="form-input" placeholder="Description de la mati√®re..."></textarea>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="addSubject()">Cr√©er</button>
                        <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))">Annuler</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addSubject() {
            const name = document.getElementById('subject-name').value;
            const color = document.getElementById('subject-color').value;
            const coefficient = parseFloat(document.getElementById('subject-coefficient').value);
            const description = document.getElementById('subject-description').value;
            
            if (!name.trim()) {
                alert('Veuillez entrer un nom pour la mati√®re');
                return;
            }
            
            const subject = {
                name: name.trim(),
                color: color,
                coefficient: coefficient,
                description: description.trim(),
                createdAt: new Date()
            };
            
            await dbAction('subjects', 'add', subject);
            hideModal(document.querySelector('.modal.active'));
            loadAllData();
        }

        // =============================================================================
        // PAGE FORMULES
        // =============================================================================
        async function loadFormulesPage() {
            const subjects = await dbAction('subjects', 'getAll');
            const container = document.getElementById('formules-list');
            container.innerHTML = '';
            
            subjects.forEach(subject => {
                const card = document.createElement('div');
                card.className = 'card subject-card glass ripple';
                card.innerHTML = `
                    <div class="subject-color" style="background: ${subject.color || '#6C63FF'}"></div>
                    <h3>${subject.name}</h3>
                    <p style="margin: 12px 0; opacity: 0.7;">Formules et concepts cl√©s</p>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="openFormulesDetail(${subject.id})">
                        Voir les formules
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function openFormulesDetail(subjectId) {
            currentSubjectId = subjectId;
            document.getElementById('subject-detail-title').textContent = 'Formules - ' + getSubjectName(subjectId);
            showPage('subject-detail-page');
            loadSubjectDetailContent();
        }

        // =============================================================================
        // D√âTAIL MATI√àRE/FORMULES
        // =============================================================================
        async function openSubjectDetail(subjectId) {
            currentSubjectId = subjectId;
            document.getElementById('subject-detail-title').textContent = getSubjectName(subjectId);
            showPage('subject-detail-page');
            loadSubjectDetailContent();
        }

        async function loadSubjectDetailContent() {
            await loadCategories();
            await loadCategoryContent();
        }

       async function loadCategories() {
    const categories = await dbAction('categories', 'getAll');
    const subjectCategories = categories.filter(c => 
        c.subjectId === currentSubjectId && 
        c.type === currentTab &&
        c.name !== "SANS TITRE" // Exclure la cat√©gorie par d√©faut
    );
    
    const container = document.getElementById('categories-list');
    container.innerHTML = '';
    
    if (subjectCategories.length === 0) {
        container.innerHTML = '<p style="opacity: 0.7; font-style: italic;">Aucune cat√©gorie personnalis√©e</p>';
        return;
    }
    
    subjectCategories.forEach(category => {
        const badge = document.createElement('span');
        badge.className = 'category-badge';
        badge.innerHTML = `
            ${category.name}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" onclick="deleteCategory(${category.id})" style="cursor: pointer;">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
        `;
        container.appendChild(badge);
    });
}

        function showAddCategoryModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Nouvelle cat√©gorie</h3>
                    <div class="form-group">
                        <label class="form-label">Nom de la cat√©gorie</label>
                        <input type="text" id="category-name" class="form-input" placeholder="Fiches, Exercices, Cours...">
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="addCategory()">Cr√©er</button>
                        <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))">Annuler</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addCategory() {
            const name = document.getElementById('category-name').value;
            
            if (!name.trim()) {
                alert('Veuillez entrer un nom pour la cat√©gorie');
                return;
            }
            
            const category = {
                subjectId: currentSubjectId,
                name: name.trim(),
                type: currentTab,
                order: 0,
                createdAt: new Date()
            };
            
            await dbAction('categories', 'add', category);
            hideModal(document.querySelector('.modal.active'));
            loadCategories();
        }

     async function loadCategoryContent() {
    const categories = await dbAction('categories', 'getAll');
    let subjectCategories = categories.filter(c => c.subjectId === currentSubjectId && c.type === currentTab);
    
    // Si aucune cat√©gorie n'existe, cr√©er automatiquement "SANS TITRE"
    if (subjectCategories.length === 0) {
        const defaultCategory = {
            subjectId: currentSubjectId,
            name: "SANS TITRE",
            type: currentTab,
            order: 0,
            createdAt: new Date()
        };
        await dbAction('categories', 'add', defaultCategory);
        subjectCategories = [defaultCategory];
    }
    
    const items = await dbAction('items', 'getAll');
    
    const container = document.getElementById('content-area');
    
    let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4>Contenu ${currentTab.toUpperCase()}</h4>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="showAddContentModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Ajouter
                </button>
                <button class="btn btn-secondary" onclick="showAddCategoryModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Nouvelle Cat√©gorie
                </button>
            </div>
        </div>
    `;
    
    subjectCategories.forEach(category => {
        const categoryItems = items.filter(item => item.categoryId === category.id)
                                  .sort((a, b) => a.order - b.order);
        
        html += `
            <div class="card" style="margin-bottom: 20px;">
                <h5 style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                    ${category.name}
                    ${category.name !== "SANS TITRE" ? `
                        <span style="display: flex; gap: 8px;">
                            <span class="badge">${categoryItems.length} √©l√©ment(s)</span>
                            <button class="btn btn-danger" onclick="deleteCategory(${category.id})" style="padding: 4px 8px; font-size: 12px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        </span>
                    ` : `<span class="badge">${categoryItems.length} √©l√©ment(s)</span>`}
                </h5>
                <div id="category-${category.id}-content">
                    ${renderCategoryItems(categoryItems)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderCategoryItems(items) {
    if (items.length === 0) {
        return '<p style="text-align: center; opacity: 0.7; padding: 20px;">Aucun contenu dans cette cat√©gorie</p>';
    }
    
    let html = '<div style="display: grid; gap: 12px;">';
    
    items.forEach(item => {
        html += `
            <div class="card" style="padding: 16px; display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <h6 style="margin-bottom: 8px;">${item.title}</h6>
                    ${renderItemContent(item)}
                </div>
                <div style="display: flex; gap: 8px; margin-left: 12px;">
                    <button class="btn btn-secondary" onclick="moveItemUp(${item.id})" style="padding: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 14l5-5 5 5z"/>
                        </svg>
                    </button>
                    <button class="btn btn-secondary" onclick="moveItemDown(${item.id})" style="padding: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 10l5 5 5-5z"/>
                        </svg>
                    </button>
                    <button class="btn btn-danger" onclick="deleteContentItem(${item.id})" style="padding: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

function renderItemContent(item) {
    switch(item.type) {
        case 'note':
            return `<p style="opacity: 0.8; font-size: 14px;">${item.content.substring(0, 100)}${item.content.length > 100 ? '...' : ''}</p>`;
        
        case 'photo':
            if (item.fileBlob) {
                const blob = new Blob([item.fileBlob], { type: item.fileType });
                const url = URL.createObjectURL(blob);
                return `
                    <div style="margin-top: 8px;">
                        <img src="${url}" style="max-width: 100px; max-height: 80px; border-radius: 8px; cursor: pointer;" 
                             onclick="openFullscreenImage('${url}')" alt="${item.title}">
                        <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">${formatFileSize(item.fileSize)}</div>
                    </div>
                `;
            }
            break;
            
        case 'video':
            if (item.fileBlob) {
                const blob = new Blob([item.fileBlob], { type: item.fileType });
                const url = URL.createObjectURL(blob);
                return `
                    <div style="margin-top: 8px;">
                        <video src="${url}" style="max-width: 100px; max-height: 80px; border-radius: 8px; cursor: pointer;" 
                               controls onclick="openFullscreenVideo('${url}')"></video>
                        <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">${formatFileSize(item.fileSize)}</div>
                    </div>
                `;
            }
            break;
            
        case 'document':
            return `
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                    <span style="font-size: 24px;">üìÑ</span>
                    <div>
                        <div style="font-weight: 500;">${item.fileName}</div>
                        <div style="font-size: 11px; opacity: 0.7;">${formatFileSize(item.fileSize)}</div>
                    </div>
                </div>
            `;
    }
    
    return '';
}

function formatFileSize(bytes) {
    if (!bytes) return '';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}
      
function openFullscreenImage(url) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; display: flex; align-items: center; justify-content: center;">
            <img src="${url}" style="max-width: 100%; max-height: 100%; border-radius: 12px;">
            <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))" 
                    style="position: absolute; top: 20px; right: 20px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

function openFullscreenVideo(url) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; display: flex; align-items: center; justify-content: center;">
            <video src="${url}" controls autoplay style="max-width: 100%; max-height: 100%; border-radius: 12px;"></video>
            <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))" 
                    style="position: absolute; top: 20px; right: 20px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

async function moveItemUp(itemId) {
    const items = await dbAction('items', 'getAll');
    const item = items.find(i => i.id === itemId);
    const categoryItems = items.filter(i => i.categoryId === item.categoryId)
                              .sort((a, b) => a.order - b.order);
    
    const currentIndex = categoryItems.findIndex(i => i.id === itemId);
    if (currentIndex > 0) {
        // √âchanger avec l'√©l√©ment pr√©c√©dent
        const tempOrder = categoryItems[currentIndex].order;
        categoryItems[currentIndex].order = categoryItems[currentIndex - 1].order;
        categoryItems[currentIndex - 1].order = tempOrder;
        
        await dbAction('items', 'put', categoryItems[currentIndex]);
        await dbAction('items', 'put', categoryItems[currentIndex - 1]);
        
        loadCategoryContent();
    }
}

async function moveItemDown(itemId) {
    const items = await dbAction('items', 'getAll');
    const item = items.find(i => i.id === itemId);
    const categoryItems = items.filter(i => i.categoryId === item.categoryId)
                              .sort((a, b) => a.order - b.order);
    
    const currentIndex = categoryItems.findIndex(i => i.id === itemId);
    if (currentIndex < categoryItems.length - 1) {
        // √âchanger avec l'√©l√©ment suivant
        const tempOrder = categoryItems[currentIndex].order;
        categoryItems[currentIndex].order = categoryItems[currentIndex + 1].order;
        categoryItems[currentIndex + 1].order = tempOrder;
        
        await dbAction('items', 'put', categoryItems[currentIndex]);
        await dbAction('items', 'put', categoryItems[currentIndex + 1]);
        
        loadCategoryContent();
    }
}

async function deleteContentItem(itemId) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©l√©ment ?')) {
        const confirmation = prompt('Tapez "SUPPRIMER" pour confirmer :');
        if (confirmation === 'SUPPRIMER') {
            // Soft delete - d√©placer vers la corbeille
            const item = await dbAction('items', 'get', itemId);
            const trashItem = {
                originalStore: 'items',
                originalData: item,
                deletedAt: new Date()
            };
            
            await dbAction('trash', 'add', trashItem);
            await dbAction('items', 'delete', itemId);
            
            loadCategoryContent();
            showNotification('√âl√©ment d√©plac√© vers la corbeille');
        }
    }
}

function showNotification(message) {
    // Cr√©er une notification toast
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
        // =============================================================================
        // EMPLOI DU TEMPS
        // =============================================================================
       async function loadTimetablePage() {
    const timetable = await dbAction('timetable', 'getAll');
    const subjects = await dbAction('subjects', 'getAll');
    const contextTimetable = timetable.filter(t => t.context === currentContext);
    
    const container = document.getElementById('timetable-container');
    
    if (contextTimetable.length === 0) {
        container.innerHTML = `
            <div class="card glass" style="text-align: center; padding: 40px;">
                <h3>Aucun cr√©neau programm√©</h3>
                <p style="margin: 16px 0; opacity: 0.7;">Commencez par ajouter votre premier cr√©neau</p>
                <button class="btn btn-primary" onclick="showAddTimeslotModal()">
                    Ajouter un cr√©neau
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3>Emploi du temps - ${currentContext === 'school' ? '√âcole/Universit√©' : 'Maison'}</h3>
            <button class="btn btn-secondary" onclick="exportTimetable()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Exporter
            </button>
        </div>
        <div class="timetable">
            <div class="timetable-header">Horaire</div>
            <div class="timetable-header">Lundi</div>
            <div class="timetable-header">Mardi</div>
            <div class="timetable-header">Mercredi</div>
            <div class="timetable-header">Jeudi</div>
            <div class="timetable-header">Vendredi</div>
            <div class="timetable-header">Samedi</div>
            <div class="timetable-header">Dimanche</div>
            
            ${generateTimetableGrid(contextTimetable, subjects)}
        </div>
    `;
}

function generateTimetableGrid(timetable, subjects) {
    let html = '';
    const timeSlots = generateTimeSlots();
    const days = [1, 2, 3, 4, 5, 6, 7];
    
    timeSlots.forEach(timeSlot => {
        const [startTime, endTime] = timeSlot.split('-');
        html += `<div class="timetable-header">${timeSlot}</div>`;
        
        days.forEach(day => {
            const slots = timetable.filter(t => 
                t.day === day && 
                t.startTime === startTime && 
                t.endTime === endTime
            );
            
            html += `<div class="timetable-cell" data-day="${day}" data-time="${timeSlot}">`;
            
            slots.forEach(slot => {
                const subject = subjects.find(s => s.id === slot.subjectId);
                const subjectName = subject ? subject.name : 'Sans mati√®re';
                const subjectColor = subject ? subject.color : '#6C63FF';
                
                html += `
                    <div class="time-slot" 
                         style="background: ${subjectColor}; cursor: pointer;"
                         onclick="editTimeslot(${slot.id})"
                         title="Cliquer pour modifier">
                        <div style="font-weight: 600; margin-bottom: 2px;">${subjectName}</div>
                        ${slot.room ? `<div style="font-size: 10px; opacity: 0.9;">${slot.room}</div>` : ''}
                        ${slot.notes ? `<div style="font-size: 9px; opacity: 0.8; margin-top: 2px;">${slot.notes}</div>` : ''}
                    </div>
                `;
            });
            
            // Ajouter un bouton pour ajouter un cr√©neau dans cette cellule
            if (slots.length === 0) {
                html += `
                    <button class="btn btn-secondary" 
                            style="width: 100%; padding: 4px; font-size: 10px; margin-top: 4px;"
                            onclick="addTimeslotToCell(${day}, '${startTime}', '${endTime}')">
                        +
                    </button>
                `;
            }
            
            html += `</div>`;
        });
    });
    
    return html;
}

function generateTimeSlots() {
    const slots = [];
    for (let hour = 8; hour <= 20; hour++) {
        for (let minute of ['00', '30']) {
            const startTime = `${hour.toString().padStart(2, '0')}:${minute}`;
            let endHour = hour;
            let endMinute = minute === '00' ? '30' : '00';
            
            if (minute === '30') {
                endHour = hour + 1;
                endMinute = '00';
            }
            
            const endTime = `${endHour.toString().padStart(2, '0')}:${endMinute}`;
            slots.push(`${startTime}-${endTime}`);
        }
    }
    return slots;
}

function addTimeslotToCell(day, startTime, endTime) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Nouveau cr√©neau</h3>
            
            <div class="form-group">
                <label class="form-label">Jour: ${getDayName(day)}</label>
            </div>
            
            <div class="form-group">
                <label class="form-label">Horaire: ${startTime} - ${endTime}</label>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mati√®re</label>
                <select id="cell-timeslot-subject" class="form-input">
                    <option value="">S√©lectionner une mati√®re</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Salle/Lieu</label>
                <input type="text" id="cell-timeslot-room" class="form-input" placeholder="Ex: Salle 201, Maison...">
            </div>
            
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea id="cell-timeslot-notes" class="form-input" placeholder="Notes suppl√©mentaires..." rows="2"></textarea>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveCellTimeslot(${day}, '${startTime}', '${endTime}')">
                    Cr√©er
                </button>
                <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))">Annuler</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Charger les mati√®res
    loadSubjectsForCellTimeslot();
}

function getDayName(dayNumber) {
    const days = ['', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
    return days[dayNumber];
}

async function loadSubjectsForCellTimeslot() {
    const subjects = await dbAction('subjects', 'getAll');
    const select = document.getElementById('cell-timeslot-subject');
    
    subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.id;
        option.textContent = subject.name;
        select.appendChild(option);
    });
}

async function saveCellTimeslot(day, startTime, endTime) {
    const subjectId = document.getElementById('cell-timeslot-subject').value;
    const room = document.getElementById('cell-timeslot-room').value;
    const notes = document.getElementById('cell-timeslot-notes').value;
    
    if (!subjectId) {
        alert('Veuillez s√©lectionner une mati√®re');
        return;
    }
    
    const timeslot = {
        context: currentContext,
        day: day,
        startTime: startTime,
        endTime: endTime,
        subjectId: parseInt(subjectId),
        room: room.trim(),
        notes: notes.trim(),
        createdAt: new Date()
    };
    
    await dbAction('timetable', 'add', timeslot);
    hideModal(document.querySelector('.modal.active'));
    loadTimetablePage();
    showNotification('Cr√©neau ajout√© avec succ√®s');
}

function exportTimetable() {
    // Fonction d'export simplifi√©e
    alert('Fonction d\'export √† impl√©menter');
}

        function generateTimeSlots(timetable) {
            let html = '';
            const timeSlots = ['08:00-09:00', '09:00-10:00', '10:00-11:00', '11:00-12:00', '12:00-13:00', 
                              '13:00-14:00', '14:00-15:00', '15:00-16:00', '16:00-17:00', '17:00-18:00'];
            
            timeSlots.forEach(timeSlot => {
                html += `<div class="timetable-header">${timeSlot}</div>`;
                
                for (let day = 1; day <= 7; day++) {
                    const slots = timetable.filter(t => t.day === day && t.startTime === timeSlot.split('-')[0]);
                    html += `<div class="timetable-cell">`;
                    slots.forEach(slot => {
                        html += `<div class="time-slot">${getSubjectName(slot.subjectId)}</div>`;
                    });
                    html += `</div>`;
                }
            });
            
            return html;
        }

       function switchTimetableContext(context) {
    currentContext = context;
    document.getElementById('school-context-btn').classList.toggle('btn-primary', context === 'school');
    document.getElementById('school-context-btn').classList.toggle('btn-secondary', context !== 'school');
    document.getElementById('home-context-btn').classList.toggle('btn-primary', context === 'home');
    document.getElementById('home-context-btn').classList.toggle('btn-secondary', context !== 'home');
    
    // Demander la permission pour les notifications au premier changement
    if (Notification.permission === 'default') {
        requestNotificationPermission();
    }
    
    loadTimetablePage();
}

        // =============================================================================
        // BIBLIOTH√àQUE PDF
        // =============================================================================
        async function loadLibraryPage() {
            const library = await dbAction('library', 'getAll');
            const container = document.getElementById('library-list');
            container.innerHTML = '';
            
            library.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card glass';
                card.innerHTML = `
                    <h3>${item.title}</h3>
                    <p style="margin: 12px 0; opacity: 0.7;">Derni√®re page: ${item.lastPage || 1}</p>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="openPdf(${item.id})">Lire</button>
                        <button class="btn btn-danger" onclick="deletePdf(${item.id})">Supprimer</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function handlePdfUpload(file) {
            if (!file || file.type !== 'application/pdf') {
                alert('Veuillez s√©lectionner un fichier PDF valide');
                return;
            }
            
            const arrayBuffer = await file.arrayBuffer();
            const pdf = {
                title: file.name.replace('.pdf', ''),
                fileName: file.name,
                fileBlob: arrayBuffer,
                lastPage: 1,
                totalPages: 0,
                createdAt: new Date()
            };
            
            await dbAction('library', 'add', pdf);
            loadLibraryPage();
        }

        // =============================================================================
        // CALCULS ET STATISTIQUES
        // =============================================================================
        function calculateSubjectAverage(grades) {
            if (!grades.length) return '--';
            
            const total = grades.reduce((sum, grade) => sum + (grade.grade * grade.coefficient), 0);
            const totalCoefficient = grades.reduce((sum, grade) => sum + grade.coefficient, 0);
            
            return (total / totalCoefficient).toFixed(2);
        }

        function drawSparkline(canvas, grades) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            if (!grades.length) {
                ctx.fillStyle = '#ccc';
                ctx.fillRect(0, height/2, width, 1);
                return;
            }
            
            const gradesValues = grades.map(g => g.grade).slice(-10); // Derni√®res 10 notes
            const maxGrade = Math.max(...gradesValues);
            const minGrade = Math.min(...gradesValues);
            const range = maxGrade - minGrade || 1;
            
            ctx.clearRect(0, 0, width, height);
            ctx.beginPath();
            
            gradesValues.forEach((grade, index) => {
                const x = (index / (gradesValues.length - 1)) * width;
                const y = height - ((grade - minGrade) / range) * height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.strokeStyle = '#6C63FF';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // =============================================================================
        // FONCTIONS UTILITAIRES
        // =============================================================================
        function getSubjectName(subjectId) {
            // Impl√©mentation simplifi√©e - en r√©alit√© il faudrait r√©cup√©rer depuis la DB
            return `Mati√®re ${subjectId}`;
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalElement) {
            if (typeof modalElement === 'string') {
                document.getElementById(modalElement).classList.remove('active');
            } else {
                modalElement.classList.remove('active');
                if (modalElement.parentElement) {
                    modalElement.parentElement.removeChild(modalElement);
                }
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            // Sauvegarder le pr√©f√©rence
        }

        // =============================================================================
        // FONCTIONS STUB POUR LES FONCTIONNALIT√âS MANQUANTES
        // =============================================================================
        function deleteSubject(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette mati√®re ?')) {
                const confirmation = prompt('Tapez "SUPPRIMER" pour confirmer:');
                if (confirmation === 'SUPPRIMER') {
                    // Impl√©menter la suppression
                    console.log('Suppression mati√®re:', id);
                }
            }
        }

       async function deleteCategory(categoryId) {
    if (!confirm('Supprimer cette cat√©gorie ? Les √©l√©ments seront d√©plac√©s vers "SANS TITRE".')) return;
    
    const confirmation = prompt('Tapez "SUPPRIMER" pour confirmer :');
    if (confirmation !== 'SUPPRIMER') return;
    
    try {
        // R√©cup√©rer la cat√©gorie √† supprimer
        const categoryToDelete = await dbAction('categories', 'get', categoryId);
        
        // R√©cup√©rer ou cr√©er la cat√©gorie "SANS TITRE"
        const categories = await dbAction('categories', 'getAll');
        let defaultCategory = categories.find(c => 
            c.subjectId === currentSubjectId && 
            c.type === currentTab && 
            c.name === "SANS TITRE"
        );
        
        if (!defaultCategory) {
            defaultCategory = {
                subjectId: currentSubjectId,
                name: "SANS TITRE",
                type: currentTab,
                order: 0,
                createdAt: new Date()
            };
            const newCategoryId = await dbAction('categories', 'add', defaultCategory);
            defaultCategory.id = newCategoryId;
        }
        
        // Transf√©rer tous les √©l√©ments vers "SANS TITRE"
        const items = await dbAction('items', 'getAll');
        const itemsToTransfer = items.filter(item => item.categoryId === categoryId);
        
        for (const item of itemsToTransfer) {
            item.categoryId = defaultCategory.id;
            await dbAction('items', 'put', item);
        }
        
        // Supprimer la cat√©gorie
        await dbAction('categories', 'delete', categoryId);
        
        showNotification(`Cat√©gorie supprim√©e - ${itemsToTransfer.length} √©l√©ments d√©plac√©s vers "SANS TITRE"`);
        loadCategories();
        loadCategoryContent();
        
    } catch (error) {
        console.error('Erreur suppression cat√©gorie:', error);
        alert('Erreur lors de la suppression de la cat√©gorie');
    }
}

      // Fonction utilitaire pour am√©liorer l'upload
function setupFileUpload() {
    // Permettre le drag & drop
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.backgroundColor = 'rgba(108, 99, 255, 0.1)';
        });
        
        contentArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.backgroundColor = '';
        });
        
        contentArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.backgroundColor = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleDroppedFiles(files);
            }
        });
    }
}

async function handleDroppedFiles(files) {
    for (const file of files) {
        // D√©terminer le type en fonction de l'extension
        let fileType = 'document';
        if (file.type.startsWith('image/')) fileType = 'photo';
        if (file.type.startsWith('video/')) fileType = 'video';
        if (file.type === 'application/pdf') fileType = 'document';
        
        // Changer d'onglet si n√©cessaire
        if (fileType !== currentTab) {
            currentTab = fileType;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${fileType}"]`).classList.add('active');
        }
        
        // R√©cup√©rer ou cr√©er la cat√©gorie "SANS TITRE"
        const categories = await dbAction('categories', 'getAll');
        let defaultCategory = categories.find(c => 
            c.subjectId === currentSubjectId && 
            c.type === currentTab && 
            c.name === "SANS TITRE"
        );
        
        if (!defaultCategory) {
            defaultCategory = {
                subjectId: currentSubjectId,
                name: "SANS TITRE",
                type: currentTab,
                order: 0,
                createdAt: new Date()
            };
            const categoryId = await dbAction('categories', 'add', defaultCategory);
            defaultCategory.id = categoryId;
        }
        
        // Cr√©er l'√©l√©ment
        const contentItem = {
            categoryId: defaultCategory.id,
            type: currentTab,
            title: file.name.replace(/\.[^/.]+$/, ""), // Enlever l'extension
            fileBlob: await file.arrayBuffer(),
            fileName: file.name,
            fileType: file.type,
            fileSize: file.size,
            order: 0,
            createdAt: new Date()
        };
        
        await dbAction('items', 'add', contentItem);
    }
    
    showNotification(`${files.length} fichier(s) ajout√©(s) avec succ√®s`);
    loadCategoryContent();
}
      
    function showAddContentModal() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Ajouter du contenu - ${currentTab.toUpperCase()}</h3>
            <div class="form-group">
                <label class="form-label">Titre</label>
                <input type="text" id="content-title" class="form-input" placeholder="Titre du contenu">
            </div>
            
            ${getContentFieldsByType()}
            
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="addContentItem()">Ajouter</button>
                <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))">Annuler</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Plus besoin de charger les cat√©gories, on utilisera automatiquement "SANS TITRE"
}

function getContentFieldsByType() {
    switch(currentTab) {
        case 'photo':
            return `
                <div class="form-group">
                    <label class="form-label">Image</label>
                    <input type="file" id="content-file" class="form-input" accept="image/*" onchange="previewImage(this)">
                    <div id="image-preview" style="margin-top: 10px;"></div>
                </div>
            `;
        case 'video':
            return `
                <div class="form-group">
                    <label class="form-label">Vid√©o</label>
                    <input type="file" id="content-file" class="form-input" accept="video/*" onchange="previewVideo(this)">
                    <div id="video-preview" style="margin-top: 10px;"></div>
                </div>
            `;
        case 'document':
            return `
                <div class="form-group">
                    <label class="form-label">Document PDF</label>
                    <input type="file" id="content-file" class="form-input" accept=".pdf">
                </div>
            `;
        case 'note':
            return `
                <div class="form-group">
                    <label class="form-label">Contenu de la note</label>
                    <textarea id="content-text" class="form-input" placeholder="√âcrivez votre note..." rows="6"></textarea>
                </div>
            `;
        default:
            return '';
    }
}

async function loadCategoriesForModal() {
    const categories = await dbAction('categories', 'getAll');
    const subjectCategories = categories.filter(c => c.subjectId === currentSubjectId && c.type === currentTab);
    const select = document.getElementById('content-category');
    
    subjectCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        select.appendChild(option);
    });
}
      
async function addContentItem() {
    const title = document.getElementById('content-title').value;
    
    if (!title.trim()) {
        alert('Veuillez entrer un titre');
        return;
    }
    
    // R√©cup√©rer ou cr√©er la cat√©gorie "SANS TITRE"
    const categories = await dbAction('categories', 'getAll');
    let defaultCategory = categories.find(c => 
        c.subjectId === currentSubjectId && 
        c.type === currentTab && 
        c.name === "SANS TITRE"
    );
    
    // Si la cat√©gorie n'existe pas, la cr√©er
    if (!defaultCategory) {
        defaultCategory = {
            subjectId: currentSubjectId,
            name: "SANS TITRE",
            type: currentTab,
            order: 0,
            createdAt: new Date()
        };
        const categoryId = await dbAction('categories', 'add', defaultCategory);
        defaultCategory.id = categoryId;
    }
    
    const contentItem = {
        categoryId: defaultCategory.id,
        type: currentTab,
        title: title.trim(),
        content: '',
        fileBlob: null,
        order: 0,
        createdAt: new Date()
    };
    
    // Gestion sp√©cifique selon le type
    switch(currentTab) {
        case 'note':
            const noteContent = document.getElementById('content-text').value;
            if (!noteContent.trim()) {
                alert('Veuillez √©crire le contenu de la note');
                return;
            }
            contentItem.content = noteContent.trim();
            break;
            
        case 'photo':
        case 'video':
        case 'document':
            const fileInput = document.getElementById('content-file');
            if (!fileInput.files[0]) {
                alert(`Veuillez s√©lectionner un fichier ${currentTab}`);
                return;
            }
            
            const arrayBuffer = await fileInput.files[0].arrayBuffer();
            contentItem.fileBlob = arrayBuffer;
            contentItem.fileName = fileInput.files[0].name;
            contentItem.fileType = fileInput.files[0].type;
            contentItem.fileSize = fileInput.files[0].size;
            break;
    }
    
    await dbAction('items', 'add', contentItem);
    hideModal(document.querySelector('.modal.active'));
    showNotification('Contenu ajout√© avec succ√®s');
    loadCategoryContent(); // Recharger l'affichage du contenu
}
      
function previewImage(input) {
    const preview = document.getElementById('image-preview');
    preview.innerHTML = '';
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.maxWidth = '200px';
            img.style.maxHeight = '150px';
            img.style.borderRadius = '8px';
            preview.appendChild(img);
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function previewVideo(input) {
    const preview = document.getElementById('video-preview');
    preview.innerHTML = '';
    
    if (input.files && input.files[0]) {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(input.files[0]);
        video.controls = true;
        video.style.maxWidth = '200px';
        video.style.maxHeight = '150px';
        video.style.borderRadius = '8px';
        preview.appendChild(video);
    }
}

       function showAddTimeslotModal(editingSlot = null) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>${editingSlot ? 'Modifier' : 'Nouveau'} cr√©neau</h3>
            
            <div class="form-group">
                <label class="form-label">Jour</label>
                <select id="timeslot-day" class="form-input">
                    <option value="1">Lundi</option>
                    <option value="2">Mardi</option>
                    <option value="3">Mercredi</option>
                    <option value="4">Jeudi</option>
                    <option value="5">Vendredi</option>
                    <option value="6">Samedi</option>
                    <option value="7">Dimanche</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Horaire de d√©but</label>
                <select id="timeslot-start" class="form-input">
                    ${generateTimeOptions()}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Horaire de fin</label>
                <select id="timeslot-end" class="form-input">
                    ${generateTimeOptions()}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mati√®re</label>
                <select id="timeslot-subject" class="form-input">
                    <option value="">S√©lectionner une mati√®re</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Salle/Lieu</label>
                <input type="text" id="timeslot-room" class="form-input" placeholder="Ex: Salle 201, Maison...">
            </div>
            
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea id="timeslot-notes" class="form-input" placeholder="Notes suppl√©mentaires..." rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Rappel</label>
                <input type="datetime-local" id="timeslot-reminder" class="form-input">
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveTimeslot(${editingSlot ? editingSlot.id : 'null'})">
                    ${editingSlot ? 'Modifier' : 'Cr√©er'}
                </button>
                <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))">Annuler</button>
                ${editingSlot ? `
                    <button class="btn btn-danger" onclick="deleteTimeslot(${editingSlot.id})" style="margin-left: auto;">
                        Supprimer
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Charger les mati√®res
    loadSubjectsForTimeslot();
    
    // Pr√©-remplir si √©dition
    if (editingSlot) {
        document.getElementById('timeslot-day').value = editingSlot.day;
        document.getElementById('timeslot-start').value = editingSlot.startTime;
        document.getElementById('timeslot-end').value = editingSlot.endTime;
        document.getElementById('timeslot-subject').value = editingSlot.subjectId || '';
        document.getElementById('timeslot-room').value = editingSlot.room || '';
        document.getElementById('timeslot-notes').value = editingSlot.notes || '';
        
        if (editingSlot.reminder) {
            const reminderDate = new Date(editingSlot.reminder);
            document.getElementById('timeslot-reminder').value = reminderDate.toISOString().slice(0, 16);
        }
    } else {
        // D√©finir l'heure de fin par d√©faut (1h apr√®s le d√©but)
        const startSelect = document.getElementById('timeslot-start');
        const endSelect = document.getElementById('timeslot-end');
        startSelect.addEventListener('change', function() {
            const startTime = this.value;
            if (startTime) {
                const [hours, minutes] = startTime.split(':').map(Number);
                let endHours = hours + 1;
                if (endHours > 23) endHours = 23;
                const endTime = `${endHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                
                if (endSelect.querySelector(`option[value="${endTime}"]`)) {
                    endSelect.value = endTime;
                }
            }
        });
    }
}

function generateTimeOptions() {
    let options = '';
    for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
            const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            options += `<option value="${time}">${time}</option>`;
        }
    }
    return options;
}

async function loadSubjectsForTimeslot() {
    const subjects = await dbAction('subjects', 'getAll');
    const select = document.getElementById('timeslot-subject');
    
    subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.id;
        option.textContent = subject.name;
        select.appendChild(option);
    });
}
      
      async function saveTimeslot(editingId = null) {
    const day = parseInt(document.getElementById('timeslot-day').value);
    const startTime = document.getElementById('timeslot-start').value;
    const endTime = document.getElementById('timeslot-end').value;
    const subjectId = document.getElementById('timeslot-subject').value;
    const room = document.getElementById('timeslot-room').value;
    const notes = document.getElementById('timeslot-notes').value;
    const reminder = document.getElementById('timeslot-reminder').value;
    
    // Validation
    if (!day) {
        alert('Veuillez s√©lectionner un jour');
        return;
    }
    
    if (!startTime || !endTime) {
        alert('Veuillez s√©lectionner les horaires de d√©but et de fin');
        return;
    }
    
    if (startTime >= endTime) {
        alert('L\'heure de fin doit √™tre apr√®s l\'heure de d√©but');
        return;
    }
    
    // V√©rifier les conflits d'horaire
    const existingSlots = await dbAction('timetable', 'getAll');
    const contextSlots = existingSlots.filter(slot => 
        slot.context === currentContext && 
        slot.day === day &&
        slot.id !== editingId // Exclure le cr√©neau en cours d'√©dition
    );
    
    const hasConflict = contextSlots.some(slot => {
        return (startTime < slot.endTime && endTime > slot.startTime);
    });
    
    if (hasConflict) {
        if (!confirm('Ce cr√©neau chevauche un autre cr√©neau existant. Voulez-vous quand m√™me l\'enregistrer ?')) {
            return;
        }
    }
    
    const timeslot = {
        context: currentContext,
        day: day,
        startTime: startTime,
        endTime: endTime,
        subjectId: subjectId ? parseInt(subjectId) : null,
        room: room.trim(),
        notes: notes.trim(),
        reminder: reminder ? new Date(reminder) : null,
        createdAt: new Date()
    };
    
    if (editingId) {
        timeslot.id = editingId;
        await dbAction('timetable', 'put', timeslot);
        showNotification('Cr√©neau modifi√© avec succ√®s');
    } else {
        await dbAction('timetable', 'add', timeslot);
        showNotification('Cr√©neau ajout√© avec succ√®s');
    }
    
    hideModal(document.querySelector('.modal.active'));
    loadTimetablePage();
    
    // Planifier le rappel si d√©fini
    if (reminder) {
        scheduleReminder(timeslot);
    }
}

      async function deleteTimeslot(slotId) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer ce cr√©neau ?')) {
        const confirmation = prompt('Tapez "SUPPRIMER" pour confirmer :');
        if (confirmation === 'SUPPRIMER') {
            // Soft delete
            const slot = await dbAction('timetable', 'get', slotId);
            const trashItem = {
                originalStore: 'timetable',
                originalData: slot,
                deletedAt: new Date()
            };
            
            await dbAction('trash', 'add', trashItem);
            await dbAction('timetable', 'delete', slotId);
            
            hideModal(document.querySelector('.modal.active'));
            loadTimetablePage();
            showNotification('Cr√©neau supprim√©');
        }
    }
}

function editTimeslot(slotId) {
    // Cette fonction sera appel√©e quand on clique sur un cr√©neau
    dbAction('timetable', 'get', slotId).then(slot => {
        showAddTimeslotModal(slot);
    });
}

function scheduleReminder(timeslot) {
    if (!timeslot.reminder) return;
    
    const now = new Date();
    const reminderTime = new Date(timeslot.reminder);
    
    if (reminderTime > now) {
        const timeout = reminderTime.getTime() - now.getTime();
        
        setTimeout(() => {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Rappel - Carnet de l\'√©l√®ve', {
                    body: `Cr√©neau: ${getSubjectName(timeslot.subjectId)} - ${timeslot.startTime} √† ${timeslot.endTime}`,
                    icon: '/icon.png',
                    tag: `reminder-${timeslot.id}`
                });
            } else {
                alert(`üìö Rappel: ${getSubjectName(timeslot.subjectId)} de ${timeslot.startTime} √† ${timeslot.endTime}`);
            }
        }, timeout);
    }
}

// Demander la permission pour les notifications
function requestNotificationPermission() {
    if ('Notification' in window) {
        Notification.requestPermission();
    }
}
        async function openPdf(id) {
    const pdfItem = await dbAction('library', 'get', id);
    if (!pdfItem) {
        alert('PDF non trouv√©');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.zIndex = '2000';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; width: 100%; height: 100%; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--glass-border);">
                <h3>${pdfItem.title}</h3>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="btn btn-secondary" onclick="changePdfPage(${id}, -1)" id="prev-page">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                            </svg>
                        </button>
                        <span style="min-width: 80px; text-align: center;">
                            Page <span id="current-page">1</span> / <span id="total-pages">?</span>
                        </span>
                        <button class="btn btn-secondary" onclick="changePdfPage(${id}, 1)" id="next-page">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </button>
                    </div>
                    <input type="number" id="page-jump" min="1" style="width: 60px; padding: 6px; border: 1px solid var(--glass-border); border-radius: 6px;" placeholder="Page">
                    <button class="btn btn-primary" onclick="jumpToPage(${id})">Aller</button>
                    <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div style="flex: 1; display: flex; justify-content: center; align-items: center; background: #f0f0f0; border-radius: 8px; overflow: hidden;">
                <canvas id="pdf-canvas" style="max-width: 100%; max-height: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.1);"></canvas>
            </div>
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--glass-border);">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Note de marque-page</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="bookmark-note" class="form-input" placeholder="Derni√®re page : X" value="Derni√®re page : ${pdfItem.lastPage || 1}">
                        <button class="btn btn-primary" onclick="updateBookmarkNote(${id})">Sauvegarder</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Charger le PDF
    await loadPdf(pdfItem, id);
}

let currentPdf = null;
let currentPdfId = null;
let currentPage = 1;
let totalPages = 0;

async function loadPdf(pdfItem, id) {
    try {
        const blob = new Blob([pdfItem.fileBlob], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        // Charger PDF.js en ligne (sans CDN)
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = getPdfWorkerScript();
        
        const loadingTask = pdfjsLib.getDocument(url);
        currentPdf = await loadingTask.promise;
        currentPdfId = id;
        totalPages = currentPdf.numPages;
        
        document.getElementById('total-pages').textContent = totalPages;
        
        // Charger la derni√®re page lue
        const lastPage = pdfItem.lastPage || 1;
        currentPage = Math.min(Math.max(1, lastPage), totalPages);
        await renderPage(currentPage);
        
        // Mettre √† jour l'affichage
        updatePageDisplay();
        
    } catch (error) {
        console.error('Erreur chargement PDF:', error);
        alert('Erreur lors du chargement du PDF');
    }
}

function getPdfWorkerScript() {
    // Script worker PDF.js inline
    return URL.createObjectURL(new Blob([`
        importScripts('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js');
    `], { type: 'application/javascript' }));
}

async function renderPage(pageNum) {
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    
    const page = await currentPdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1.5 });
    
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    
    const renderContext = {
        canvasContext: ctx,
        viewport: viewport
    };
    
    await page.render(renderContext).promise;
    
    // Sauvegarder la page actuelle
    await saveCurrentPage();
}

async function changePdfPage(id, direction) {
    const newPage = currentPage + direction;
    if (newPage < 1 || newPage > totalPages) return;
    
    currentPage = newPage;
    await renderPage(currentPage);
    updatePageDisplay();
}

function jumpToPage(id) {
    const pageInput = document.getElementById('page-jump');
    const pageNum = parseInt(pageInput.value);
    
    if (pageNum && pageNum >= 1 && pageNum <= totalPages) {
        currentPage = pageNum;
        renderPage(currentPage);
        updatePageDisplay();
    }
    pageInput.value = '';
}

function updatePageDisplay() {
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('bookmark-note').value = `Derni√®re page : ${currentPage}`;
}

async function saveCurrentPage() {
    if (currentPdfId && currentPage) {
        // Sauvegarder dans IndexedDB
        const pdfItem = await dbAction('library', 'get', currentPdfId);
        pdfItem.lastPage = currentPage;
        await dbAction('library', 'put', pdfItem);
        
        // Sauvegarder dans localStorage en backup
        localStorage.setItem(`pdf_lastpage_${currentPdfId}`, currentPage.toString());
    }
}

async function updateBookmarkNote(id) {
    const noteInput = document.getElementById('bookmark-note');
    const pdfItem = await dbAction('library', 'get', id);
    
    pdfItem.bookmarkNote = noteInput.value;
    await dbAction('library', 'put', pdfItem);
    
    showNotification('Note sauvegard√©e');
}

        async function deletePdf(id) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce PDF ?')) return;
    
    const confirmation = prompt('Tapez "SUPPRIMER" pour confirmer la suppression :');
    if (confirmation !== 'SUPPRIMER') return;
    
    try {
        const pdfItem = await dbAction('library', 'get', id);
        
        // Soft delete vers la corbeille
        const trashItem = {
            originalStore: 'library',
            originalData: pdfItem,
            deletedAt: new Date()
        };
        
        await dbAction('trash', 'add', trashItem);
        await dbAction('library', 'delete', id);
        
        showNotification('PDF d√©plac√© vers la corbeille');
        loadLibraryPage();
        
    } catch (error) {
        console.error('Erreur suppression PDF:', error);
        alert('Erreur lors de la suppression du PDF');
    }
}
async function loadTrash() {
    const trash = await dbAction('trash', 'getAll');
    const retentionDays = parseInt(document.getElementById('trash-retention').value) || 30;
    
    document.getElementById('trash-days-display').textContent = retentionDays;
    
    const now = new Date();
    const container = document.getElementById('trash-list');
    
    if (trash.length === 0) {
        container.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">Corbeille vide</p>';
        return;
    }
    
    let html = '<div style="display: grid; gap: 12px;">';
    
    trash.forEach(item => {
        const deletedDate = new Date(item.deletedAt);
        const daysDiff = Math.floor((now - deletedDate) / (1000 * 60 * 60 * 24));
        const daysLeft = Math.max(0, retentionDays - daysDiff);
        
        const originalData = item.originalData;
        const itemType = getItemType(originalData);
        const itemName = getItemName(originalData, itemType);
        
        html += `
            <div class="card" style="padding: 16px; display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span class="badge">${itemType}</span>
                        <strong>${itemName}</strong>
                    </div>
                    <div style="font-size: 12px; opacity: 0.7;">
                        Supprim√© le: ${deletedDate.toLocaleDateString()} 
                        (Il reste ${daysLeft} jour${daysLeft > 1 ? 's' : ''})
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="restoreFromTrash(${item.id})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
                        </svg>
                        Restaurer
                    </button>
                    <button class="btn btn-danger" onclick="permanentDelete(${item.id})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function getItemType(data) {
    if (data.fileName) return 'PDF';
    if (data.type && data.categoryId) return 'Contenu';
    if (data.startTime) return 'Cr√©neau';
    if (data.coefficient !== undefined) return 'Mati√®re';
    if (data.grade !== undefined) return 'Note';
    return '√âl√©ment';
}

function getItemName(data, type) {
    switch(type) {
        case 'PDF': return data.title || data.fileName;
        case 'Contenu': return data.title || 'Sans titre';
        case 'Cr√©neau': return `${getSubjectName(data.subjectId)} - ${data.startTime}`;
        case 'Mati√®re': return data.name;
        case 'Note': return data.title || `Note: ${data.grade}`;
        default: return data.name || data.title || '√âl√©ment sans nom';
    }
}

async function restoreFromTrash(trashId) {
    const trashItem = await dbAction('trash', 'get', trashId);
    if (!trashItem) return;
    
    try {
        // Restaurer dans le store original
        await dbAction(trashItem.originalStore, 'add', trashItem.originalData);
        
        // Supprimer de la corbeille
        await dbAction('trash', 'delete', trashId);
        
        showNotification('√âl√©ment restaur√© avec succ√®s');
        loadTrash();
        
    } catch (error) {
        console.error('Erreur restauration:', error);
        alert('Erreur lors de la restauration');
    }
}

async function restoreAllFromTrash() {
    const trash = await dbAction('trash', 'getAll');
    if (trash.length === 0) return;
    
    if (!confirm(`Restaurer tous les ${trash.length} √©l√©ments de la corbeille ?`)) return;
    
    try {
        for (const item of trash) {
            await dbAction(item.originalStore, 'add', item.originalData);
            await dbAction('trash', 'delete', item.id);
        }
        
        showNotification(`Tous les √©l√©ments (${trash.length}) ont √©t√© restaur√©s`);
        loadTrash();
        
    } catch (error) {
        console.error('Erreur restauration totale:', error);
        alert('Erreur lors de la restauration');
    }
}

async function permanentDelete(trashId) {
    if (!confirm('Supprimer d√©finitivement cet √©l√©ment ? Cette action est irr√©versible.')) return;
    
    const confirmation = prompt('Tapez "SUPPRIMER D√âFINITIVEMENT" pour confirmer :');
    if (confirmation !== 'SUPPRIMER D√âFINITIVEMENT') return;
    
    await dbAction('trash', 'delete', trashId);
    showNotification('√âl√©ment supprim√© d√©finitivement');
    loadTrash();
}

async function emptyTrash() {
    const trash = await dbAction('trash', 'getAll');
    if (trash.length === 0) return;
    
    if (!confirm(`Vider d√©finitivement la corbeille (${trash.length} √©l√©ments) ? Cette action est irr√©versible.`)) return;
    
    const confirmation = prompt('Tapez "VIDER LA CORBEILLE" pour confirmer :');
    if (confirmation !== 'VIDER LA CORBEILLE') return;
    
    try {
        for (const item of trash) {
            await dbAction('trash', 'delete', item.id);
        }
        
        showNotification('Corbeille vid√©e avec succ√®s');
        loadTrash();
        
    } catch (error) {
        console.error('Erreur vidage corbeille:', error);
        alert('Erreur lors du vidage de la corbeille');
    }
}

// Nettoyage automatique de la corbeille
async function cleanupTrash() {
    const trash = await dbAction('trash', 'getAll');
    const retentionDays = parseInt(document.getElementById('trash-retention').value) || 30;
    const now = new Date();
    
    for (const item of trash) {
        const deletedDate = new Date(item.deletedAt);
        const daysDiff = Math.floor((now - deletedDate) / (1000 * 60 * 60 * 24));
        
        if (daysDiff > retentionDays) {
            await dbAction('trash', 'delete', item.id);
        }
    }
}
      async function exportData() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Exporter les donn√©es</h3>
            <div class="form-group">
                <label class="form-label">Mot de passe (optionnel)</label>
                <input type="password" id="export-password" class="form-input" placeholder="Laisser vide pour non chiffr√©">
            </div>
            <div class="form-group">
                <label class="form-label">Inclure les PDFs</label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="include-pdfs" checked>
                    <span>Inclure les fichiers PDF (taille augment√©e)</span>
                </label>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="performExport()">Exporter</button>
                <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))">Annuler</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function performExport() {
    const password = document.getElementById('export-password').value;
    const includePdfs = document.getElementById('include-pdfs').checked;
    
    try {
        // R√©cup√©rer toutes les donn√©es
        const exportData = {
            version: '1.0',
            exportDate: new Date().toISOString(),
            profile: await dbAction('profile', 'getAll'),
            subjects: await dbAction('subjects', 'getAll'),
            categories: await dbAction('categories', 'getAll'),
            items: await dbAction('items', 'getAll'),
            grades: await dbAction('grades', 'getAll'),
            timetable: await dbAction('timetable', 'getAll'),
            library: includePdfs ? await dbAction('library', 'getAll') : [],
            trash: await dbAction('trash', 'getAll')
        };
        
        let blob, filename;
        
        if (password) {
            // Export chiffr√©
            const encrypted = await encryptJSON(password, exportData);
            blob = new Blob([JSON.stringify(encrypted)], { type: 'application/octet-stream' });
            filename = `carnet_${new Date().toISOString().split('T')[0]}.carnet`;
        } else {
            // Export non chiffr√©
            blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            filename = `carnet_${new Date().toISOString().split('T')[0]}.json`;
        }
        
        // T√©l√©charger
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        hideModal(document.querySelector('.modal.active'));
        showNotification('Export termin√© avec succ√®s');
        
    } catch (error) {
        console.error('Erreur export:', error);
        alert('Erreur lors de l\'export');
    }
}

async function importData(file) {
    if (!file) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Importer les donn√©es</h3>
            <div class="form-group">
                <label class="form-label">Fichier: ${file.name}</label>
            </div>
            <div class="form-group" id="password-field" style="display: none;">
                <label class="form-label">Mot de passe</label>
                <input type="password" id="import-password" class="form-input" placeholder="Mot de passe du fichier">
            </div>
            <div class="form-group">
                <label class="form-label">Mode d'import</label>
                <select id="import-mode" class="form-input">
                    <option value="merge">Fusionner avec les donn√©es existantes</option>
                    <option value="overwrite">Remplacer toutes les donn√©es</option>
                </select>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="performImport()">Importer</button>
                <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))">Annuler</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // D√©tecter si le fichier est chiffr√©
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = JSON.parse(e.target.result);
            if (content.encrypted) {
                document.getElementById('password-field').style.display = 'block';
            }
        } catch (error) {
            // Fichier JSON normal
        }
    };
    reader.readAsText(file);
}

async function performImport() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    if (!file) return;
    
    const password = document.getElementById('import-password').value;
    const mode = document.getElementById('import-mode').value;
    
    try {
        const fileContent = await readFileAsText(file);
        let importData;
        
        if (password) {
            // D√©chiffrer
            const encryptedData = JSON.parse(fileContent);
            importData = await decryptJSON(password, encryptedData);
        } else {
            // JSON normal
            importData = JSON.parse(fileContent);
        }
        
        // Valider les donn√©es
        if (!importData.version || !importData.profile) {
            throw new Error('Format de fichier invalide');
        }
        
        if (mode === 'overwrite') {
            // Supprimer toutes les donn√©es existantes
            await clearAllData();
        }
        
        // Importer les donn√©es
        await importAllData(importData);
        
        hideModal(document.querySelector('.modal.active'));
        showNotification('Import termin√© avec succ√®s');
        
        // Recharger l'application
        setTimeout(() => {
            location.reload();
        }, 1000);
        
    } catch (error) {
        console.error('Erreur import:', error);
        alert('Erreur lors de l\'import: ' + error.message);
    }
}

function readFileAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
    });
}

async function clearAllData() {
    const stores = ['profile', 'subjects', 'categories', 'items', 'grades', 'timetable', 'library', 'trash'];
    
    for (const store of stores) {
        const items = await dbAction(store, 'getAll');
        for (const item of items) {
            await dbAction(store, 'delete', item.id);
        }
    }
}

async function importAllData(data) {
    // Importer dans chaque store
    for (const store in data) {
        if (store === 'version' || store === 'exportDate') continue;
        
        for (const item of data[store]) {
            try {
                await dbAction(store, 'add', item);
            } catch (error) {
                console.warn(`Erreur import ${store}:`, error);
            }
        }
    }
}

      // Fonctions de chiffrement
async function encryptJSON(password, data) {
    if (!password) return data;
    
    // Pour debug: r√©duire √† 1000 iterations
    const iterations = 100000; // En production
    
    const encoder = new TextEncoder();
    const dataStr = JSON.stringify(data);
    
    // G√©n√©rer une cl√© √† partir du mot de passe
    const keyMaterial = await crypto.subtle.importKey(
        'raw',
        encoder.encode(password),
        'PBKDF2',
        false,
        ['deriveKey']
    );
    
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const key = await crypto.subtle.deriveKey(
        {
            name: 'PBKDF2',
            salt: salt,
            iterations: iterations,
            hash: 'SHA-256'
        },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt']
    );
    
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encrypted = await crypto.subtle.encrypt(
        {
            name: 'AES-GCM',
            iv: iv
        },
        key,
        encoder.encode(dataStr)
    );
    
    return {
        encrypted: true,
        data: Array.from(new Uint8Array(encrypted)),
        salt: Array.from(salt),
        iv: Array.from(iv),
        iterations: iterations
    };
}

async function decryptJSON(password, payload) {
    if (!payload.encrypted) return payload;
    if (!password) throw new Error('Mot de passe requis');
    
    const encoder = new TextEncoder();
    const decoder = new TextDecoder();
    
    const keyMaterial = await crypto.subtle.importKey(
        'raw',
        encoder.encode(password),
        'PBKDF2',
        false,
        ['deriveKey']
    );
    
    const key = await crypto.subtle.deriveKey(
        {
            name: 'PBKDF2',
            salt: new Uint8Array(payload.salt),
            iterations: payload.iterations,
            hash: 'SHA-256'
        },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['decrypt']
    );
    
    const decrypted = await crypto.subtle.decrypt(
        {
            name: 'AES-GCM',
            iv: new Uint8Array(payload.iv)
        },
        key,
        new Uint8Array(payload.data)
    );
    
    return JSON.parse(decoder.decode(decrypted));
}
      
       function toggleDevMode() {
    const isDevMode = document.getElementById('dev-mode-toggle').checked;
    
    if (isDevMode) {
        // Activer le mode d√©veloppeur
        console.log('üîß Mode d√©veloppeur activ√©');
        showNotification('Mode d√©veloppeur activ√©');
        
        // Ajouter un bouton de test
        const settingsPage = document.getElementById('settings-page');
        const testButton = document.createElement('button');
        testButton.className = 'btn btn-primary';
        testButton.innerHTML = 'üß™ Lancer les tests';
        testButton.onclick = selfTest;
        testButton.style.marginTop = '10px';
        
        settingsPage.querySelector('.card.glass').appendChild(testButton);
    } else {
        showNotification('Mode d√©veloppeur d√©sactiv√©');
    }
}

        function showResetModal() {
            if (confirm('R√©initialiser toutes les donn√©es ? Cette action est irr√©versible.')) {
                const confirmation = prompt('Tapez "R√âINITIALISER" pour confirmer:');
                if (confirmation === 'R√âINITIALISER') {
                    alert('R√©initialisation - Fonctionnalit√© √† impl√©menter');
                }
            }
        }

        // =============================================================================
        // SELF-TEST POUR LE MODE D√âVELOPPEUR
        // =============================================================================
        function selfTest() {
            console.log('=== SELF-TEST MODE D√âVELOPPEUR ===');
            
            // Test de moyenne
            const testGrades = [
                { grade: 15, coefficient: 1 },
                { grade: 18, coefficient: 2 },
                { grade: 12, coefficient: 1 }
            ];
            console.log('Test moyenne:', calculateSubjectAverage(testGrades));
            
            // Test autres fonctionnalit√©s...
            console.log('=== SELF-TEST COMPL√âT√â ===');
        }
    </script>
</body>
</html>
