<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySync - Accueil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        :root {
            --primary: #6C63FF;
            --secondary: #4D44DB;
            --accent: #FF6584;
            --light: #F8F9FA;
            --dark: #343A40;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F7FB;
        }
        .greeting {
            animation: fadeIn 1s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .subject-card {
            transition: all 0.3s ease;
        }
        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .countdown {
            font-feature-settings: "tnum";
        }
        .nav-item.active {
            border-bottom: 3px solid var(--primary);
        }
        input:focus, textarea:focus, select:focus {
            outline: none !important;
            box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.2) !important;
        }
        [contenteditable]:focus {
            outline: none;
        }
        .add-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            background: #2563eb;
            color: white;
            font-size: 28px;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 999;
        }
        .exam-list {
            margin-top: 80px;
            padding: 20px;
        }
        .reminder-item {
            max-height: none !important;
            overflow: visible !important;
        }
        .reminder-details {
            white-space: normal !important;
            word-wrap: break-word !important;
            max-height: none !important;
            overflow: visible !important;
        }
        .greeting-section {
            background: linear-gradient(135deg, #6C63FF 0%, #4D44DB 100%);
        }
        .profile-image {
            transition: transform 0.3s ease;
        }
        .profile-image:hover {
            transform: scale(1.05);
        }
        .profile-avatar {
            transition: all 0.3s ease;
        }
        .profile-avatar:hover {
            transform: scale(1.05);
        }
        .trash-item {
            transition: all 0.3s ease;
        }
        .trash-item:hover {
            background-color: #F5F3FF;
        }
        [contenteditable]:focus {
            outline: none;
            background-color: #F5F3FF;
            border-radius: 4px;
        }
        .custom-alert {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i data-feather="book-open" class="text-purple-600"></i>
                <h1 class="text-xl font-bold text-gray-800">JàngTime</h1>
            </div>
            

            
            <div class="flex items-center space-x-4">
               
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center overflow-hidden flex-shrink-0">
                    <img id="headerProfileImage" src="" alt="Photo de profil" class="w-full h-full object-cover hidden">
                    <i data-feather="user" class="text-purple-600" id="headerProfileIcon"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Page Accueil -->
    <main id="home-page" class="page active flex-grow container mx-auto px-4 py-6">
        <!-- Nouveau bloc Profil et Satation -->
        <section class="mb-6 bg-white rounded-xl shadow-md p-6 text-gray-800">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <!-- Photo de profil -->
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border border-gray-300 flex-shrink-0">
                        <img id="homeProfileImage" src="" alt="Photo de profil" class="w-full h-full object-cover hidden">
                        <i data-feather="user" class="text-gray-500" id="homeProfileIcon"></i>
                    </div>
                    
                    <!-- Salutation et citation -->
                   <div class="flex-1 min-w-0">
    <div class="flex flex-wrap items-baseline gap-2">
        <h1 id="dynamicGreeting" class="text-2xl font-bold text-gray-900 whitespace-nowrap">Bonjour</h1>
        <span id="userDisplayName" class="text-2xl font-bold text-gray-900 break-words min-w-0">!</span>
    </div>
    <p id="dailyQuote" class="text-gray-600 mt-2 text-sm italic">"La connaissance est la clé du succès"</p>
</div>
                </div>
                
                <!-- Indicateur de statut -->
                <div class="text-right">
                    <div id="userStatusDisplay" class="text-sm bg-gray-100 px-3 py-1 rounded-full inline-block border border-gray-200"></div>
                </div>
            </div>
        </section>

        <!-- Date & Countdown -->
        <section class="mb-8 bg-white rounded-xl shadow-sm p-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                        <i data-feather="calendar" class="text-purple-600"></i>
                    </div>
                    <div>
                        <div class="text-gray-500">Aujourd'hui</div>
                        <div id="current-date" class="font-semibold text-lg">Lundi 12 juin 2023</div>
                        <div id="current-time" class="font-semibold text-purple-600 text-sm"></div>
                    </div>
                </div>
                
                <div id="reminder-display" class="flex-grow max-w-md px-4 cursor-pointer" onclick="openReminderPage()">
                    <div class="flex items-center justify-center p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                        <i data-feather="bell" class="text-yellow-500 mr-2"></i>
                        <span class="font-medium text-gray-700">RAPPEL</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Prochain Examen -->
        <section class="mb-8 bg-white rounded-xl shadow-sm p-6">
            <div class="flex justify-center items-center">
                <button onclick="openExamPage()" class="text-gray-500 hover:text-purple-600 transition flex flex-col items-center text-center">
                    <i data-feather="clock" class="w-6 h-6 mb-2 text-purple-600"></i>
                    <div>Prochain examen</div>
                    <div id="next-exam" class="font-bold text-purple-600 underline">Chargement...</div>
                </button>
            </div>
        </section>

        <!-- Prochaines matières -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i data-feather="clock" class="mr-2"></i> À suivre
            </h2>
            <div class="bg-white rounded-xl shadow-sm p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-medium">Prochaines matières</h3>
                    <a href="javascript:void(0)" onclick="showPage('schedule-page')" class="text-sm text-purple-600 flex items-center">
                        Voir plus <i data-feather="chevron-right" class="ml-1 w-4 h-4"></i>
                    </a>
                </div>
                <div id="next-subjects" class="space-y-3">
                    <!-- Les 2 prochaines matières seront affichées ici dynamiquement -->
                </div>
            </div>
        </section>

        <!-- Bulletin & Evolution -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Bulletin -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-feather="file-text" class="mr-2"></i> Bulletin de notes
                </h2>
                <div class="mb-4">
                    <div class="text-gray-500 mb-1">Dernier bulletin</div>
                    <div class="font-medium" id="last-bulletin-title">Aucun bulletin</div>
                    <div class="text-sm text-gray-500" id="last-bulletin-average">Moyenne: --/20</div>
                </div>
                <button onclick="openGradesPage()" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                    <i data-feather="plus" class="mr-2 w-4 h-4"></i> Nouveau bulletin
                </button>
            </div>
            
            <!-- Evolution -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-feather="trending-up" class="mr-2"></i> Évolution
                </h2>
                <div class="h-48">
                    <canvas id="evolutionChart"></canvas>
                </div>
                <div class="mt-4 text-right">
                    <a href="javascript:void(0)" onclick="openGradesPage()" class="text-purple-600 text-sm flex items-center justify-end">
                        Voir les bulletins <i data-feather="chevron-right" class="ml-1 w-4 h-4"></i>
                    </a>
                </div>
            </div>
        </section>

        <!-- Analyse des matières -->
        <section class="mb-8" id="strength-weakness-section">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i data-feather="target" class="mr-2"></i> Analyse des matières
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Points forts -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center text-green-600">
                        <i data-feather="trending-up" class="mr-2"></i> Points forts
                    </h3>
                    <div class="h-64">
                        <canvas id="strongSubjectsChart"></canvas>
                    </div>
                    <div id="no-strong-subjects" class="text-center py-8 text-gray-500">
                        <i data-feather="smile" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>Aucun point fort identifié</p>
                        <p class="text-sm">(Moyenne ≥ 10/20)</p>
                    </div>
                </div>
                
                <!-- Points faibles -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center text-red-600">
                        <i data-feather="trending-down" class="mr-2"></i> Points à améliorer
                    </h3>
                    <div class="h-64">
                        <canvas id="weakSubjectsChart"></canvas>
                    </div>
                    <div id="no-weak-subjects" class="text-center py-8 text-gray-500">
                        <i data-feather="frown" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>Aucun point faible majeur</p>
                        <p class="text-sm">(Moyenne < 10/20)</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Page Paramètres -->
    <main id="settings-page" class="page container mx-auto px-4 py-6 pb-20">
        <!-- Profile Section -->
        <section class="mb-8">
            <h2 class="text-lg font-semibold mb-4">Profil</h2>
            <div class="bg-white rounded-xl shadow-sm p-6">
                <!-- Bloc Avatar -->
                <div class="flex flex-col items-center mb-6">
                    <div class="profile-avatar w-20 h-20 rounded-full bg-purple-100 flex items-center justify-center mb-3 overflow-hidden cursor-pointer relative" onclick="document.getElementById('profileImageInput').click()">
                        <img id="profileImage" src="" alt="Photo de profil" class="w-full h-full object-cover hidden">
                        <i data-feather="user" class="text-purple-600 w-10 h-10" id="profileIcon"></i>
                        <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                            <i data-feather="camera" class="text-white w-6 h-6"></i>
                        </div>
                    </div>
                    <input type="file" id="profileImageInput" accept="image/*" class="hidden" onchange="handleProfileImage(event)">
                    <div class="text-center">
                        <h3 id="userName" class="font-medium text-gray-800 text-lg" contenteditable="true">Jean Dupont</h3>
                        <div class="flex items-center justify-center mt-1">
                            <select id="userStatus" class="text-sm text-gray-500 bg-transparent border-none focus:ring-0">
                                <option value="student">Élève</option>
                                <option value="college">Étudiant</option>
                                <option value="teacher">Professeur</option>
                            </select>
                            <i data-feather="chevron-down" class="w-4 h-4 text-gray-400 ml-1"></i>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Classe/Niveau</label>
                        <input type="text" id="userClass" placeholder="Ex: Terminale S, Licence 2" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-200 focus:border-purple-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email (optionnel)</label>
                        <input type="email" id="userEmail" placeholder="votre@email.com" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-200 focus:border-purple-400">
                    </div>
                    <div class="pt-2">
                        <button id="saveProfile" class="w-full py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Trash Section -->
        <section>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Corbeille</h2>
                <button id="emptyTrash" class="text-sm text-purple-600 flex items-center">
                    <i data-feather="trash-2" class="mr-1 w-4 h-4"></i> Vider la corbeille
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div id="trashList">
                    <!-- Trash items will be loaded here -->
                    <div class="trash-item px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <div class="font-medium">Mathématiques</div>
                            <div class="text-sm text-gray-500">Matière supprimée le 10/06/2023</div>
                        </div>
                        <button class="restore-item p-2 rounded-full hover:bg-gray-100 text-purple-600">
                            <i data-feather="refresh-ccw" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="trash-item px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <div class="font-medium">Cours Algèbre.pdf</div>
                            <div class="text-sm text-gray-500">Document supprimé le 08/06/2023</div>
                        </div>
                        <button class="restore-item p-2 rounded-full hover:bg-gray-100 text-purple-600">
                            <i data-feather="refresh-ccw" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="trash-item px-4 py-3 flex justify-between items-center">
                        <div>
                            <div class="font-medium">Photo tableau.png</div>
                            <div class="text-sm text-gray-500">Photo supprimée le 05/06/2023</div>
                        </div>
                        <button class="restore-item p-2 rounded-full hover:bg-gray-100 text-purple-600">
                            <i data-feather="refresh-ccw" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <div id="emptyTrashMessage" class="hidden text-center py-8">
                    <div class="mx-auto w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-3">
                        <i data-feather="check" class="text-gray-400 w-8 h-8"></i>
                    </div>
                    <h3 class="text-gray-700 font-medium">Corbeille vide</h3>
                    <p class="text-gray-500 text-sm mt-1">Les éléments que vous supprimez apparaîtront ici</p>
                </div>
            </div>
        </section>

        <!-- Other Settings -->
        <section class="mt-8">
            <h2 class="text-lg font-semibold mb-4">Autres paramètres</h2>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                    <div>
                        <div class="font-medium">Mode sombre</div>
                        <div class="text-sm text-gray-500">Passer à l'interface sombre</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                    </label>
                </div>
                <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                    <div>
                        <div class="font-medium">Notifications</div>
                        <div class="text-sm text-gray-500">Activer les rappels et alertes</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" checked class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                    </label>
                </div>
                <a href="javascript:void(0)" class="p-4 flex justify-between items-center text-red-600" onclick="logout()">
                    <div>
                        <div class="font-medium">Déconnexion</div>
                    </div>
                    <i data-feather="log-out" class="w-5 h-5"></i>
                </a>
            </div>
        </section>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-lg w-full max-w-sm p-6 custom-alert">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Confirmation</h2>
                    <button id="closeConfirmModal" class="text-gray-500 hover:text-gray-700">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <div class="mb-6">
                    <p id="confirmMessage">Voulez-vous vraiment vider la corbeille ? Cette action est irréversible.</p>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancelConfirm" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">Annuler</button>
                    <button id="confirmAction" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">Confirmer</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Pages supplémentaires (Examens, Rappels, Bulletin) -->
    <!-- ... (inclure ici les autres pages comme exam-page, reminder-page, grades-page) ... -->
     <!-- Page Examens -->
<div id="exam-page" class="hidden fixed inset-0 bg-white z-50 p-6 overflow-y-auto">
    <div class="flex items-center justify-between mb-6">
      <button onclick="closeExamPage()" class="text-gray-500 hover:text-purple-600">
    <i data-feather="arrow-left"></i> Retour
</button>
        <h2 class="text-xl font-semibold flex items-center">
            <i data-feather="calendar" class="mr-2"></i> Mes examens
        </h2>
        <button onclick="openExamForm()" class="bg-purple-600 text-white rounded-full p-2 hover:bg-purple-700">
            <i data-feather="plus"></i>
        </button>
    </div>

    <div id="exam-list" class="space-y-3">
        <!-- Les examens seront affichés ici -->
    </div>

    <!-- Fenêtre de formulaire -->
    <div id="exam-form" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 w-80">
            <h3 class="text-lg font-semibold mb-3">Nouvel examen</h3>
            <input id="exam-name" type="text" placeholder="Nom de l'examen" class="w-full border rounded-lg p-2 mb-2">
            <input id="exam-date" type="date" class="w-full border rounded-lg p-2 mb-2">
            <input id="exam-time" type="time" class="w-full border rounded-lg p-2 mb-4">
            <div class="flex justify-end space-x-2">
                <button onclick="closeExamForm()" class="px-3 py-1 rounded-lg border">Annuler</button>
                <button onclick="addExam()" class="px-3 py-1 bg-purple-600 text-white rounded-lg">Ajouter</button>
            </div>
        </div>
    </div>
</div>
  
  <!-- Page Rappels -->
<div id="reminder-page" class="hidden fixed inset-0 bg-white z-50 p-6 overflow-y-auto">
    <div class="flex items-center justify-between mb-6">
        <button onclick="closeReminderPage()" class="text-gray-500 hover:text-purple-600">
            <i data-feather="arrow-left"></i> Retour
        </button>
        <h2 class="text-xl font-semibold flex items-center">
            <i data-feather="bell" class="mr-2"></i> Mes rappels
        </h2>
        <button onclick="openReminderForm()" class="bg-purple-600 text-white rounded-full p-2 hover:bg-purple-700">
            <i data-feather="plus"></i>
        </button>
    </div>

    <div id="reminder-list" class="space-y-3">
        <!-- Les rappels seront afichés ici -->
    </div>

    <!-- Fenêtre de formulaire -->
    <div id="reminder-form" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-60">
        <div class="bg-white rounded-xl p-6 w-80">
            <h3 class="text-lg font-semibold mb-3">Nouveau rappel</h3>
            <input id="reminder-title" type="text" placeholder="Titre" class="w-full border rounded-lg p-2 mb-2">
            <textarea id="reminder-details" type="text" placeholder="Détails (optionnel)" class="w-full border rounded-lg p-2 mb-4 h-20"></textarea>
            <input id="reminder-date" type="date" class="w-full border rounded-lg p-2 mb-4">
            <div class="flex justify-end space-x-2">
                <button onclick="closeReminderForm()" class="px-3 py-1 rounded-lg border">Annuler</button>
                <button onclick="addReminder()" class="px-3 py-1 bg-purple-600 text-white rounded-lg">Ajouter</button>
            </div>
        </div>
    </div>
</div>

    <!-- Bottom Navigation -->
    <nav class="bg-white border-t border-gray-200 fixed bottom-0 w-full">
        <div class="container mx-auto flex justify-around">
            <a href="javascript:void(0)" onclick="showPage('home-page')" class="nav-item active flex flex-col items-center py-3 px-4 text-purple-600">
                <i data-feather="home" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Accueil</span>
            </a>
            <a href="javascript:void(0)" onclick="showPage('subjects-page')" class="nav-item flex flex-col items-center py-3 px-4 text-gray-500 hover:text-purple-600">
                <i data-feather="book" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Matières</span>
            </a>
            <a href="javascript:void(0)" onclick="showPage('library-page')" class="nav-item flex flex-col items-center py-3 px-4 text-gray-500 hover:text-purple-600">
                <i data-feather="bookmark" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Bibliothèque</span>
            </a>
            <a href="javascript:void(0)" onclick="showPage('schedule-page')" class="nav-item flex flex-col items-center py-3 px-4 text-gray-500 hover:text-purple-600">
                <i data-feather="calendar" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Emploi du temps</span>
            </a>
            <a href="javascript:void(0)" onclick="showPage('settings-page')" class="nav-item flex flex-col items-center py-3 px-4 text-gray-500 hover:text-purple-600">
                <i data-feather="settings" class="w-6 h-6"></i>
                <span class="text-xs mt-1">Paramètres</span>
            </a>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize Feather Icons
        feather.replace();

        // Navigation entre pages
        function showPage(pageId) {
            // Masquer toutes les pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Afficher la page demandée
            document.getElementById(pageId).classList.add('active');
            
            // Mettre à jour la navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active', 'text-purple-600');
                item.classList.add('text-gray-500');
            });
            
            // Activer l'élément de navigation correspondant
            const activeNav = Array.from(document.querySelectorAll('.nav-item')).find(item => {
                return item.getAttribute('onclick')?.includes(pageId);
            });
            if (activeNav) {
                activeNav.classList.add('active', 'text-purple-600');
                activeNav.classList.remove('text-gray-500');
            }
            
            // Recharger les données si nécessaire
            if (pageId === 'home-page') {
                loadUserProfile();
            } else if (pageId === 'settings-page') {
                loadSettingsData();
            }
        }

        // Fonction pour charger et afficher le profil utilisateur
        function loadUserProfile() {
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            console.log("👤 Profil utilisateur chargé:", userProfile);
            
            // Mettre à jour le nom dans la section profil principale
            const userDisplayName = document.getElementById('userDisplayName');
            if (userProfile.name && userProfile.name.trim() !== '' && userProfile.name !== 'Jean Dupont') {
                userDisplayName.textContent = userProfile.name + '!';
            } else {
                userDisplayName.textContent = '!';
            }
            
            // Mettre à jour la photo dans la section profil principale
            const homeProfileImage = document.getElementById('homeProfileImage');
            const homeProfileIcon = document.getElementById('homeProfileIcon');
            if (userProfile.profileImage) {
                homeProfileImage.src = userProfile.profileImage;
                homeProfileImage.classList.remove('hidden');
                homeProfileIcon.classList.add('hidden');
            } else {
                homeProfileImage.classList.add('hidden');
                homeProfileIcon.classList.remove('hidden');
            }
            
            // Mettre à jour la photo dans le header
            const headerProfileImage = document.getElementById('headerProfileImage');
            const headerProfileIcon = document.getElementById('headerProfileIcon');
            if (userProfile.profileImage) {
                headerProfileImage.src = userProfile.profileImage;
                headerProfileImage.classList.remove('hidden');
                headerProfileIcon.classList.add('hidden');
            } else {
                headerProfileImage.classList.add('hidden');
                headerProfileIcon.classList.remove('hidden');
            }
            
            // Mettre à jour le statut
            const userStatusDisplay = document.getElementById('userStatusDisplay');
            const statusMap = {
                'student': 'Élève',
                'college': 'Étudiant', 
                'teacher': 'Professeur'
            };
            userStatusDisplay.textContent = statusMap[userProfile.status] || 'Élève';
        }

        // Fonction pour surveiller les changements de profil
        function watchProfileChanges() {
            // Surveiller les changements dans le localStorage
            window.addEventListener('storage', function(e) {
                if (e.key === 'userProfile') {
                    console.log("🔄 Profil modifié détecté");
                    loadUserProfile();
                }
            });
            
            // Surveiller aussi les changements dans la même page
            setInterval(() => {
                const currentProfile = localStorage.getItem('userProfile');
                if (currentProfile !== window.lastProfile) {
                    window.lastProfile = currentProfile;
                    loadUserProfile();
                }
            }, 1000);
        }

        // Gestion de l'image de profil (paramètres)
        function handleProfileImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const profileImage = document.getElementById('profileImage');
                    const profileIcon = document.getElementById('profileIcon');
                    
                    profileImage.src = e.target.result;
                    profileImage.classList.remove('hidden');
                    profileIcon.classList.add('hidden');
                    
                    // Sauvegarder l'image en base64
                    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    userProfile.profileImage = e.target.result;
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                    
                    // Mettre à jour l'affichage sur la page d'accueil
                    loadUserProfile();
                    
                    // Afficher un message de succès
                    showCustomAlert('Photo de profil mise à jour!');
                };
                reader.readAsDataURL(file);
            }
        }

        // Charger les données des paramètres
        function loadSettingsData() {
            if (localStorage.getItem('userProfile')) {
                const userProfile = JSON.parse(localStorage.getItem('userProfile'));
                document.getElementById('userName').textContent = userProfile.name || 'Jean Dupont';
                document.getElementById('userStatus').value = userProfile.status || 'student';
                document.getElementById('userClass').value = userProfile.class || '';
                document.getElementById('userEmail').value = userProfile.email || '';
                
                // Charger l'image de profil
                const profileImage = document.getElementById('profileImage');
                const profileIcon = document.getElementById('profileIcon');
                if (userProfile.profileImage) {
                    profileImage.src = userProfile.profileImage;
                    profileImage.classList.remove('hidden');
                    profileIcon.classList.add('hidden');
                }
            }
        }

        // Sauvegarder le profil
        document.getElementById('saveProfile').addEventListener('click', () => {
            const userProfile = {
                name: document.getElementById('userName').textContent,
                status: document.getElementById('userStatus').value,
                class: document.getElementById('userClass').value,
                email: document.getElementById('userEmail').value
            };
            
            // Ajouter l'image si elle existe
            const profileImage = document.getElementById('profileImage');
            if (profileImage.src) {
                userProfile.profileImage = profileImage.src;
            }
            
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // Mettre à jour l'affichage sur la page d'accueil
            loadUserProfile();
            
            // Show success message
            showCustomAlert('Profil enregistré avec succès!');
        });

        // Fonction d'alerte personnalisée
        function showCustomAlert(message, type = 'success') {
            // Supprimer les alertes existantes
            const existingAlerts = document.querySelectorAll('.custom-success-alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alert = document.createElement('div');
            alert.className = `fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 custom-success-alert`;
            alert.innerHTML = `
                <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 animate-fade-in-up">
                    <i data-feather="check-circle" class="w-5 h-5"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            document.body.appendChild(alert);
            
            feather.replace();
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        // Déconnexion
        function logout() {
            if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
                localStorage.removeItem('userProfile');
                showCustomAlert('Déconnexion réussie');
                setTimeout(() => {
                    showPage('home-page');
                }, 1000);
            }
        }

        // Initialisation
        function initPage() {
            feather.replace();
            
            // ⭐⭐ CHARGEMENT DU PROFIL UTILISATEUR
            console.log("🚀 Chargement du profil utilisateur...");
            loadUserProfile();
            watchProfileChanges();
            
            // Le reste du code existant...
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('fr-FR', options);
            
            // Start real-time clock
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Dynamic greeting
            const hour = now.getHours();
            let greeting = hour < 12 ? "Bonjour" : hour < 18 ? "Bonsoir" : "Bonsoir";
            document.getElementById('greeting').textContent = greeting;
            
            // ⭐⭐ CHARGEMENT GARANTI - D'abord les données, puis les graphiques
            updateHomePageGrades(); // Charge les bulletins d'abord
            
            // Load other data
            loadNextExam();
            loadNextSubjects();
            updateRemindersDisplay();
            
            // ⭐⭐ FORCER LE CHARGEMENT DES GRAPHIQUES APRÈS UN DELAI
            setTimeout(() => {
                console.log("🎯 FORCAGE DU CHARGEMENT DES GRAPHIQUES");
                loadStrengthWeaknessCharts();
                updateEvolutionChart();
            }, 800);
            
            // Set up intervals to refresh data
            setInterval(loadNextExam, 1000);
            setInterval(loadNextSubjects, 60000);
        }

        // Initialiser la page au chargement
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
        });

        // ... (inclure ici toutes les autres fonctions existantes) ...
      function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('fr-FR', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
    });
    document.getElementById('current-time').textContent = timeString;
}
setInterval(updateCurrentTime, 1000);
updateCurrentTime();

// Load next exam from schedule
function loadNextExam() {
    const exams = JSON.parse(localStorage.getItem('exams')) || [];
    const now = new Date();
    
    // Examen en cours (+1h)
    const ongoingExam = exams.find(exam => {
        const examStart = new Date(`${exam.date}T${exam.time}`);
        const examEnd = new Date(examStart.getTime() + 60 * 60 * 1000);
        return now >= examStart && now <= examEnd;
    });
    
    const nextExamElement = document.getElementById('next-exam');
    
    if (ongoingExam) {
        nextExamElement.textContent = `${ongoingExam.name} - En cours`;
        return;
    }
    
    // Examen futur le plus proche
    const futureExams = exams
        .filter(exam => new Date(`${exam.date}T${exam.time}`) > now)
        .sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));

    if (futureExams.length > 0) {
        const nextExam = futureExams[0];
        const examDate = new Date(`${nextExam.date}T${nextExam.time}`);
        const diff = examDate - now;

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000);

        nextExamElement.innerHTML = `${nextExam.name} dans <span id="countdown-home">${days}J-${hours}H-${mins}MN-${secs}S</span>`;
    } else {
        nextExamElement.textContent = "Aucun examen prévu";
    }
}

 
// Load next  subjects
// Load next subjects from schedules - VERSION CORRIGÉE
function loadNextSubjects() {
    console.log("🔍 Chargement des prochaines matières...");
    
    const schedules = JSON.parse(localStorage.getItem('schedules')) || [];
    const otherSchedules = JSON.parse(localStorage.getItem('otherSchedules')) || [];
    
    console.log("Emplois du temps trouvés:", schedules.length);
    console.log("Autres emplois du temps:", otherSchedules.length);
    
    const now = new Date();
    const currentDay = now.toLocaleDateString('fr-FR', { weekday: 'long' });
    const currentTime = now.toTimeString().substring(0, 5);
    
    console.log("📅 Aujourd'hui:", currentDay, "Heure actuelle:", currentTime);
    
    // Tableau pour stocker toutes les matières futures
    let allFutureSubjects = [];
    
    // Fonction pour traiter un emploi du temps
    function processSchedule(schedule, isOther = false) {
        if (!schedule.data || !schedule.days || !schedule.timeSlots) {
            console.log("❌ Emploi du temps invalide:", schedule.name);
            return;
        }
        
        console.log(`📚 Analyse de l'emploi du temps: ${schedule.name}`);
        console.log("Jours:", schedule.days);
        console.log("Créneaux:", schedule.timeSlots);
        console.log("Données:", schedule.data);
        
        schedule.days.forEach(day => {
            if (schedule.data[day]) {
                Object.keys(schedule.data[day]).forEach(timeKey => {
                    const subject = schedule.data[day][timeKey];
                    
                    if (subject && subject.trim() !== '') {
                        console.log(`📖 Matière trouvée: ${subject} le ${day} à ${timeKey}`);
                        
                        // Pour les autres emplois du temps, la clé est "start-end"
                        let startTime, endTime;
                        
                        if (isOther) {
                            // Structure des autres emplois du temps: "HH:MM-HH:MM"
                            [startTime, endTime] = timeKey.split('-');
                        } else {
                            // Structure des emplois du temps principaux: timeSlot ID
                            const timeSlot = schedule.timeSlots.find(ts => ts.id === timeKey);
                            if (timeSlot) {
                                startTime = timeSlot.start;
                                endTime = timeSlot.end;
                            } else {
                                console.log("❌ Créneau horaire non trouvé pour:", timeKey);
                                return;
                            }
                        }
                        
                        if (startTime && endTime) {
                            const subjectDateTime = calculateSubjectDateTime(day, startTime, now);
                            
                            console.log(`⏰ ${subject} - ${day} ${startTime}-${endTime}`);
                            console.log("Date/heure calculée:", subjectDateTime);
                            console.log("Maintenant:", now);
                            console.log("Est future?", subjectDateTime >= now);
                            
                            if (subjectDateTime >= now) {
                                allFutureSubjects.push({
                                    subject: subject,
                                    day: day,
                                    startTime: startTime,
                                    endTime: endTime,
                                    scheduleName: schedule.name,
                                    dateTime: subjectDateTime,
                                    scheduleColor: schedule.color || 'purple'
                                });
                                console.log("✅ Ajoutée comme matière future");
                            }
                        }
                    }
                });
            }
        });
    }
    
    // Traiter tous les emplois du temps
    schedules.forEach(schedule => processSchedule(schedule, false));
    otherSchedules.forEach(schedule => processSchedule(schedule, true));
    
    console.log("📋 Matières futures trouvées:", allFutureSubjects.length);
    
    // Trier par date/heure
    allFutureSubjects.sort((a, b) => a.dateTime - b.dateTime);
    
    // Prendre les 2 prochaines
    const nextSubjects = allFutureSubjects.slice(0, 2);
    
    // Afficher les résultats
    const nextSubjectsContainer = document.getElementById('next-subjects');
    nextSubjectsContainer.innerHTML = '';
    
    if (nextSubjects.length > 0) {
        console.log("🎯 Affichage des 2 prochaines matières:", nextSubjects);
        
        nextSubjects.forEach((item, index) => {
            const timeUntil = calculateTimeUntil(item.dateTime, now);
            
            const subjectElement = document.createElement('div');
            subjectElement.className = `flex items-center p-3 ${index % 2 === 0 ? 'bg-purple-50' : 'bg-blue-50'} rounded-lg border ${index % 2 === 0 ? 'border-purple-100' : 'border-blue-100'}`;
            subjectElement.innerHTML = `
                <div class="w-10 h-10 rounded-full ${index % 2 === 0 ? 'bg-purple-100' : 'bg-blue-100'} flex items-center justify-center mr-3">
                    <i data-feather="book" class="${index % 2 === 0 ? 'text-purple-600' : 'text-blue-600'}"></i>
                </div>
                <div class="flex-1">
                    <div class="font-medium">${item.subject}</div>
                    <div class="text-sm text-gray-600">
                        ${item.day} • ${item.startTime} - ${item.endTime}
                    </div>
                    <div class="text-xs ${index % 2 === 0 ? 'text-purple-500' : 'text-blue-500'} font-medium mt-1">
                        ${timeUntil}
                    </div>
                </div>
            `;
            nextSubjectsContainer.appendChild(subjectElement);
        });
    } else {
        console.log("❌ Aucune matière future trouvée");
        nextSubjectsContainer.innerHTML = `
            <div class="text-center py-6 text-gray-500 bg-gray-50 rounded-lg">
                <i data-feather="book-open" class="w-8 h-8 mx-auto mb-2"></i>
                <p>Aucune matière à venir</p>
                <p class="text-sm mt-1">Toutes les matières sont terminées pour aujourd'hui</p>
                <button onclick="debugSchedules()" class="text-xs text-purple-600 mt-2 underline">
                    Debug
                </button>
            </div>
        `;
    }
    
    feather.replace();
}

// Fonction de debug pour voir ce qui est stocké
function debugSchedules() {
    console.log("=== DEBUG EMPLOIS DU TEMPS ===");
    const schedules = JSON.parse(localStorage.getItem('schedules')) || [];
    const otherSchedules = JSON.parse(localStorage.getItem('otherSchedules')) || [];
    
    console.log("Emplois du temps principaux:", schedules);
    console.log("Autres emplois du temps:", otherSchedules);
    
    alert("Vérifiez la console du navigateur (F12) pour voir les données détaillées");
}
      
// Fonction pour calculer la date/heure d'une matière
// Fonction pour calculer la date/heure d'une matière
function calculateSubjectDateTime(day, startTime, currentDate) {
    const daysOfWeek = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
    const targetDayIndex = daysOfWeek.indexOf(day);
    const currentDayIndex = currentDate.getDay();
    
    if (targetDayIndex === -1) {
        console.log("❌ Jour non trouvé:", day);
        return new Date(0); // Date très ancienne
    }
    
    // Calculer le nombre de jours jusqu'au jour cible
    let daysToAdd = targetDayIndex - currentDayIndex;
    if (daysToAdd < 0) {
        daysToAdd += 7; // Semaine suivante
    }
    
    // Créer la date cible
    const targetDate = new Date(currentDate);
    targetDate.setDate(currentDate.getDate() + daysToAdd);
    
    // Ajouter l'heure de début
    const [hours, minutes] = startTime.split(':');
    if (hours && minutes) {
        targetDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
    } else {
        console.log("❌ Heure invalide:", startTime);
    }
    
    return targetDate;
}

// Fonction pour calculer le temps restant
function calculateTimeUntil(targetDate, currentDate) {
    const diff = targetDate - currentDate;
    const diffMinutes = Math.floor(diff / (1000 * 60));
    const diffHours = Math.floor(diffMinutes / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffDays > 0) {
        return `Dans ${diffDays} jour${diffDays > 1 ? 's' : ''}`;
    } else if (diffHours > 0) {
        const remainingMinutes = diffMinutes % 60;
        if (remainingMinutes > 0) {
            return `Dans ${diffHours}h ${remainingMinutes}min`;
        }
        return `Dans ${diffHours} heure${diffHours > 1 ? 's' : ''}`;
    } else if (diffMinutes > 0) {
        return `Dans ${diffMinutes} minute${diffMinutes > 1 ? 's' : ''}`;
    } else {
        return 'Maintenant';
    }
}

      // Fonction utilitaire pour formater la date
function formatDate(date) {
    return date.toLocaleDateString('fr-FR', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long' 
    });
}
      
// Update reminders display
function updateRemindersDisplay() {
    const reminderDisplay = document.getElementById('reminder-display');
    
    // TOUJOURS afficher le même message, même s'il y a des rappels
    reminderDisplay.innerHTML = `
        <div class="flex items-center justify-center p-3 bg-yellow-50 rounded-lg border border-yellow-200 cursor-pointer" onclick="openReminderPage()">
            <i data-feather="bell" class="text-yellow-500 mr-2"></i>
            <span class="font-medium text-gray-700">Gérer vos rappels</span>
        </div>
    `;
    feather.replace();
}
      
      // --- PAGE DE RAPPELS --- //
function openReminderPage() {
    document.getElementById('reminder-page').classList.remove('hidden');
    document.querySelector('main').classList.add('hidden');
    document.querySelector('nav').classList.add('hidden');
    renderReminders();
    feather.replace();
    window.reminderInterval = setInterval(renderReminders, 1000);
}

function openReminderForm() {
    document.getElementById('reminder-form').classList.remove('hidden');
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('reminder-date').value = today;
}

function closeReminderForm() {
    document.getElementById('reminder-form').classList.add('hidden');
}

function addReminder() {
    const title = document.getElementById('reminder-title').value.trim();
    const details = document.getElementById('reminder-details').value.trim();
    const date = document.getElementById('reminder-date').value;
    if (!title || !date) return showCustomAlert("Titre et date obligatoires !", 'error');
    
    const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
    reminders.push({ title, details, date });
    localStorage.setItem('reminders', JSON.stringify(reminders));
    
    document.getElementById('reminder-title').value = '';
    document.getElementById('reminder-details').value = '';
    document.getElementById('reminder-date').value = '';
    
    closeReminderForm();
    renderReminders();
}

      
      function editReminder(index) {
    const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
    const reminder = reminders[index];
    document.getElementById('reminder-title').value = reminder.title;
    document.getElementById('reminder-details').value = reminder.details || '';
    document.getElementById('reminder-date').value = reminder.date;
    closeReminderForm(); // Ferme si ouvert
    openReminderForm();
    // Pour save, modifiez addReminder en update si index existe
    window.currentEditIndex = index;
}
      
function renderReminders() {
    const list = document.getElementById('reminder-list');
    const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
    list.innerHTML = '';

    if (reminders.length === 0) {
        list.innerHTML = `<div class="text-center text-gray-500">Aucun rappel ajouté</div>`;
        return;
    }

    const now = new Date();
    reminders.sort((a, b) => new Date(a.date) - new Date(b.date)); // Tri par date

    reminders.forEach((reminder, index) => {
        const remDate = new Date(reminder.date);
        const diff = remDate - now;
        let status = 'Futur';
        if (diff < 0) status = 'Passé';

        const div = document.createElement('div');
        div.className = "p-4 border rounded-lg flex justify-between items-start";
        div.innerHTML = `
            <div class="flex-1">
                <div class="font-medium">${reminder.title}</div>
                <div class="text-sm text-gray-500">${reminder.date}</div>
                ${reminder.details ? `<div class="text-sm text-gray-600 mt-1 break-words">${reminder.details}</div>` : ''}
                <div class="text-xs text-gray-400">Statut: ${status}</div>
            </div>
           <div class="flex items-center ml-4 space-x-2">
    <button onclick="editReminder(${index})" class="text-blue-500 hover:text-blue-700">
        <i data-feather="edit-3" class="w-4 h-4"></i>
    </button>
    <button onclick="deleteReminder(${index})" class="text-red-500 hover:text-red-700">
        <i data-feather="trash-2" class="w-4 h-4"></i>
    </button>
</div>
        `;
        list.appendChild(div);
    });
    feather.replace();
}

function closeReminderPage() {
    document.getElementById('reminder-page').classList.add('hidden');
    document.querySelector('main').classList.remove('hidden');
    document.querySelector('nav').classList.remove('hidden');
    if (window.reminderInterval) clearInterval(window.reminderInterval);
}

function deleteReminder(index) {
    const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
    const reminder = reminders[index];
    
    // Ajouter à la corbeille
    addToTrash({
        type: 'Rappel',
        title: reminder.title,
        description: reminder.details || `Date: ${reminder.date}`,
        data: reminder
    });
    
    // Supprimer de la liste originale
    reminders.splice(index, 1);
    localStorage.setItem('reminders', JSON.stringify(reminders));
    
    renderReminders();
}

// Initialize the new functions
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
    
    // Set current date and time
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('current-date').textContent = now.toLocaleDateString('fr-FR', options);
    
    // Start real-time clock
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    
    // Dynamic greeting
    const hour = now.getHours();
    let greeting;
    
    if (hour < 12) {
        greeting = "Bonjour";
    } else if (hour < 18) {
        greeting = "Bonsoir";
    } else {
        greeting = "Bonsoir";
    }
    
    document.getElementById('greeting').textContent = greeting;
    
    // Load data from schedule page
    loadNextExam();
    loadNextSubjects();
    updateRemindersDisplay();
    
    // === AJOUT IMPORTANT ===
    updateHomePageGrades(); // Charger les bulletins et graphique
    // =======================
    
    // Set up intervals to refresh data
    setInterval(loadNextExam, 1000);
    setInterval(loadNextSubjects, 60000);
});
        // Countdown timer (example for BAC 2026)
        function updateCountdown() {
            const bacDate = new Date('2026-06-15T08:00:00');
            const now = new Date();
            const diff = bacDate - now;
            
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('countdown').textContent = 
                    `BAC 2026: ${days}j ${hours}h ${minutes}m ${seconds}s`;
            } else {
                document.getElementById('countdown').textContent = "BAC 2026: Terminé!";
            }
        }
        setInterval(updateCountdown, 1000);
        updateCountdown();
        
        // Sample reminder
        const reminders = [
            { title: "Révision", description: "Réviser les formules des alcanes" },
            { title: "Histoire", description: "Apprendre la leçon L1 sur la révolution" }
        ];
        
        const reminderDisplay = document.getElementById('reminder-display');
        if (reminders.length > 0) {
            reminderDisplay.innerHTML = `
                <div class="flex items-start p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                    <i data-feather="bell" class="text-yellow-500 mr-2 mt-0.5"></i>
                    <div>
                        <div class="font-medium">${reminders[0].title}</div>
                        <div class="text-sm text-gray-600">${reminders[0].description}</div>
                    </div>
                </div>
            `;
            feather.replace();
        }
        
        // Evolution Chart
        const ctx = document.getElementById('evolutionChart').getContext('2d');
        const evolutionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Trim 1', 'Trim 2', 'Trim 3', 'Trim 1', 'Trim 2'],
                datasets: [{
                    label: 'Moyenne générale',
                    data: [12.5, 13.2, 14.0, 14.5, 15.2],
                    borderColor: '#6C63FF',
                    backgroundColor: 'rgba(108, 99, 255, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 10,
                        max: 20
                    }
                }
            }
        });
        
        // Prevent blue highlight on mobile taps
        document.addEventListener('touchstart', function() {}, true);
      
      // --- PAGE D'EXAMENS --- //
function openExamPage() {
    document.getElementById('exam-page').classList.remove('hidden');
    document.querySelector('main').classList.add('hidden');
    document.querySelector('nav').classList.add('hidden');
    renderExams();
    feather.replace();
    
    // Interval local
    window.examInterval = setInterval(() => {
        renderExams();
        loadNextExam();
    }, 1000);
}

function openExamForm() {
    document.getElementById('exam-form').classList.remove('hidden');
}

function closeExamForm() {
    document.getElementById('exam-form').classList.add('hidden');
}

function addExam() {
    const name = document.getElementById('exam-name').value.trim();
    const date = document.getElementById('exam-date').value;
    const time = document.getElementById('exam-time').value;
    if (!name || !date || !time) return showCustomAlert("Veuillez remplir tous les champs !", 'error');
    
    const exams = JSON.parse(localStorage.getItem('exams')) || [];
    exams.push({ name, date, time });
    localStorage.setItem('exams', JSON.stringify(exams));
    
    document.getElementById('exam-name').value = '';
    document.getElementById('exam-date').value = '';
    document.getElementById('exam-time').value = '';
    
    closeExamForm();
    renderExams();
    loadNextExam(); // actualise aussi l’accueil
}

function renderExams() {
    const list = document.getElementById('exam-list');
    const exams = JSON.parse(localStorage.getItem('exams')) || [];
    list.innerHTML = '';

    if (exams.length === 0) {
        list.innerHTML = `<div class="text-center text-gray-500">Aucun examen ajouté</div>`;
        return;
    }

    const now = new Date();
    exams.forEach((exam, index) => {
        const examDate = new Date(`${exam.date}T${exam.time}`);
        const diff = examDate - now;

        let countdown = 'Terminé';
        if (diff > 0) {
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((diff % (1000 * 60)) / 1000);
            countdown = `${days}J-${hours}H-${mins}MN-${secs}S`;
        }

        const div = document.createElement('div');
        div.className = "p-4 border rounded-lg flex justify-between items-center";
        div.innerHTML = `
            <div>
                <div class="font-medium">${exam.name}</div>
                <div class="text-sm text-gray-500">${exam.date} • ${exam.time}</div>
            </div>
            <div class="flex items-center">
                <div class="text-purple-600 font-semibold mr-4">${countdown}</div>
                <button onclick="deleteExam(${index})" class="text-red-500 hover:text-red-700">
                    <i data-feather="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `;
        list.appendChild(div);
    });
    feather.replace();
}

// --- Mise à jour du compte à rebours en direct --- //
setInterval(() => {
    if (!document.getElementById('exam-page').classList.contains('hidden')) {
        renderExams();
    }
    loadNextExam();
}, 1000);

function closeExamPage() {
    document.getElementById('exam-page').classList.add('hidden');
    document.querySelector('main').classList.remove('hidden');
    document.querySelector('nav').classList.remove('hidden');
    if (window.examInterval) clearInterval(window.examInterval);
}

function deleteExam(index) {
    const exams = JSON.parse(localStorage.getItem('exams')) || [];
    const exam = exams[index];
    
    // Ajouter à la corbeille au lieu de supprimer directement
    addToTrash({
        type: 'Examen',
        title: exam.name,
        description: `Le ${exam.date} à ${exam.time}`,
        data: exam
    });
    
    // Supprimer de la liste originale
    exams.splice(index, 1);
    localStorage.setItem('exams', JSON.stringify(exams));
    
    renderExams();
    loadNextExam();
}
      
      function startHomeCountdown() {
    setInterval(() => {
        const exams = JSON.parse(localStorage.getItem('exams')) || [];
        const now = new Date();
        
        const ongoingExam = exams.find(exam => {
            const examStart = new Date(`${exam.date}T${exam.time}`);
            const examEnd = new Date(examStart.getTime() + 60 * 60 * 1000);
            return now >= examStart && now <= examEnd;
        });
        
        const nextExamElement = document.getElementById('next-exam');
        if (ongoingExam) {
            nextExamElement.textContent = `${ongoingExam.name} - En cours`;
            return;
        }
        
        const futureExams = exams.filter(exam => new Date(`${exam.date}T${exam.time}`) > now)
            .sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));
        
        if (futureExams.length > 0) {
            const nextExam = futureExams[0];
            const examDate = new Date(`${nextExam.date}T${nextExam.time}`);
            const diff = examDate - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((diff % (1000 * 60)) / 1000);
            nextExamElement.innerHTML = `${nextExam.name} dans <span class="countdown-home">${days}J-${hours}H-${mins}MN-${secs}S</span>`;
        } else {
            nextExamElement.textContent = "Aucun examen prévu";
        }
    }, 1000);
}
      
      // === GESTION DES BULLETINS ===

// Ouvrir la page bulletin
function openGradesPage() {
    document.getElementById('grades-page').classList.remove('hidden');
    document.querySelector('main').classList.add('hidden');
    document.querySelector('nav').classList.add('hidden');
    
    // Initialiser le tableau avec les matières par défaut
   // Charger les matières personnalisées ou par défaut
loadCustomSubjects();
    loadSavedBulletins();
    feather.replace();
}

// Fermer la page bulletin
function closeGradesPage() {
    document.getElementById('grades-page').classList.add('hidden');
    document.querySelector('main').classList.remove('hidden');
    document.querySelector('nav').classList.remove('hidden');
}

// Initialiser le tableau des notes
function initializeGradesTable() {
    const tableBody = document.getElementById('grades-table-body');
    tableBody.innerHTML = '';
    
    // Matières par défaut (vous pouvez les modifier)
    const defaultSubjects = [
        { name: 'Mathématiques', coeff: 5 },
        { name: 'Physique-Chimie', coeff: 4 },
        { name: 'SVT', coeff: 3 },
        { name: 'Français', coeff: 4 },
        { name: 'Histoire-Géographie', coeff: 3 },
        { name: 'Anglais', coeff: 3 },
        { name: 'Informatique', coeff: 2 }
    ];
    
    defaultSubjects.forEach(subject => {
        addSubjectRow(subject.name, subject.coeff);
    });
    
    calculateGrades(); // Calcul initial
}

// Ajouter une ligne de matière
function addSubjectRow(name = '', coeff = 1) {
    const tableBody = document.getElementById('grades-table-body');
    const rowId = Date.now();
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td class="border p-2">
            <input type="text" class="subject-name w-full px-2 py-1 border-none focus:ring-0" 
                   value="${name}" placeholder="Nom de la matière">
        </td>
        <td class="border p-2">
            <input type="number" class="subject-coeff w-full px-2 py-1 text-center border-none focus:ring-0" 
                   value="${coeff}" min="1" max="10">
        </td>
        <td class="border p-2">
            <input type="number" class="subject-grade w-full px-2 py-1 text-center border border-gray-300 rounded focus:ring-2 focus:ring-purple-200" 
                   value="" min="0" max="20" step="0.25" placeholder="0-20">
        </td>
        <td class="border p-2 text-center">
            <button onclick="removeSubjectRow(${rowId})" class="text-red-500 hover:text-red-700">
                <i data-feather="trash-2" class="w-4 h-4"></i>
            </button>
        </td>
    `;
    row.id = `subject-row-${rowId}`;
    tableBody.appendChild(row);
    
    // Ajouter les événements pour le calcul automatique ET la sauvegarde
    const gradeInput = row.querySelector('.subject-grade');
    const coeffInput = row.querySelector('.subject-coeff');
    const nameInput = row.querySelector('.subject-name');
    
    gradeInput.addEventListener('input', calculateGrades);
    coeffInput.addEventListener('input', () => {
        calculateGrades();
        saveCustomSubjects();
    });
    nameInput.addEventListener('input', saveCustomSubjects);
    
    feather.replace();
}

// Supprimer une lign de matière
function removeSubjectRow(rowId) {
    const row = document.getElementById(`subject-row-${rowId}`);
    if (row) {
        row.remove();
        calculateGrades();
        saveCustomSubjects(); // Sauvegarder après suppression
    }
}

// Calculer les résultats
function calculateGrades() {
    const rows = document.querySelectorAll('#grades-table-body tr');
    let totalCoeff = 0;
    let totalPoints = 0;
    let subjectsWithGrades = 0;
    
    rows.forEach(row => {
        const coeff = parseFloat(row.querySelector('.subject-coeff').value) || 0;
        const grade = parseFloat(row.querySelector('.subject-grade').value) || 0;
        
        if (grade > 0) {
            totalCoeff += coeff;
            totalPoints += grade * coeff;
            subjectsWithGrades++;
        }
    });
    
    const average = totalCoeff > 0 ? (totalPoints / totalCoeff).toFixed(2) : 0;
    
    // Mettre à jour l'affichage
    document.getElementById('total-coeff').textContent = totalCoeff;
    document.getElementById('total-points').textContent = totalPoints.toFixed(2);
    document.getElementById('average').textContent = average;
    
    return { totalCoeff, totalPoints, average: parseFloat(average) };
}

// Sauvegarder le bulletin
function saveBulletin() {
  const title = document.getElementById('bulletin-title').value.trim();
const date = new Date().toISOString().split('T')[0]; // Date actuelle automatique

// Récupérer depuis les paramètres
const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
const studentName = userProfile.name || '';
const studentClass = userProfile.class || '';
    const rank = document.getElementById('student-rank').value.trim();
    
    if (!title) {
       showCustomAlert('Veuillez donner un titre au bulletin', 'error');
        return;
    }
    
    const results = calculateGrades();
    if (results.average === 0) {
        if (!confirmCustom('Aucune note saisie. Voulez-vous quand même enregistrer ?')) {
            return;
        }
    }
    
    // Récupérer toutes les matières et notes
    const subjects = [];
    document.querySelectorAll('#grades-table-body tr').forEach(row => {
        const name = row.querySelector('.subject-name').value.trim();
        const coeff = parseFloat(row.querySelector('.subject-coeff').value) || 0;
        const grade = parseFloat(row.querySelector('.subject-grade').value) || 0;
        
        if (name) {
            subjects.push({ name, coeff, grade });
        }
    });
    
    const bulletin = {
        id: Date.now().toString(),
        title,
        date: date || new Date().toISOString().split('T')[0],
        studentName,
        studentClass,
        rank,
        subjects,
        ...results,
        createdAt: new Date().toISOString()
    };
    
    // Sauvegarder dans le localStorage
    const bulletins = JSON.parse(localStorage.getItem('bulletins')) || [];
    bulletins.push(bulletin);
    localStorage.setItem('bulletins', JSON.stringify(bulletins));
  
    
    // Mettre à jour l'affichage
    loadSavedBulletins();
    updateHomePageGrades(); // Mettre à jour la page d'accueil
    
    // Réinitialiser le formulaire
    resetGradesForm();
    
    showCustomAlert('Bulletin enregistré avec succès !', 'success');
      setTimeout(loadStrengthWeaknessCharts, 100);

}

      // Fonction pour forcer la sauvegarde et le rechargement
function saveBulletinAndRefresh() {
    saveBulletin(); // Votre fonction existante
    
    // FORCER le rechargement des graphiques après sauvegarde
    setTimeout(() => {
        console.log("🔄 Rechargement forcé après sauvegarde");
        loadStrengthWeaknessCharts();
        updateEvolutionChart();
        updateHomePageGrades();
    }, 500);
}
// Charger les bulletins sauvegardés
function loadSavedBulletins() {
    const container = document.getElementById('saved-bulletins-list');
    const bulletins = JSON.parse(localStorage.getItem('bulletins')) || [];
    
    container.innerHTML = '';
    
    if (bulletins.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <p>Aucun bulletin enregistré</p>
            </div>
        `;
        return;
    }
    
    // Trier par date (du plus récent au plus ancien)
    bulletins.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    bulletins.forEach(bulletin => {
        const bulletinElement = document.createElement('div');
        bulletinElement.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100';
        bulletinElement.onclick = () => showBulletinDetails(bulletin);
        
        bulletinElement.innerHTML = `
            <div>
                <div class="font-medium">${bulletin.title}</div>
                <div class="text-sm text-gray-600">
                    ${bulletin.date} • Moyenne: ${bulletin.average}/20
                    ${bulletin.rank ? `• Rang: ${bulletin.rank}` : ''}
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <div class="text-lg font-bold ${getGradeColor(bulletin.average)}">
                    ${bulletin.average}/20
                </div>
                <i data-feather="chevron-right" class="text-gray-400"></i>
            </div>
        `;
        container.appendChild(bulletinElement);
    });
    
    feather.replace();
}

// Afficher les détails d'un bulletin
      // Sauvegarder les matières personnalisées
function saveCustomSubjects() {
    const subjects = [];
    document.querySelectorAll('#grades-table-body tr').forEach(row => {
        const name = row.querySelector('.subject-name').value.trim();
        const coeff = parseFloat(row.querySelector('.subject-coeff').value) || 1;
        if (name) {
            subjects.push({ name, coeff });
        }
    });
    localStorage.setItem('customSubjects', JSON.stringify(subjects));
}

// Charger les matières personnalisées
function loadCustomSubjects() {
    const customSubjects = JSON.parse(localStorage.getItem('customSubjects') || '[]');
    if (customSubjects.length > 0) {
        // Utiliser les matières personnalisées
        const tableBody = document.getElementById('grades-table-body');
        tableBody.innerHTML = '';
        customSubjects.forEach(subject => {
            addSubjectRow(subject.name, subject.coeff);
        });
    } else {
        // Utiliser les matières par défaut
        initializeGradesTable();
    }
}
// Afficher les détails d'un bulletin - VERSION AVEC BOUTON SUPPRIMER
function showBulletinDetails(bulletin) {
    // Si bulletin est une string (venant du HTML), le parser
    if (typeof bulletin === 'string') {
        try {
            bulletin = JSON.parse(bulletin);
        } catch (e) {
            console.error("❌ Erreur de parsing du bulletin:", e);
            return;
        }
    }
    
    console.log("📋 Affichage des détails pour:", bulletin.title);
    
    let detailsHTML = `
        <div class="bg-white rounded-xl shadow-sm p-6">
            <!-- En-tête avec bouton supprimer -->
            <div class="flex justify-between items-start mb-6">
                <div class="flex-1">
                    <h3 class="text-xl font-semibold text-gray-800">${bulletin.title}</h3>
                    <div class="flex items-center space-x-4 mt-2 text-sm text-gray-600">
                        <span>${bulletin.date}</span>
                        ${bulletin.studentClass ? `<span>• ${bulletin.studentClass}</span>` : ''}
                        ${bulletin.rank ? `<span>• Rang: ${bulletin.rank}</span>` : ''}
                    </div>
                </div>
                <button onclick="event.stopPropagation(); confirmDeleteBulletin('${bulletin.id}')" 
                        class="ml-4 p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors border border-red-200"
                        title="Supprimer ce bulletin">
                    <i data-feather="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
            
            ${bulletin.studentName ? `
                <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="text-sm text-blue-800">
                        <strong>Élève:</strong> ${bulletin.studentName}
                    </div>
                </div>
            ` : ''}
            
            <h4 class="font-semibold mb-3 text-gray-700">Notes détaillées:</h4>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse mb-4">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border p-2 text-left">Matière</th>
                            <th class="border p-2 text-center">Coefficient</th>
                            <th class="border p-2 text-center">Note</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // Afficher seulement les matières avec des notes
    const subjectsWithGrades = bulletin.subjects.filter(subject => subject.grade > 0);
    
    if (subjectsWithGrades.length === 0) {
        detailsHTML += `
            <tr>
                <td colspan="3" class="border p-4 text-center text-gray-500">
                    Aucune note saisie
                </td>
            </tr>
        `;
    } else {
        subjectsWithGrades.forEach(subject => {
            detailsHTML += `
                <tr>
                    <td class="border p-2">${subject.name}</td>
                    <td class="border p-2 text-center">${subject.coeff}</td>
                    <td class="border p-2 text-center ${getGradeColor(subject.grade)} font-medium">
                        ${subject.grade}/20
                    </td>
                </tr>
            `;
        });
    }
    
    detailsHTML += `
                    </tbody>
                </table>
            </div>
            
            <!-- Résultats -->
            <div class="grid grid-cols-3 gap-4 mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                <div class="text-center">
                    <div class="text-xl font-bold text-purple-700">${bulletin.totalCoeff}</div>
                    <div class="text-sm text-purple-600">Total Coeff</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold text-blue-700">${bulletin.totalPoints.toFixed(2)}</div>
                    <div class="text-sm text-blue-600">Total Points</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold ${getGradeColor(bulletin.average)}">${bulletin.average}/20</div>
                    <div class="text-sm ${getGradeColor(bulletin.average)}">Moyenne</div>
                </div>
            </div>
    `;
    
    // Ajouter les points forts/faibles seulement s'il y a des notes
    if (subjectsWithGrades.length > 0) {
        detailsHTML += `
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <h5 class="font-semibold text-green-800 mb-3 flex items-center">
                        <i data-feather="trending-up" class="w-4 h-4 mr-2"></i>
                        Points forts
                    </h5>
                    <div class="text-sm text-green-700 space-y-1">
                        ${getStrongPoints(bulletin.subjects)}
                    </div>
                </div>
                <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                    <h5 class="font-semibold text-red-800 mb-3 flex items-center">
                        <i data-feather="trending-down" class="w-4 h-4 mr-2"></i>
                        Points à améliorer
                    </h5>
                    <div class="text-sm text-red-700 space-y-1">
                        ${getWeakPoints(bulletin.subjects)}
                    </div>
                </div>
            </div>
        `;
    }
    
    detailsHTML += `</div>`;
    
    // CRÉATION DE LA MODALE
     const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-2'; // ← p-2 au lieu de p-4
    modal.style.zIndex = '9999';
    modal.innerHTML = `
        <div class="bg-white rounded-xl w-full max-w-6xl max-h-[95vh] overflow-y-auto mx-2"> <!-- ← max-w-6xl et mx-2 -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 sticky top-0 bg-white"> <!-- ← p-4 au lieu de p-6 -->
                <h3 class="text-lg font-semibold text-gray-800">Détails du bulletin</h3>
                <button onclick="closeBulletinModal()" class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100 transition-colors">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4"> <!-- ← p-4 au lieu de p-6 -->
                ${detailsHTML}
            </div>
            <div class="flex justify-between items-center p-4 border-t border-gray-200 sticky bottom-0 bg-white"> <!-- ← p-4 au lieu de p-6 -->
                <button onclick="closeBulletinModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Retour à la liste
                </button>
                <div class="flex space-x-2">
                    <button onclick="event.stopPropagation(); confirmDeleteBulletin('${bulletin.id}')" 
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center">
                        <i data-feather="trash-2" class="w-4 h-4 mr-2"></i>
                        Supprimer
                    </button>
                </div>
            </div>
        </div>
    `;
    
    modal.id = 'bulletin-details-modal';
    const gradesPage = document.getElementById('grades-page');
    gradesPage.appendChild(modal);
    
    feather.replace();
}
    

      // Fenêtre de confirmation de suppreLIORÉE
// Fenêtre de confirmation de suppression - VERSION CORRIGÉE
function confirmDeleteBulletin(bulletinId) {
    const bulletins = JSON.parse(localStorage.getItem('bulletins')) || [];
    const bulletin = bulletins.find(b => b.id === bulletinId);
    
    if (!bulletin) {
        console.error("❌ Bulletin non trouvé pour suppression:", bulletinId);
        return;
    }
    
    // ⭐⭐ AJOUTEZ CETTE LIGNE ⭐⭐ - Fermer la fenêtre de détail
    closeBulletinModal();
    
    // CRÉATION DE LA MODALE DANS LA PAGE BULLETIN
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-70 flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
            <!-- Icône d'alerte -->
            <div class="flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mx-auto mb-4">
                <i data-feather="alert-triangle" class="w-8 h-8 text-red-600"></i>
            </div>
            
            <!-- Titre -->
            <h3 class="text-xl font-semibold text-center mb-3 text-gray-800">Supprimer le bulletin</h3>
            
            <!-- Message -->
            <div class="text-center mb-6">
                <p class="text-gray-600 mb-2">Voulez-vous vraiment supprimer ce bulletin ?</p>
                <p class="text-lg font-medium text-purple-600">"${bulletin.title}"</p>
                <p class="text-sm text-gray-500 mt-2">Cette action est irréversible</p>
            </div>
            
            <!-- Informations du bulletin -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="text-gray-600">Date:</div>
                    <div class="font-medium">${bulletin.date}</div>
                    
                    <div class="text-gray-600">Moyenne:</div>
                    <div class="font-medium ${getGradeColor(bulletin.average)}">${bulletin.average}/20</div>
                    
                    ${bulletin.studentClass ? `
                        <div class="text-gray-600">Classe:</div>
                        <div class="font-medium">${bulletin.studentClass}</div>
                    ` : ''}
                </div>
            </div>
            
            <!-- Boutons d'action -->
            <div class="flex space-x-3">
                <button onclick="closeDeleteModal()" 
                        class="flex-1 px-4 py-3 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors font-medium">
                    Annuler
                </button>
                <button onclick="deleteBulletin('${bulletinId}')" 
                        class="flex-1 px-4 py-3 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors font-medium flex items-center justify-center">
                    <i data-feather="trash-2" class="w-4 h-4 mr-2"></i>
                    Supprimer
                </button>
            </div>
        </div>
    `;
    
    modal.id = 'delete-bulletin-modal';
    
    // AJOUTER LA MODALE DANS LA PAGE BULLETIN, PAS DANS LE BODY
    const gradesPage = document.getElementById('grades-page');
    gradesPage.appendChild(modal);
    
    feather.replace();
}

// Fermer la modale de suppression - VERSION CORRIGÉE
function closeDeleteModal() {
    const modal = document.getElementById('delete-bulletin-modal');
    if (modal && modal.parentNode) {
        modal.parentNode.removeChild(modal);
    }
}

// Supprimer définitivement un bulletin - VERSION CORRIGÉE
function deleteBulletin(bulletinId) {
    let bulletins = JSON.parse(localStorage.getItem('bulletins')) || [];
    const bulletinToDelete = bulletins.find(b => b.id === bulletinId);
    
    if (!bulletinToDelete) return;
    
    // Ajouter à la corbeille
    addToTrash({
        type: 'Bulletin',
        title: bulletinToDelete.title,
        description: `Moyenne: ${bulletinToDelete.average}/20 - ${bulletinToDelete.date}`,
        data: bulletinToDelete
    });
    
    // Supprimer de la liste originale
    bulletins = bulletins.filter(b => b.id !== bulletinId);
    localStorage.setItem('bulletins', JSON.stringify(bulletins));
    
    // Fermer TOUTES les modales
    closeDeleteModal();
    closeBulletinModal();
    
    // Mettre à jour l'affichage
    loadSavedBulletins();
    updateHomePageGrades();
    updateEvolutionChart();
    
    showCustomAlert(`Bulletin "${bulletinToDelete.title}" déplacé vers la corbeille`);
    setTimeout(loadStrengthWeaknessCharts, 100);
}
      
      function deleteSubject(scheduleIndex, day, timeSlot) {
    const schedules = JSON.parse(localStorage.getItem('schedules')) || [];
    const schedule = schedules[scheduleIndex];
    const subjectName = schedule.data[day][timeSlot];
    
    // Ajouter à la corbeille
    addToTrash({
        type: 'Matière',
        title: subjectName,
        description: `${day} à ${timeSlot}`,
        data: { scheduleIndex, day, timeSlot, subjectName }
    });
    
    // Supprimer de l'emploi du temps
    schedule.data[day][timeSlot] = '';
    localStorage.setItem('schedules', JSON.stringify(schedules));
    
    // Recharger l'affichage
    renderSchedule();
    showCustomAlert('Matière déplacée vers la corbeille');
}
// Fermer la modale de détail - VERSION AMÉLIORÉE
function closeBulletinModal() {
    const modal = document.getElementById('bulletin-details-modal');
    if (modal) {
        console.log("🔒 Fermeture de la modale de détail");
        modal.remove();
    } else {
        console.log("❌ Modale non trouvée pour fermeture");
    }
}

      // Supprimer définitivement un bulletin - VERSION AMÉLIORÉE
function deleteBulletin(bulletinId) {
    console.log("🗑️ Suppression du bulletin:", bulletinId);
    
    let bulletins = JSON.parse(localStorage.getItem('bulletins')) || [];
    const bulletinToDelete = bulletins.find(b => b.id === bulletinId);
    const initialLength = bulletins.length;
    
    if (!bulletinToDelete) {
        console.error("❌ Bulletin non trouvé lors de la suppression");
        return;
    }
    
    // Filtrer pour supprimer le bulletin
    bulletins = bulletins.filter(b => b.id !== bulletinId);
    
    // Sauvegarder la nouvelle liste
    localStorage.setItem('bulletins', JSON.stringify(bulletins));
    
    // Fermer la modale
    closeDeleteModal();
    
    // Mettre à jour l'affichage
    loadSavedBulletins();
    updateHomePageGrades();
    updateEvolutionChart();
    
    console.log("✅ Bulletin supprimé avec succès");
    
    // Message de confirmation avec plus d'infos
    showNotification(`Bulletin "${bulletinToDelete.title}" supprimé`, 'success');
}

// Fermer la modale de suppression
function closeDeleteModal() {
    const modal = document.getElementById('delete-bulletin-modal');
    if (modal) {
        modal.remove();
    }
}
      
// Fonctions points forts/faibles - VERSION AMÉLIORÉE
function getStrongPoints(subjects) {
    const strongSubjects = subjects.filter(subject => 
        subject.grade >= 14 && subject.grade > 0
    );
    
    if (strongSubjects.length === 0) {
        return "<span class='text-gray-500'>Aucun point fort identifié</span>";
    }
    
    const points = strongSubjects.map(subject => 
        `<div class="flex justify-between items-center py-1">
            <span>${subject.name}</span>
            <span class="font-semibold ${getGradeColor(subject.grade)}">${subject.grade}/20</span>
         </div>`
    ).join('');
    
    return points;
}

function getWeakPoints(subjects) {
    const weakSubjects = subjects.filter(subject => 
        subject.grade < 10 && subject.grade > 0
    );
    
    if (weakSubjects.length === 0) {
        return "<span class='text-gray-500'>Aucun point faible majeur</span>";
    }
    
    const points = weakSubjects.map(subject => 
        `<div class="flex justify-between items-center py-1">
            <span>${subject.name}</span>
            <span class="font-semibold ${getGradeColor(subject.grade)}">${subject.grade}/20</span>
         </div>`
    ).join('');
    
    return points;
}

// Couleur selon la note
function getGradeColor(grade) {
    if (grade >= 16) return 'text-green-600';
    if (grade >= 14) return 'text-blue-600';
    if (grade >= 10) return 'text-yellow-600';
    return 'text-red-600';
}

// Réinitialiser le formulaire
function resetGradesForm() {
    document.getElementById('bulletin-title').value = '';
    document.getElementById('bulletin-date').value = '';
    document.getElementById('student-name').value = '';
    document.getElementById('student-class').value = '';
    document.getElementById('student-rank').value = '';
    initializeGradesTable();
}

// Mettre à jour l'affichage des notes sur la page d'accueil
// Mettre à jour l'affichage des notes sur la page d'accueil (VERSION CORRIGÉE)
// Mettre à jour l'affichage des notes sur la page d'accueil (VERSION AMÉLIORÉE)
function updateHomePageGrades() {
    const bulletins = JSON.parse(localStorage.getItem('bulletins')) || [];
    
    const lastBulletinTitle = document.getElementById('last-bulletin-title');
    const lastBulletinAverage = document.getElementById('last-bulletin-average');
    
    if (bulletins.length > 0) {
        // Trier par date et prendre le plus récent
        const latestBulletin = bulletins.sort((a, b) => 
            new Date(b.createdAt) - new Date(a.createdAt)
        )[0];
        
        // Mettre à jour l'affichage sur la page d'accueil
        if (lastBulletinTitle) {
            lastBulletinTitle.textContent = latestBulletin.title;
        }
        if (lastBulletinAverage) {
            lastBulletinAverage.textContent = `Moyenne: ${latestBulletin.average}/20`;
            lastBulletinAverage.className = `text-sm ${getGradeColor(latestBulletin.average)}`;
        }
        
        // ⭐⭐ FORCER LA MISE À JOUR DES GRAPHIQUES
        setTimeout(() => {
            updateEvolutionChart();
            loadStrengthWeaknessCharts();
        }, 300);
        
    } else {
        // Aucun bulletin
        if (lastBulletinTitle) {
            lastBulletinTitle.textContent = "Aucun bulletin";
        }
        if (lastBulletinAverage) {
            lastBulletinAverage.textContent = "Moyenne: --/20";
            lastBulletinAverage.className = "text-sm text-gray-500";
        }
        
        // ⭐⭐ Même sans bulletins, initialiser les graphiques vides
        setTimeout(() => {
            loadStrengthWeaknessCharts();
            updateEvolutionChart();
        }, 300);
    }
}
      // Mettre à jour le graphique d'évolution
// Mettre à jour le graphique d'évolution - VERSION AVEC NOMS DE BULLETINS
function updateEvolutionChart() {
    const bulletins = JSON.parse(localStorage.getItem('bulletins')) || [];
    const canvas = document.getElementById('evolutionChart');
    
    console.log("🔄 Mise à jour du graphique avec noms de bulletins...");
    
    if (!canvas) {
        console.error("❌ Canvas 'evolutionChart' non trouvé");
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Détruire l'ancien graphique s'il existe
    if (window.evolutionChartInstance) {
        window.evolutionChartInstance.destroy();
    }
    
    if (bulletins.length === 0) {
        // Afficher un message quand il n'y a pas de données
        ctx.fillStyle = '#9CA3AF';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Aucune donnée disponible', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    // Trier par date
    const sortedBulletins = bulletins.sort((a, b) => 
        new Date(a.createdAt) - new Date(a.createdAt)
    );
    
    // Utiliser les TITRES des bulletins comme labels
    const labels = sortedBulletins.map(b => {
        // Tronquer les titres trop longs
        const title = b.title.length > 15 ? b.title.substring(0, 15) + '...' : b.title;
        return title;
    });
    
    const averages = sortedBulletins.map(b => parseFloat(b.average));
    
    console.log("Labels (noms bulletins):", labels);
    console.log("Moyennes:", averages);
    
    // Créer le nouveau graphique
    window.evolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Moyenne générale',
                data: averages,
                borderColor: '#6C63FF',
                backgroundColor: 'rgba(108, 99, 255, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#6C63FF',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    callbacks: {
                        title: function(context) {
                            // Afficher le titre complet dans le tooltip
                            const bulletin = sortedBulletins[context[0].dataIndex];
                            return bulletin.title;
                        },
                        label: function(context) {
                            const bulletin = sortedBulletins[context[0].dataIndex];
                            return [
                                `Moyenne: ${context.parsed.y}/20`,
                                `Date: ${bulletin.date}`,
                                bulletin.studentClass ? `Classe: ${bulletin.studentClass}` : ''
                            ].filter(Boolean);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: Math.max(0, Math.floor(Math.min(...averages) - 1)),
                    max: Math.min(20, Math.ceil(Math.max(...averages) + 1)),
                    ticks: {
                        callback: function(value) {
                            return value + '/20';
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
    
    console.log("✅ Graphique créé avec noms de bulletins");
}
      
      // === MÉTHODE GARANTIE POUR LES GRAPHIQUES POINTS FORTS/FAIBLES ===

// Fonction principale - À APPELER DIRECTEMENT
function loadStrengthWeaknessCharts() {
    console.log("🚀 CHARGEMENT DES GRAPHIQUES POINTS FORTS/FAIBLES");
    
    // 1. Vérifier que les éléments existent
    const section = document.getElementById('strength-weakness-section');
    if (!section) {
        console.error("❌ Section non trouvée");
        return;
    }
    
    // 2. Récupérer les bulletins
    const bulletins = JSON.parse(localStorage.getItem('bulletins')) || [];
    console.log(`📊 ${bulletins.length} bulletins trouvés`);
    
    // 3. Si pas de bulletins, afficher messages
    if (bulletins.length === 0) {
        showNoDataState();
        return;
    }
    
    // 4. Calculer les données
    const analysis = analyzeSubjects(bulletins);
    console.log("📈 Analyse:", analysis);
    
    // 5. Créer les graphiques
    createCharts(analysis);
}

// Analyser les matières
function analyzeSubjects(bulletins) {
    const subjectData = {};
    
    // Parcourir tous les bulletins et toutes les matières
    bulletins.forEach(bulletin => {
        bulletin.subjects.forEach(subject => {
            if (subject.name && subject.name.trim() !== '' && subject.grade > 0) {
                const subjectName = subject.name.trim();
                
                if (!subjectData[subjectName]) {
                    subjectData[subjectName] = {
                        total: 0,
                        count: 0,
                        grades: []
                    };
                }
                
                subjectData[subjectName].total += subject.grade;
                subjectData[subjectName].count += 1;
                subjectData[subjectName].grades.push(subject.grade);
            }
        });
    });
    
    // Calculer les moyennes
    Object.keys(subjectData).forEach(subjectName => {
        const data = subjectData[subjectName];
        data.average = data.total / data.count;
    });
    
    return subjectData;
}

// Créer les graphiques
// Créer les graphiques
function createCharts(subjectData) {
    // Séparer points forts et faibles AVEC NOUVELLES BORNES
    const strongSubjects = [];
    const weakSubjects = [];
    
    Object.keys(subjectData).forEach(subjectName => {
        const data = subjectData[subjectName];
        
        // ⭐⭐ POINTS FORTS : de 10 à 20/20 (au lieu de 14-20)
        if (data.average >= 10) {
            strongSubjects.push({
                name: subjectName,
                average: data.average,
                count: data.count
            });
        } 
        // ⭐⭐ POINTS FAIBLES : moins de 10/20
        else if (data.average < 10) {
            weakSubjects.push({
                name: subjectName,
                average: data.average,
                count: data.count
            });
        }
    });
    
    // Trier
    strongSubjects.sort((a, b) => b.average - a.average);
    weakSubjects.sort((a, b) => a.average - b.average);
    
    console.log(`✅ Points forts: ${strongSubjects.length}, Points faibles: ${weakSubjects.length}`);
    
    // Créer le graphique points forts
    if (strongSubjects.length > 0) {
        createBarChart('strongSubjectsChart', strongSubjects, 'strong');
        document.getElementById('no-strong-subjects').classList.add('hidden');
    } else {
        document.getElementById('no-strong-subjects').classList.remove('hidden');
        document.getElementById('strongSubjectsChart').style.display = 'none';
    }
    
    // Créer le graphique points faibles
    if (weakSubjects.length > 0) {
        createBarChart('weakSubjectsChart', weakSubjects, 'weak');
        document.getElementById('no-weak-subjects').classList.add('hidden');
    } else {
        document.getElementById('no-weak-subjects').classList.remove('hidden');
        document.getElementById('weakSubjectsChart').style.display = 'none';
    }
}

// Créer un graphique en barres avec couleurs par note
function createBarChart(canvasId, data, chartType) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`❌ Canvas ${canvasId} non trouvé`);
        return;
    }
    
    // Afficher le canvas
    canvas.style.display = 'block';
    
    // Fonction pour déterminer la couleur selon la note ET le type de graphique
    function getBarColor(average, type) {
        if (type === 'strong') {
            // COULEURS POINTS FORTS (10-20)
            if (average >= 16) return { bg: '#10B981', border: '#059669' }; // Vert
            if (average >= 14) return { bg: '#3B82F6', border: '#1D4ED8' }; // Bleu
            if (average >= 12) return { bg: '#8B5CF6', border: '#7C3AED' }; // Violet
            return { bg: '#F59E0B', border: '#D97706' }; // Orange (10-11.9)
        } else {
            // COULEURS POINTS FAIBLES (0-9.9) - Dégradé de rouge
            if (average >= 8) return { bg: '#FCA5A5', border: '#F87171' }; // Rouge clair
            if (average >= 6) return { bg: '#F87171', border: '#EF4444' }; // Rouge moyen
            if (average >= 4) return { bg: '#EF4444', border: '#DC2626' }; // Rouge
            if (average >= 2) return { bg: '#DC2626', border: '#B91C1C' }; // Rouge foncé
            return { bg: '#991B1B', border: '#7F1D1D' }; // Rouge très foncé
        }
    }
    
    // Préparer les données et couleurs
    const labels = data.map(item => 
        item.name.length > 12 ? item.name.substring(0, 12) + '...' : item.name
    );
    
    const averages = data.map(item => item.average);
    const backgroundColors = data.map(item => getBarColor(item.average, chartType).bg);
    const borderColors = data.map(item => getBarColor(item.average, chartType).border);
    
    // Détruire l'ancien graphique s'il existe
    if (window[canvasId + 'Instance']) {
        window[canvasId + 'Instance'].destroy();
    }
    
    // Créer le nouveau graphique
    window[canvasId + 'Instance'] = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Moyenne',
                data: averages,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const item = data[context.dataIndex];
                            return [
                                `Moyenne: ${context.parsed.y.toFixed(2)}/20`,
                                `Notes: ${item.count} bulletin(s)`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: chartType === 'weak' ? 10 : 20, // Limite différente selon le type
                    min: chartType === 'weak' ? 0 : 10,  // Commence à 10 pour points forts
                    ticks: {
                        callback: function(value) {
                            return value + '/20';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    console.log(`✅ Graphique ${canvasId} créé (${chartType}) avec ${data.length} éléments`);
}

// État  pas de données
function showNoDataState() {
    document.getElementById('no-strong-subjects').classList.remove('hidden');
    document.getElementById('no-weak-subjects').classList.remove('hidden');
    document.getElementById('strongSubjectsChart').style.display = 'none';
    document.getElementById('weakSubjectsChart').style.display = 'none';
}

// Fonction de test FORCÉE
function forceLoadCharts() {
    console.log("🔧 FORCAGE DU CHARGEMENT DES GRAPHIQUES");
    loadStrengthWeaknessCharts();
}
      // Rechargement automatique des graphiques au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log("📄 Page chargée - Initialisation...");
    
    // Attendre que tout soit chargé
    setTimeout(() => {
        initPage();
        
        // Recharger les graphiques même après une réinitialisation
        window.addEventListener('load', function() {
            setTimeout(() => {
                console.log("🔄 Rechargement après reset");
                loadStrengthWeaknessCharts();
            }, 1000);
        });
    }, 100);
});

// Forcer le rechargement quand on revient sur la page
window.addEventListener('pageshow', function(event) {
    if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
        console.log("🔄 Page restaurée depuis le cache - Rechargement des graphiques");
        setTimeout(() => {
            loadStrengthWeaknessCharts();
            updateEvolutionChart();
        }, 500);
    }
});
      
      // Citations inspirantes
const quotes = [
    "La persévérance est la clé de la réussite.",
    "Chaque expert était autrefois un débutant.",
    "Le savoir est la seule chose qui s'accroît quand on le partage.",
    "L'éducation est l'arme la plus puissante pour changer le monde.",
    "Le succès, c'est d'aller d'échec en échec sans perdre son enthousiasme.",
    "La discipline est le pont entre les objectifs et leur réalisation.",
    "Crois en toi et tout deviendra possible.",
    "Le futur appartient à ceux qui croient en la beauté de leurs rêves.",
    "Chaque jour est une nouvelle occasion d'apprendre.",
    "La curiosité est le moteur de l'apprentissage.",
    "Les difficultés préparent les gens ordinaires à des destins extraordinaires.",
    "Ton éducation est un entraînement pour l'esprit.",
    "Le plus grand risque est de ne prendre aucun risque.",
    "La qualité de ton apprentissage détermine la qualité de ta vie.",
    "Sois le changement que tu veux voir dans le monde."
];

// Salutations dynamiques
// Salutations dynamiques - VERSION CORRIGÉE
function getDynamicGreeting() {
    const now = new Date();
    const hour = now.getHours();
    console.log("🕐 Heure actuelle:", hour);
    
    // Salutations selon l'heure - CORRECTION DES PLAGES
    if (hour >= 5 && hour < 10) {
        const greetings = ["Bon réveil", "Belle matinée", "Bon début de journée"];
        return greetings[Math.floor(Math.random() * greetings.length)];
    } else if (hour >= 10 && hour < 12) {
        const greetings = ["Bonjour", "Bonne avant-midi", "Excellente journée"];
        return greetings[Math.floor(Math.random() * greetings.length)];
    } else if (hour >= 12 && hour < 14) {
        return "Bon appétit";
    } else if (hour >= 14 && hour < 18) {
        const greetings = ["Bon après-midi", "Bonne continuation", "Courage pour la suite"];
        return greetings[Math.floor(Math.random() * greetings.length)];
    } else if (hour >= 18 && hour < 22) {
        const greetings = ["Bonsoir", "Belle soirée", "Bon repos"];
        return greetings[Math.floor(Math.random() * greetings.length)];
    } else {
        // 22h à 4h59 - CORRECTION ICI
        const greetings = ["Bonne nuit", "Doux rêves", "Repose-toi bien"];
        return greetings[Math.floor(Math.random() * greetings.length)];
    }
}

// Salutations spéciales selon le jour - VERSION CORRIGÉE
function getDaySpecificGreeting() {
    const now = new Date();
    const day = now.getDay(); // 0 = dimanche, 1 = lundi...
    
    // Uniquement les jours spéciaux, pas tous les jours
    switch(day) {
        case 1: return "Bon début de semaine 💪";
        case 5: return "Bon vendredi 🎉"; 
        case 6: 
        case 0: return "Bon weekend 😊";
        default: return null;
    }
}

// Obtenir une citation aléatoire
      // Fonction pour ajouter un élément à la corbeille
function addToTrash(item) {
    const trash = JSON.parse(localStorage.getItem('trash') || '[]');
    
    const trashItem = {
        id: Date.now().toString(),
        type: item.type,
        title: item.title,
        description: item.description,
        data: item.data,
        deletedAt: new Date().toLocaleDateString('fr-FR'),
        deletedTime: new Date().toLocaleTimeString('fr-FR')
    };
    
    trash.push(trashItem);
    localStorage.setItem('trash', JSON.stringify(trash));
    
    // Supprimer l'élément original
    deleteOriginalItem(item);
    
    showCustomAlert(`${item.type} déplacé vers la corbeille`);
}

// Supprimer l'élément original selon son type
function deleteOriginalItem(item) {
    switch(item.type) {
        case 'Examen':
            const exams = JSON.parse(localStorage.getItem('exams') || '[]');
            const filteredExams = exams.filter(exam => exam.name !== item.title);
            localStorage.setItem('exams', JSON.stringify(filteredExams));
            break;
            
        case 'Rappel':
            const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
            const filteredReminders = reminders.filter(reminder => reminder.title !== item.title);
            localStorage.setItem('reminders', JSON.stringify(filteredReminders));
            break;
            
        case 'Matière':
            // Pour les matières, c'est plus complexe - on garde juste dans la corbeille
            break;
    }
}

// Charger la corbeille
function loadTrash() {
    const trash = JSON.parse(localStorage.getItem('trash') || '[]');
    const trashList = document.getElementById('trashList');
    const emptyMessage = document.getElementById('emptyTrashMessage');
    
    if (trash.length === 0) {
        trashList.innerHTML = '';
        emptyMessage.classList.remove('hidden');
        return;
    }
    
    emptyMessage.classList.add('hidden');
    trashList.innerHTML = trash.map(item => `
        <div class="trash-item px-4 py-3 border-b border-gray-100 flex justify-between items-center">
            <div>
                <div class="font-medium">${item.title}</div>
                <div class="text-sm text-gray-500">${item.type} supprimé le ${item.deletedAt}</div>
                ${item.description ? `<div class="text-xs text-gray-400">${item.description}</div>` : ''}
            </div>
            <button class="restore-item p-2 rounded-full hover:bg-gray-100 text-purple-600" onclick="restoreFromTrash('${item.id}')">
                <i data-feather="refresh-ccw" class="w-4 h-4"></i>
            </button>
        </div>
    `).join('');
    
    feather.replace();
}

// Restaurer un élément
function restoreFromTrash(itemId) {
    const trash = JSON.parse(localStorage.getItem('trash') || '[]');
    const itemIndex = trash.findIndex(item => item.id === itemId);
    
    if (itemIndex === -1) return;
    
    const item = trash[itemIndex];
    
    // Restaurer selon le type
    switch(item.type) {
        case 'Examen':
            const exams = JSON.parse(localStorage.getItem('exams') || '[]');
            exams.push(item.data);
            localStorage.setItem('exams', JSON.stringify(exams));
            break;
            
        case 'Rappel':
            const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
            reminders.push(item.data);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            break;
    }
    
    // Retirer de la corbeille
    trash.splice(itemIndex, 1);
    localStorage.setItem('trash', JSON.stringify(trash));
    
    loadTrash();
    showCustomAlert(`${item.type} restauré avec succès`);
}

// Vider la corbeille
function emptyTrash() {
    localStorage.setItem('trash', '[]');
    loadTrash();
    showCustomAlert('Corbeille vidée avec succès');
}
// Obtenir une citation aléatoire - VERSION CORRIGÉE
function getRandomQuote() {
    const quotes = [
        "La persévérance est la clé de la réussite.",
        "Chaque expert était autrefois un débutant.",
        "Le savoir est la seule chose qui s'accroît quand on le partage.",
        "L'éducation est l'arme la plus puissante pour changer le monde.",
        "Le succès, c'est d'aller d'échec en échec sans perdre son enthousiasme.",
        "La discipline est le pont entre les objectifs et leur réalisation.",
        "Crois en toi et tout deviendra possible.",
        "Le futur appartient à ceux qui croient en la beauté de leurs rêves.",
        "Chaque jour est une nouvelle occasion d'apprendre.",
        "La curiosité est le moteur de l'apprentissage.",
        "Les difficultés préparent les gens ordinaires à des destins extraordinaires.",
        "Ton éducation est un entraînement pour l'esprit.",
        "Le plus grand risque est de ne prendre aucun risque.",
        "La qualité de ton apprentissage détermine la qualité de ta vie.",
        "Sois le changement que tu veux voir dans le monde."
    ];
    
    // Utiliser l'heure actuelle comme seed pour varier les citations
    const now = new Date();
    const seed = now.getHours() * 60 + now.getMinutes(); // Minute dans la journée
    
    // Choisir une citation basée sur le temps pour varier
    const quoteIndex = seed % quotes.length;
    
    console.log("📖 Citation choisie:", quoteIndex, quotes[quoteIndex]);
    
    return quotes[quoteIndex];
}

// Mettre à jour l'affichage du profil
      // Fonction de recherche globale
// Fonction de recherche globale en temps réel
function performSearch(searchTerm) {
    if (!searchTerm || searchTerm.trim() === '') {
        closeSearchResults();
        return;
    }
    
    const term = searchTerm.toLowerCase().trim();
    const results = [];
    
    // Recherche dans TOUT sans filtre strict
    searchInAllData(term, results);
    
    // Afficher les résultats immédiatement
    showSearchResults(results, term);
}

// Recherche approfondie dans toutes les données
function searchInAllData(term, results) {
    // 1. EXAMENS
    const exams = JSON.parse(localStorage.getItem('exams') || '[]');
    exams.forEach(exam => {
        if (exam.name.toLowerCase().includes(term) || 
            exam.date.includes(term) || 
            exam.time.includes(term)) {
            results.push({
                type: 'Examen',
                title: exam.name,
                description: `📅 ${exam.date} ⏰ ${exam.time}`,
                action: () => { openExamPage(); closeSearchResults(); }
            });
        }
    });
    
    // 2. RAPPELS
    const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
    reminders.forEach(reminder => {
        if (reminder.title.toLowerCase().includes(term) || 
            (reminder.details && reminder.details.toLowerCase().includes(term)) ||
            reminder.date.includes(term)) {
            results.push({
                type: 'Rappel',
                title: reminder.title,
                description: `📝 ${reminder.details || 'Sans détail'} • ${reminder.date}`,
                action: () => { openReminderPage(); closeSearchResults(); }
            });
        }
    });
    
    // 3. MATIÈRES (emplois du temps)
    const schedules = JSON.parse(localStorage.getItem('schedules') || '[]');
    schedules.forEach((schedule, scheduleIndex) => {
        Object.keys(schedule.data || {}).forEach(day => {
            Object.keys(schedule.data[day] || {}).forEach(time => {
                const subject = schedule.data[day][time];
                if (subject && subject.toLowerCase().includes(term)) {
                    results.push({
                        type: 'Matière',
                        title: subject,
                        description: `📚 ${day} • ${time} • ${schedule.name || 'Emploi du temps'}`,
                        action: () => { 
                            showPage('schedule-page'); 
                            closeSearchResults();
                            // Optionnel: highlight la matière
                            highlightSubject(scheduleIndex, day, time);
                        }
                    });
                }
            });
        });
    });
    
    // 4. BULLETINS
    const bulletins = JSON.parse(localStorage.getItem('bulletins') || '[]');
    bulletins.forEach(bulletin => {
        if (bulletin.title.toLowerCase().includes(term) ||
            (bulletin.studentName && bulletin.studentName.toLowerCase().includes(term)) ||
            (bulletin.studentClass && bulletin.studentClass.toLowerCase().includes(term)) ||
            bulletin.date.includes(term)) {
            results.push({
                type: 'Bulletin',
                title: bulletin.title,
                description: `📊 Moyenne: ${bulletin.average}/20 • ${bulletin.date}`,
                action: () => { openGradesPage(); closeSearchResults(); }
            });
        }
        
        // Recherche dans les notes des matières du bulletin
        bulletin.subjects.forEach(subject => {
            if (subject.name && subject.name.toLowerCase().includes(term)) {
                results.push({
                    type: 'Note',
                    title: `${subject.name} - ${subject.grade}/20`,
                    description: `📋 ${bulletin.title} • Coeff: ${subject.coeff}`,
                    action: () => { openGradesPage(); closeSearchResults(); }
                });
            }
        });
    });
    
    // 5. CORBEILLE
    const trash = JSON.parse(localStorage.getItem('trash') || '[]');
    trash.forEach(item => {
        if (item.title.toLowerCase().includes(term) || 
            item.type.toLowerCase().includes(term) ||
            item.description.toLowerCase().includes(term)) {
            results.push({
                type: `🗑️ ${item.type}`,
                title: item.title,
                description: `Corbeille • Supprimé le ${item.deletedAt}`,
                action: () => { showPage('settings-page'); closeSearchResults(); }
            });
        }
    });
}

// Afficher les résultats de recherche
// Afficher les résultats de recherche
function showSearchResults(results, searchTerm) {
    closeSearchResults(); // Fermer les anciens résultats
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-30 z-50 flex justify-center pt-20';
    modal.id = 'search-results-modal';
    modal.onclick = closeSearchResults;
    
    modal.innerHTML = `
        <div class="bg-white rounded-xl w-full max-w-2xl max-h-96 overflow-y-auto mx-4 shadow-lg" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-purple-50">
                <h3 class="text-lg font-semibold text-purple-800">
                    🔍 ${results.length} résultat(s) pour "${searchTerm}"
                </h3>
                <button onclick="closeSearchResults()" class="text-purple-600 hover:text-purple-800">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="p-2 max-h-80 overflow-y-auto">
                ${results.length === 0 ? 
                    '<div class="text-center text-gray-500 py-8"><i data-feather="search" class="w-12 h-12 mx-auto mb-2"></i><p>Aucun résultat trouvé</p></div>' : 
                    results.map((result, index) => `
                        <div class="p-3 border-b border-gray-100 hover:bg-purple-50 cursor-pointer transition-colors" 
                             onclick="executeSearchAction('${result.type}', '${result.title.replace(/'/g, "\\'")}', '${searchTerm.replace(/'/g, "\\'")}')">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">${result.title}</div>
                                    <div class="text-sm text-gray-600 mt-1">${result.description}</div>
                                </div>
                                <span class="px-2 py-1 bg-purple-100 text-purple-600 text-xs rounded-full whitespace-nowrap ml-2">
                                    ${result.type}
                                </span>
                            </div>
                        </div>
                    `).join('')
                }
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    feather.replace();
}

// Exécuter l'action de recherche avec préservation du texte
function executeSearchAction(type, title, searchTerm) {
    console.log("🔍 Navigation vers:", type, "-", title);
    
    // Sauvegarder le terme de recherche pour le réutiliser
    window.lastSearchTerm = searchTerm;
    window.lastSearchResult = { type, title };
    
    // Fermer les résultats
    closeSearchResults();
    
    // Naviguer vers la page appropriée
    switch(type) {
        case 'Examen':
            openExamPage();
            // Optionnel: highlight l'examen trouvé
            setTimeout(() => highlightFoundItem('exam', title), 300);
            break;
            
        case 'Rappel':
            openReminderPage();
            // Highlight le rappel trouvé
            setTimeout(() => highlightFoundItem('reminder', title), 300);
            break;
            
        case 'Matière':
            showPage('schedule-page');
            // Highlight la matière trouvée
            setTimeout(() => highlightFoundItem('subject', title), 300);
            break;
            
        case 'Bulletin':
        case 'Note':
            openGradesPage();
            // Highlight le bulletin trouvé
            setTimeout(() => highlightFoundItem('bulletin', title), 300);
            break;
            
        case '🗑️ Examen':
        case '🗑️ Rappel':
        case '🗑️ Matière':
        case '🗑️ Bulletin':
            showPage('settings-page');
            break;
            
        default:
            console.log("Type non géré:", type);
    }
}

// Fonction pour highlight l'élément trouvé (à adapter selon vos pages)
function highlightFoundItem(itemType, title) {
    console.log(`🎯 Highlight: ${itemType} - ${title}`);
    
    switch(itemType) {
        case 'reminder':
            // Trouver et highlight le rappel dans la page rappel
            const reminderItems = document.querySelectorAll('#reminder-list > div');
            reminderItems.forEach(item => {
                if (item.textContent.includes(title)) {
                    item.style.backgroundColor = '#FEF3C7'; // Jaune
                    item.style.borderLeft = '4px solid #F59E0B';
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Retirer le highlight après 3 secondes
                    setTimeout(() => {
                        item.style.backgroundColor = '';
                        item.style.borderLeft = '';
                    }, 3000);
                }
            });
            break;
            
        case 'exam':
            // Même logique pour les examens
            const examItems = document.querySelectorAll('#exam-list > div');
            examItems.forEach(item => {
                if (item.textContent.includes(title)) {
                    item.style.backgroundColor = '#FEF3C7';
                    item.style.borderLeft = '4px solid #F59E0B';
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    setTimeout(() => {
                        item.style.backgroundColor = '';
                        item.style.borderLeft = '';
                    }, 3000);
                }
            });
            break;
            
        // Ajoutez d'autres cas selon vos besoins
    }
}

// Fermer les résultats de recherche
function closeSearchResults() {
    const existingModal = document.getElementById('search-results-modal');
    if (existingModal) {
        existingModal.remove();
    }
}

// Fonction pour une matière (optionnelle)
function highlightSubject(scheduleIndex, day, time) {
    // Implémentez cette fonction si vous voulez surligner la matière trouvée
    console.log(`Highlight: ${scheduleIndex}, ${day}, ${time}`);
}

// Afficher les résultats de recherche
function showSearchResults(results, searchTerm) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-xl w-full max-w-2xl max-h-96 overflow-y-auto">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">Résultats pour "${searchTerm}"</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="p-4">
                ${results.length === 0 ? 
                    '<p class="text-center text-gray-500 py-8">Aucun résultat trouvé</p>' : 
                    results.map(result => `
                        <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer" onclick="result.action(); this.closest('.fixed').remove();">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium">${result.title}</div>
                                    <div class="text-sm text-gray-600">${result.description}</div>
                                </div>
                                <span class="px-2 py-1 bg-purple-100 text-purple-600 text-xs rounded-full">${result.type}</span>
                            </div>
                        </div>
                    `).join('')
                }
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    feather.replace();
}
// Mettre à jour l'affichage du profil - VERSION CORRIGÉE
function updateProfileDisplay() {
    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
    console.log("📸 Profil chargé:", userProfile);
    
    // Photo de profil - CORRECTION ICI
    const homeProfileImage = document.getElementById('homeProfileImage');
    const homeProfileIcon = document.getElementById('homeProfileIcon');
    
    if (userProfile.profileImage && userProfile.profileImage !== '') {
        console.log("🖼️ Photo trouvée:", userProfile.profileImage.substring(0, 50) + "...");
        homeProfileImage.src = userProfile.profileImage;
        homeProfileImage.classList.remove('hidden');
        homeProfileIcon.classList.add('hidden');
    } else {
        console.log("❌ Aucune photo de profil");
        homeProfileImage.classList.add('hidden');
        homeProfileIcon.classList.remove('hidden');
    }
    
    // Nom d'utilisateur - CORRECTION ICI
    const userDisplayName = document.getElementById('userDisplayName');
    if (userProfile.name && userProfile.name !== 'Jean Dupont' && userProfile.name.trim() !== '') {
        userDisplayName.textContent = userProfile.name + '!';
    } else {
        userDisplayName.textContent = '!';
    }
    
    // Salutation dynamique - CORRECTION ICI
    const dynamicGreeting = document.getElementById('dynamicGreeting');
    const dayGreeting = getDaySpecificGreeting();
    const timeGreeting = getDynamicGreeting();
    
    dynamicGreeting.textContent = dayGreeting || timeGreeting;
    
    // Statut
    const userStatusDisplay = document.getElementById('userStatusDisplay');
    const statusMap = {
        'student': ' Élève',
        'college': 'Étudiant', 
        'teacher': 'Professeur'
    };
    userStatusDisplay.textContent = statusMap[userProfile.status] || ' Élève';
    
    // Citation - CORRECTION ICI
    const dailyQuote = document.getElementById('dailyQuote');
    dailyQuote.textContent = `"${getRandomQuote()}"`;
}
      
      
      // Mettre à jour l'affichage du profil - VERSION CORRIGÉE
function updateProfileDisplay() {
    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
    console.log("📸 Profil chargé:", userProfile);
    
    // Photo de profil
    const homeProfileImage = document.getElementById('homeProfileImage');
    const homeProfileIcon = document.getElementById('homeProfileIcon');
    
    if (userProfile.profileImage && userProfile.profileImage !== '') {
        console.log("🖼️ Photo trouvée:", userProfile.profileImage.substring(0, 50) + "...");
        homeProfileImage.src = userProfile.profileImage;
        homeProfileImage.classList.remove('hidden');
        homeProfileIcon.classList.add('hidden');
    } else {
        console.log("❌ Aucune photo de profil");
        homeProfileImage.classList.add('hidden');
        homeProfileIcon.classList.remove('hidden');
    }
    
    // Nom d'utilisateur
    const userDisplayName = document.getElementById('userDisplayName');
    if (userProfile.name && userProfile.name !== 'Jean Dupont' && userProfile.name.trim() !== '') {
        userDisplayName.textContent = userProfile.name + '!';
    } else {
        userDisplayName.textContent = '!';
    }
    
    // Salutation dynamique
    const dynamicGreeting = document.getElementById('dynamicGreeting');
    const dayGreeting = getDaySpecificGreeting();
    const timeGreeting = getDynamicGreeting();
    
    dynamicGreeting.textContent = dayGreeting || timeGreeting;
    
    // Statut
    const userStatusDisplay = document.getElementById('userStatusDisplay');
    const statusMap = {
        'student': 'Élève',
        'college': 'Étudiant', 
        'teacher': 'Professeur'
    };
    userStatusDisplay.textContent = statusMap[userProfile.status] || 'Élève';
    
    // Citation
    const dailyQuote = document.getElementById('dailyQuote');
    dailyQuote.textContent = `"${getRandomQuote()}"`;
}

// Salutations dynamiques - VERSION CORRIGÉE
function getDynamicGreeting() {
    const now = new Date();
    const hour = now.getHours();
    console.log("🕐 Heure actuelle:", hour);
    
    // Salutations selon l'heure
    if (hour >= 5 && hour < 10) {
        const greetings = ["Bon réveil", "Belle matinée", "Bon début de journée"];
        return greetings[Math.floor(Math.random() * greetings.length)];
    } else if (hour >= 10 && hour < 12) {
        const greetings = ["Bonjour", "Bonne avant-midi", "Excellente journée"];
        return greetings[Math.floor(Math.random() * greetings.length)];
    } else if (hour >= 12 && hour < 14) {
        return "Bon appétit";
    } else if (hour >= 14 && hour < 18) {
        const greetings = ["Bon après-midi", "Bonne continuation", "Courage pour la suite"];
        return greetings[Math.floor(Math.random() * greetings.length)];
    } else if (hour >= 18 && hour < 22) {
        const greetings = ["Bonsoir", "Belle soirée", "Bon repos"];
        return greetings[Math.floor(Math.random() * greetings.length)];
    } else {
        // 22h à 4h59
        const greetings = ["Bonne nuit", "Doux rêves", "Repose-toi bien"];
        return greetings[Math.floor(Math.random() * greetings.length)];
    }
}

// Salutations spéciales selon le jour
function getDaySpecificGreeting() {
    const now = new Date();
    const day = now.getDay(); // 0 = dimanche, 1 = lundi...
    
    switch(day) {
        case 1: return "Bon début de semaine 💪";
        case 5: return "Bon vendredi 🎉"; 
        case 6: 
        case 0: return "Bon weekend 😊";
        default: return null;
    }
}

// Obtenir une citation aléatoire
function getRandomQuote() {
    const quotes = [
        "La persévérance est la clé de la réussite.",
        "Chaque expert était autrefois un débutant.",
        "Le savoir est la seule chose qui s'accroît quand on le partage.",
        "L'éducation est l'arme la plus puissante pour changer le monde.",
        "Le succès, c'est d'aller d'échec en échec sans perdre son enthousiasme.",
        "La discipline est le pont entre les objectifs et leur réalisation.",
        "Crois en toi et tout deviendra possible.",
        "Le futur appartient à ceux qui croient en la beauté de leurs rêves.",
        "Chaque jour est une nouvelle occasion d'apprendre.",
        "La curiosité est le moteur de l'apprentissage.",
        "Les difficultés préparent les gens ordinaires à des destins extraordinaires.",
        "Ton éducation est un entraînement pour l'esprit.",
        "Le plus grand risque est de ne prendre aucun risque.",
        "La qualité de ton apprentissage détermine la qualité de ta vie.",
        "Sois le changement que tu veux voir dans le monde."
    ];
    
    const now = new Date();
    const seed = now.getHours() * 60 + now.getMinutes();
    const quoteIndex = seed % quotes.length;
    
    return quotes[quoteIndex];
}

// Ajoutez cet appel dans la fonction initPage() de l'accueil :
function initPage() {
    feather.replace();
    
    // ⭐⭐ FORCER le chargement du profil en PREMIER
    console.log("🚀 Initialisation de la page...");
    updateProfileDisplay();
    
    // Le reste du code existant...
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('current-date').textContent = now.toLocaleDateString('fr-FR', options);
    
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    
    updateHomePageGrades();
    loadNextExam();
    loadNextSubjects();
    updateRemindersDisplay();
    
    setTimeout(() => {
        loadStrengthWeaknessCharts();
        updateEvolutionChart();
    }, 800);
    
    setInterval(loadNextExam, 1000);
    setInterval(loadNextSubjects, 60000);
    addDebugButton();
}
      
      // Rafraîchir l'affichage quand on revient sur la page
window.addEventListener('pageshow', function(event) {
    if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
        console.log("🔄 Page restaurée - Mise à jour du profil");
        updateProfileDisplay();
    }
});

// Rafraîchir aussi quand on change de page et qu'on revient
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        setTimeout(updateProfileDisplay, 100);
    }
});
      // === GESTION DE LA FERMETURE DE LA RECHERCHE ===
// Fermer la recherche quand on clique ailleurs
document.addEventListener('click', function(event) {
    const searchInput = document.getElementById('global-search');
    const searchModal = document.getElementById('search-results-modal');
    
    if (searchModal && !searchInput.contains(event.target) && !searchModal.contains(event.target)) {
        closeSearchResults();
    }
});

// Fermer avec la touche Échap
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeSearchResults();
    }
});
    </script>
    <!-- Page Bulletin de Notes -->
<div id="grades-page" class="hidden fixed inset-0 bg-white z-50 p-6 overflow-y-auto">
    <div class="flex items-center justify-between mb-6">
        <button onclick="closeGradesPage()" class="text-gray-500 hover:text-purple-600">
            <i data-feather="arrow-left"></i> Retour
        </button>
        <h2 class="text-xl font-semibold flex items-center">
            <i data-feather="file-text" class="mr-2"></i> Bulletin de Notes
        </h2>
        <button onclick="calculateGrades()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
            Calculer
        </button>
    </div>

  <!-- Formulaire d'information SIMPLIFIÉ -->
<div class="bg-white rounded-xl shadow-sm p-6 mb-6">
    <h3 class="text-lg font-semibold mb-4">Informations du bulletin</h3>
    <div class="grid grid-cols-1 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Titre du bulletin</label>
            <input type="text" id="bulletin-title" placeholder="Ex: 1er Devoir du 1er Semestre" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-200">
        </div>
    </div>
</div>

    <!-- Tableau des notes -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Notes par matière</h3>
            <button onclick="addSubjectRow()" class="text-purple-600 flex items-center">
                <i data-feather="plus" class="mr-1 w-4 h-4"></i> Ajouter une matière
            </button>
        </div>
        
        <div class="overflow-x-auto">
    <table class="w-full border-collapse border">
        <thead>
            <tr class="bg-gray-50">
                <th class="border p-2 text-left w-2/3">Matière</th>
                <th class="border p-2 text-center w-1/6">Coefficient</th>
                <th class="border p-2 text-center w-1/6">Note</th>
                <th class="border p-2 text-center w-1/12">Actions</th>
            </tr>
        </thead>
        <tbody id="grades-table-body">
            <!-- Les lignes seront ajoutées dynamiquement -->
        </tbody>
    </table>
</div>
    </div>

    <!-- Résultats calculés -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <h3 class="text-lg font-semibold mb-4">Résultats</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-purple-600" id="total-coeff">0</div>
                <div class="text-sm text-gray-600">Total Coeff</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-blue-600" id="total-points">0</div>
                <div class="text-sm text-gray-600">Total Points</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-green-600" id="average">0.00</div>
                <div class="text-sm text-gray-600">Moyenne</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <input type="text" id="student-rank" placeholder="Rang" 
                       class="w-full text-center text-lg font-bold border-none focus:ring-0">
                <div class="text-sm text-gray-600">Rang</div>
            </div>
        </div>
    </div>

    <!-- Boutons d'action -->
    <div class="flex justify-end space-x-4 mb-8">
        <button onclick="closeGradesPage()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
            Annuler
        </button>
        <button onclick="saveBulletinAndRefresh()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
    Enregistrer le bulletin
</button>
    </div>

    <!-- Liste des bulletins sauvegards -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold mb-4">Bulletins enregistrés</h3>
        <div id="saved-bulletins-list" class="space-y-3">
            <!-- Les bulletins sauvegardés s'afficheront ici -->
        </div>
    </div>
</div>
</body>
</html>
