<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carnet de l'élève</title>
    <style>
        :root {
            --primary: #6C63FF;
            --secondary: #4FC3F7;
            --accent: #FF6B9D;
            --success: #4CD97B;
            --warning: #FFB74D;
            --danger: #FF5252;
            --dark: #2D3047;
            --light: #F9F7FE;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --primary: #8B80F8;
            --secondary: #66D3FA;
            --accent: #FF8BB5;
            --success: #6AE395;
            --warning: #FFC870;
            --danger: #FF6B6B;
            --dark: #1A1C2B;
            --light: #25283D;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--light) 0%, #E8EAF6 100%);
            color: var(--dark);
            min-height: 100vh;
            padding-bottom: 80px;
            transition: var(--transition);
        }

        body.dark-mode {
            background: linear-gradient(135deg, var(--dark) 0%, #1E1F2E 100%);
            color: var(--light);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--shadow);
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #5A52E0;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            opacity: 0.7;
        }

        .btn-danger:hover {
            opacity: 1;
        }

        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
            text-decoration: none;
            font-size: 12px;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .subject-card {
            position: relative;
            overflow: hidden;
        }

        .subject-color {
            height: 4px;
            background: var(--primary);
            margin-bottom: 12px;
            border-radius: 2px;
        }

        .sparkline {
            height: 40px;
            margin-top: 12px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            font-size: 14px;
            margin: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--light);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .dark-mode .modal-content {
            background: var(--dark);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            background: var(--glass);
            color: var(--dark);
            transition: var(--transition);
        }

        .dark-mode .form-input {
            color: var(--light);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
        }

        .file-preview {
            margin-top: 20px;
            padding: 20px;
            background: var(--glass);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .timetable {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 1px;
            background: var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .timetable-header {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .timetable-cell {
            background: var(--light);
            padding: 8px;
            min-height: 60px;
            font-size: 12px;
        }

        .dark-mode .timetable-cell {
            background: var(--dark);
        }

        .time-slot {
            background: var(--secondary);
            color: white;
            padding: 6px 8px;
            border-radius: 8px;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .pdf-viewer {
            width: 100%;
            height: 600px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .streak {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--glass);
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--accent);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .subject-grid {
                grid-template-columns: 1fr;
            }
            
            .timetable {
                grid-template-columns: 50px repeat(7, 1fr);
                font-size: 11px;
            }
            
            .pdf-viewer {
                height: 400px;
            }
        }

        .ripple {
            position: relative;
            overflow: hidden;
            transform: translate3d(0, 0, 0);
        }

        .ripple:after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }

        .ripple:active:after {
            transform: scale(0, 0);
            opacity: .2;
            transition: 0s;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page d'accueil -->
        <div id="home-page" class="page active">
            <div class="card glass">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                    <h1>Bonjour, <span id="user-name">Élève</span></h1>
                    <button class="btn btn-secondary" onclick="showFormules()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 18h2V6H7v12zM11 18h2V6h-2v12zM15 18h2V6h-2v12z"/>
                        </svg>
                        FORMULES
                    </button>
                </div>
                <div class="streak">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="#FFB74D">
                        <path d="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.967-7.417 3.967 1.481-8.279-6.064-5.828 8.332-1.151z"/>
                    </svg>
                    <span>Série de révision : <strong id="streak-count">0</strong> jours</span>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.8;">Chaque ligne apprise aujourd'hui allume une étoile pour demain.</p>
            </div>

            <div id="subjects-overview">
                <!-- Les matières seront ajoutées ici dynamiquement -->
            </div>
        </div>

        <!-- Page Matières -->
        <div id="subjects-page" class="page">
            <div class="card glass">
                <h2>Matières</h2>
                <p style="margin-bottom: 20px; opacity: 0.8;">Organisez votre savoir, construisez votre avenir.</p>
                <button class="btn btn-primary" onclick="showAddSubjectModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Nouvelle matière
                </button>
            </div>

            <div id="subjects-list" class="subject-grid">
                <!-- Les matières seront ajoutées ici dynamiquement -->
            </div>
        </div>

        <!-- Page Formules (Nouvelle) -->
        <div id="formules-page" class="page">
            <div class="card glass">
                <h2>Formules par Matière</h2>
                <p style="margin-bottom: 20px; opacity: 0.8;">Maîtrisez les concepts fondamentaux de chaque discipline.</p>
            </div>

            <div id="formules-list" class="subject-grid">
                <!-- Les formules par matière seront ajoutées ici dynamiquement -->
            </div>
        </div>

        <!-- Page Détail Matière/Formules -->
        <div id="subject-detail-page" class="page">
            <div class="card glass">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                    <h2 id="subject-detail-title">Matière</h2>
                    <button class="btn btn-secondary" onclick="goBack()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                        </svg>
                        Retour
                    </button>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="photo">PHOTO</div>
                    <div class="tab" data-tab="video">VIDEO</div>
                    <div class="tab" data-tab="note">NOTE</div>
                    <div class="tab" data-tab="document">DOCUMENT</div>
                </div>

                <div id="categories-section">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 16px;">
                        <h4>Catégories</h4>
                        <button class="btn btn-primary" onclick="showAddCategoryModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                            Catégorie
                        </button>
                    </div>
                    <div id="categories-list">
                        <!-- Catégories dynamiques -->
                    </div>
                </div>

                <div id="content-area">
                    <!-- Contenu dynamique par onglet et catégorie -->
                </div>
            </div>
        </div>

        <!-- Page Emploi du temps -->
        <div id="timetable-page" class="page">
            <div class="card glass">
                <h2>Emploi du temps</h2>
                <p style="margin-bottom: 20px; opacity: 0.8;">Organisez votre temps, maximisez votre potentiel.</p>
                
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <button class="btn btn-primary" id="school-context-btn" onclick="switchTimetableContext('school')">
                        À l'école/Université
                    </button>
                    <button class="btn btn-secondary" id="home-context-btn" onclick="switchTimetableContext('home')">
                        À la maison
                    </button>
                </div>

                <button class="btn btn-primary" onclick="showAddTimeslotModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Nouveau créneau
                </button>
            </div>

            <div id="timetable-container" class="card glass">
                <!-- Emploi du temps dynamique -->
            </div>
        </div>

        <!-- Page Bibliothèque -->
        <div id="library-page" class="page">
            <div class="card glass">
                <h2>Bibliothèque</h2>
                <p style="margin-bottom: 20px; opacity: 0.8;">Votre savoir en un seul endroit.</p>
                
                <input type="file" id="pdf-upload" accept=".pdf" style="display: none;" onchange="handlePdfUpload(this.files[0])">
                <button class="btn btn-primary" onclick="document.getElementById('pdf-upload').click()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Importer PDF
                </button>
            </div>

            <div id="library-list" class="subject-grid">
                <!-- Liste des PDFs dynamique -->
            </div>
        </div>

        <!-- Page Paramètres -->
        <div id="settings-page" class="page">
            <div class="card glass">
                <h2>Paramètres</h2>
                <p style="margin-bottom: 20px; opacity: 0.8;">Personnalisez votre expérience d'apprentissage.</p>

                <div class="form-group">
                    <label class="form-label">Mode sombre</label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                        <span>Activer/désactiver</span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">Rétention corbeille (jours)</label>
                    <input type="number" id="trash-retention" class="form-input" value="30" min="1">
                </div>

                <div class="form-group">
                    <label class="form-label">Export/Import</label>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="exportData()">Exporter données</button>
                        <input type="file" id="import-file" accept=".json,.carnet" style="display: none;" onchange="importData(this.files[0])">
                        <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">Importer données</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Mode Développeur</label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="dev-mode-toggle" onchange="toggleDevMode()">
                        <span>Activer/désactiver</span>
                    </label>
                </div>

                <button class="btn btn-danger" onclick="showResetModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    Réinitialiser l'application
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation inférieure -->
    <div class="nav-bottom">
        <div class="nav-item active" data-page="home-page">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
            <span>Accueil</span>
        </div>
        <div class="nav-item" data-page="subjects-page">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/>
            </svg>
            <span>Matières</span>
        </div>
        <div class="nav-item" data-page="timetable-page">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
            </svg>
            <span>Emploi du temps</span>
        </div>
        <div class="nav-item" data-page="library-page">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/>
            </svg>
            <span>Bibliothèque</span>
        </div>
        <div class="nav-item" data-page="settings-page">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
            <span>Paramètres</span>
        </div>
    </div>

    <!-- Modals -->
    <div id="onboarding-modal" class="modal active">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; text-align: center;">Bienvenue dans votre Carnet</h2>
            <p style="margin-bottom: 30px; text-align: center; opacity: 0.8;">Commencez par personnaliser votre profil</p>
            
            <div class="form-group">
                <label class="form-label">Votre nom</label>
                <input type="text" id="user-name-input" class="form-input" placeholder="Votre nom">
            </div>
            
            <div class="form-group">
                <label class="form-label">Je suis</label>
                <select id="user-status" class="form-input">
                    <option value="school">Écolier</option>
                    <option value="student">Étudiant</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Classe/Niveau</label>
                <input type="text" id="user-class" class="form-input" placeholder="Ex: Terminale S, Licence 2...">
            </div>
            
            <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="completeOnboarding()">
                Commencer l'aventure
            </button>
        </div>
    </div>

    <!-- Autres modals seront ajoutés dynamiquement -->

    <script>
        // =============================================================================
        // README INTERNE - Structure et Documentation
        // =============================================================================
        /*
        CARNET DE L'ÉLÈVE/ÉTUDIANT - Application Web Complète
        
        STRUCTURE DES STORES INDEXEDDB:
        - profile: { id: 1, name, status, class, streak, settings }
        - subjects: { id, name, color, coefficient, createdAt }
        - categories: { id, subjectId, name, type (photo/video/note/document), order }
        - items: { id, categoryId, type, title, content, fileBlob, order, createdAt }
        - grades: { id, subjectId, title, grade, coefficient, date, category }
        - timetable: { id, context (school/home), day, startTime, endTime, subjectId, room, notes, reminder }
        - library: { id, title, fileName, fileBlob, lastPage, totalPages, createdAt }
        - backups: { id, timestamp, data, hash, encrypted }
        - trash: { id, originalStore, originalData, deletedAt }
        - logs: { id, action, timestamp, details }
        
        ALGORITHMES DE CALCUL DES MOYENNES:
        - Moyenne matière: Σ(grade * coefficient) / Σ(coefficient)
        - Moyenne générale: Σ(moyenne_matière * coefficient_matière) / Σ(coefficient_matière)
        - Arrondi à 2 décimales, drop lowest n optionnel
        - Conversion automatique sur 20
        
        FLOW DE SUPPRESSION / CORBEILLE:
        1. Première confirmation modale "Êtes-vous sûr ?"
        2. Deuxième confirmation avec saisie "SUPPRIMER" ou nom
        3. Soft delete: déplacement vers trash avec deletedAt
        4. Retention: 30 jours par défaut (configurable)
        5. Restauration possible depuis corbeille
        
        BACKUPS & LASTPAGE:
        - Export: JSON chiffré (AES-GCM) ou non avec mot de passe optionnel
        - Import: Support .carnet (chiffré) et JSON, merge/overwrite
        - LastPage PDF: Stockée dans IndexedDB + localStorage + backups
        - Réinitialisation: Préserve lastPage via backup si disponible
        - Si données navigateur supprimées manuellement: restauration impossible
        
        TRASH RETENTION DAYS:
        - Modifiable dans Settings -> trash-retention input
        - Valeur par défaut: 30 jours
        
        PBKDF2 ITERATIONS:
        - Valeur production: 100000
        - Pour debug: réduire à 1000 dans encryptJSON/decryptJSON
        */

        // =============================================================================
        // VARIABLES GLOBALES ET INITIALISATION
        // =============================================================================
        let db = null;
        let currentSubjectId = null;
        let currentTab = 'photo';
        let currentContext = 'school';

        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            await checkOnboarding();
            setupNavigation();
            loadAllData();
        });

        // =============================================================================
        // BASE DE DONNÉES INDEXEDDB
        // =============================================================================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('StudentNotebook', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Stores principaux
                    if (!db.objectStoreNames.contains('profile')) {
                        db.createObjectStore('profile', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('subjects')) {
                        db.createObjectStore('subjects', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('categories')) {
                        db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('items')) {
                        db.createObjectStore('items', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('grades')) {
                        db.createObjectStore('grades', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('timetable')) {
                        db.createObjectStore('timetable', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('library')) {
                        db.createObjectStore('library', { keyPath: 'id', autoIncrement: true });
                    }
                    
                    // Stores système
                    if (!db.objectStoreNames.contains('backups')) {
                        db.createObjectStore('backups', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('trash')) {
                        db.createObjectStore('trash', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('logs')) {
                        db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        // =============================================================================
        // FONCTIONS UTILITAIRES POUR INDEXEDDB
        // =============================================================================
        function dbAction(storeName, action, data = null) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                let request;
                switch (action) {
                    case 'add':
                        request = store.add(data);
                        break;
                    case 'put':
                        request = store.put(data);
                        break;
                    case 'get':
                        request = store.get(data);
                        break;
                    case 'getAll':
                        request = store.getAll();
                        break;
                    case 'delete':
                        request = store.delete(data);
                        break;
                }
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // =============================================================================
        // GESTION DE L'ONBOARDING
        // =============================================================================
        async function checkOnboarding() {
            const profile = await dbAction('profile', 'get', 1);
            if (!profile) {
                showModal('onboarding-modal');
            } else {
                document.getElementById('user-name').textContent = profile.name;
                document.getElementById('streak-count').textContent = profile.streak || 0;
                
                // Appliquer les paramètres
                if (profile.settings?.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('dark-mode-toggle').checked = true;
                }
            }
        }

        async function completeOnboarding() {
            const name = document.getElementById('user-name-input').value;
            const status = document.getElementById('user-status').value;
            const userClass = document.getElementById('user-class').value;
            
            if (!name.trim()) {
                alert('Veuillez entrer votre nom');
                return;
            }
            
            const profile = {
                id: 1,
                name: name.trim(),
                status: status,
                class: userClass.trim(),
                streak: 0,
                settings: {
                    darkMode: false,
                    trashRetentionDays: 30
                },
                createdAt: new Date()
            };
            
            await dbAction('profile', 'put', profile);
            document.getElementById('user-name').textContent = profile.name;
            hideModal('onboarding-modal');
            loadAllData();
        }

        // =============================================================================
        // NAVIGATION ET UI
        // =============================================================================
        function setupNavigation() {
            // Navigation principale
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    // Mettre à jour l'état actif
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Afficher la page correspondante
                    const pageId = this.getAttribute('data-page');
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                });
            });

            // Gestion des onglets dans le détail matière
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('tab')) {
                    const tabs = e.target.parentElement.querySelectorAll('.tab');
                    tabs.forEach(tab => tab.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    currentTab = e.target.getAttribute('data-tab');
                    loadSubjectDetailContent();
                }
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${pageId}"]`).classList.add('active');
        }

        function goBack() {
            showPage('subjects-page');
        }

        function showFormules() {
            loadFormulesPage();
            showPage('formules-page');
        }

        // =============================================================================
        // GESTION DES MATIÈRES
        // =============================================================================
        async function loadAllData() {
            await loadHomePage();
            await loadSubjectsPage();
            await loadTimetablePage();
            await loadLibraryPage();
        }

        async function loadHomePage() {
            const subjects = await dbAction('subjects', 'getAll');
            const grades = await dbAction('grades', 'getAll');
            
            const container = document.getElementById('subjects-overview');
            container.innerHTML = '';
            
            subjects.forEach(subject => {
                const subjectGrades = grades.filter(g => g.subjectId === subject.id);
                const average = calculateSubjectAverage(subjectGrades);
                
                const card = document.createElement('div');
                card.className = 'card subject-card glass';
                card.innerHTML = `
                    <div class="subject-color" style="background: ${subject.color || '#6C63FF'}"></div>
                    <h3>${subject.name}</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                        <span style="font-size: 24px; font-weight: bold;">${average}</span>
                        <canvas class="sparkline" width="100" height="40"></canvas>
                    </div>
                    <p style="margin-top: 8px; opacity: 0.7; font-size: 14px;">Coefficient: ${subject.coefficient || 1}</p>
                `;
                
                card.addEventListener('click', () => openSubjectDetail(subject.id));
                container.appendChild(card);
                
                // Dessiner le sparkline
                setTimeout(() => drawSparkline(card.querySelector('.sparkline'), subjectGrades), 100);
            });
        }

        async function loadSubjectsPage() {
            const subjects = await dbAction('subjects', 'getAll');
            const container = document.getElementById('subjects-list');
            container.innerHTML = '';
            
            subjects.forEach(subject => {
                const card = document.createElement('div');
                card.className = 'card subject-card glass ripple';
                card.innerHTML = `
                    <div class="subject-color" style="background: ${subject.color || '#6C63FF'}"></div>
                    <h3>${subject.name}</h3>
                    <p style="margin: 12px 0; opacity: 0.7;">${subject.description || 'Aucune description'}</p>
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        <button class="btn btn-primary" onclick="openSubjectDetail(${subject.id})">Ouvrir</button>
                        <button class="btn btn-danger" onclick="deleteSubject(${subject.id})">Supprimer</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function showAddSubjectModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Nouvelle matière</h3>
                    <div class="form-group">
                        <label class="form-label">Nom de la matière</label>
                        <input type="text" id="subject-name" class="form-input" placeholder="Mathématiques, Physique...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Couleur</label>
                        <input type="color" id="subject-color" class="form-input" value="#6C63FF">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Coefficient</label>
                        <input type="number" id="subject-coefficient" class="form-input" value="1" min="1" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="subject-description" class="form-input" placeholder="Description de la matière..."></textarea>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="addSubject()">Créer</button>
                        <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))">Annuler</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addSubject() {
            const name = document.getElementById('subject-name').value;
            const color = document.getElementById('subject-color').value;
            const coefficient = parseFloat(document.getElementById('subject-coefficient').value);
            const description = document.getElementById('subject-description').value;
            
            if (!name.trim()) {
                alert('Veuillez entrer un nom pour la matière');
                return;
            }
            
            const subject = {
                name: name.trim(),
                color: color,
                coefficient: coefficient,
                description: description.trim(),
                createdAt: new Date()
            };
            
            await dbAction('subjects', 'add', subject);
            hideModal(document.querySelector('.modal.active'));
            loadAllData();
        }

        // =============================================================================
        // PAGE FORMULES
        // =============================================================================
        async function loadFormulesPage() {
            const subjects = await dbAction('subjects', 'getAll');
            const container = document.getElementById('formules-list');
            container.innerHTML = '';
            
            subjects.forEach(subject => {
                const card = document.createElement('div');
                card.className = 'card subject-card glass ripple';
                card.innerHTML = `
                    <div class="subject-color" style="background: ${subject.color || '#6C63FF'}"></div>
                    <h3>${subject.name}</h3>
                    <p style="margin: 12px 0; opacity: 0.7;">Formules et concepts clés</p>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="openFormulesDetail(${subject.id})">
                        Voir les formules
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function openFormulesDetail(subjectId) {
            currentSubjectId = subjectId;
            document.getElementById('subject-detail-title').textContent = 'Formules - ' + getSubjectName(subjectId);
            showPage('subject-detail-page');
            loadSubjectDetailContent();
        }

        // =============================================================================
        // DÉTAIL MATIÈRE/FORMULES
        // =============================================================================
        async function openSubjectDetail(subjectId) {
            currentSubjectId = subjectId;
            document.getElementById('subject-detail-title').textContent = getSubjectName(subjectId);
            showPage('subject-detail-page');
            loadSubjectDetailContent();
        }

        async function loadSubjectDetailContent() {
            await loadCategories();
            await loadCategoryContent();
        }

        async function loadCategories() {
            const categories = await dbAction('categories', 'getAll');
            const subjectCategories = categories.filter(c => c.subjectId === currentSubjectId && c.type === currentTab);
            
            const container = document.getElementById('categories-list');
            container.innerHTML = '';
            
            subjectCategories.forEach(category => {
                const badge = document.createElement('span');
                badge.className = 'category-badge';
                badge.innerHTML = `
                    ${category.name}
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" onclick="deleteCategory(${category.id})" style="cursor: pointer;">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                `;
                container.appendChild(badge);
            });
        }

        function showAddCategoryModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Nouvelle catégorie</h3>
                    <div class="form-group">
                        <label class="form-label">Nom de la catégorie</label>
                        <input type="text" id="category-name" class="form-input" placeholder="Fiches, Exercices, Cours...">
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="addCategory()">Créer</button>
                        <button class="btn btn-secondary" onclick="hideModal(this.closest('.modal'))">Annuler</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addCategory() {
            const name = document.getElementById('category-name').value;
            
            if (!name.trim()) {
                alert('Veuillez entrer un nom pour la catégorie');
                return;
            }
            
            const category = {
                subjectId: currentSubjectId,
                name: name.trim(),
                type: currentTab,
                order: 0,
                createdAt: new Date()
            };
            
            await dbAction('categories', 'add', category);
            hideModal(document.querySelector('.modal.active'));
            loadCategories();
        }

        async function loadCategoryContent() {
            const container = document.getElementById('content-area');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; opacity: 0.7;">
                    <p>Ajoutez du contenu à vos catégories pour ${currentTab}</p>
                    <button class="btn btn-primary" onclick="showAddContentModal()" style="margin-top: 16px;">
                        Ajouter du contenu
                    </button>
                </div>
            `;
        }

        // =============================================================================
        // EMPLOI DU TEMPS
        // =============================================================================
        async function loadTimetablePage() {
            const timetable = await dbAction('timetable', 'getAll');
            const contextTimetable = timetable.filter(t => t.context === currentContext);
            
            const container = document.getElementById('timetable-container');
            container.innerHTML = `
                <div class="timetable">
                    <div class="timetable-header"></div>
                    <div class="timetable-header">Lun</div>
                    <div class="timetable-header">Mar</div>
                    <div class="timetable-header">Mer</div>
                    <div class="timetable-header">Jeu</div>
                    <div class="timetable-header">Ven</div>
                    <div class="timetable-header">Sam</div>
                    <div class="timetable-header">Dim</div>
                    
                    ${generateTimeSlots(contextTimetable)}
                </div>
            `;
        }

        function generateTimeSlots(timetable) {
            let html = '';
            const timeSlots = ['08:00-09:00', '09:00-10:00', '10:00-11:00', '11:00-12:00', '12:00-13:00', 
                              '13:00-14:00', '14:00-15:00', '15:00-16:00', '16:00-17:00', '17:00-18:00'];
            
            timeSlots.forEach(timeSlot => {
                html += `<div class="timetable-header">${timeSlot}</div>`;
                
                for (let day = 1; day <= 7; day++) {
                    const slots = timetable.filter(t => t.day === day && t.startTime === timeSlot.split('-')[0]);
                    html += `<div class="timetable-cell">`;
                    slots.forEach(slot => {
                        html += `<div class="time-slot">${getSubjectName(slot.subjectId)}</div>`;
                    });
                    html += `</div>`;
                }
            });
            
            return html;
        }

        function switchTimetableContext(context) {
            currentContext = context;
            document.getElementById('school-context-btn').classList.toggle('btn-primary', context === 'school');
            document.getElementById('school-context-btn').classList.toggle('btn-secondary', context !== 'school');
            document.getElementById('home-context-btn').classList.toggle('btn-primary', context === 'home');
            document.getElementById('home-context-btn').classList.toggle('btn-secondary', context !== 'home');
            loadTimetablePage();
        }

        // =============================================================================
        // BIBLIOTHÈQUE PDF
        // =============================================================================
        async function loadLibraryPage() {
            const library = await dbAction('library', 'getAll');
            const container = document.getElementById('library-list');
            container.innerHTML = '';
            
            library.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card glass';
                card.innerHTML = `
                    <h3>${item.title}</h3>
                    <p style="margin: 12px 0; opacity: 0.7;">Dernière page: ${item.lastPage || 1}</p>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="openPdf(${item.id})">Lire</button>
                        <button class="btn btn-danger" onclick="deletePdf(${item.id})">Supprimer</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function handlePdfUpload(file) {
            if (!file || file.type !== 'application/pdf') {
                alert('Veuillez sélectionner un fichier PDF valide');
                return;
            }
            
            const arrayBuffer = await file.arrayBuffer();
            const pdf = {
                title: file.name.replace('.pdf', ''),
                fileName: file.name,
                fileBlob: arrayBuffer,
                lastPage: 1,
                totalPages: 0,
                createdAt: new Date()
            };
            
            await dbAction('library', 'add', pdf);
            loadLibraryPage();
        }

        // =============================================================================
        // CALCULS ET STATISTIQUES
        // =============================================================================
        function calculateSubjectAverage(grades) {
            if (!grades.length) return '--';
            
            const total = grades.reduce((sum, grade) => sum + (grade.grade * grade.coefficient), 0);
            const totalCoefficient = grades.reduce((sum, grade) => sum + grade.coefficient, 0);
            
            return (total / totalCoefficient).toFixed(2);
        }

        function drawSparkline(canvas, grades) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            if (!grades.length) {
                ctx.fillStyle = '#ccc';
                ctx.fillRect(0, height/2, width, 1);
                return;
            }
            
            const gradesValues = grades.map(g => g.grade).slice(-10); // Dernières 10 notes
            const maxGrade = Math.max(...gradesValues);
            const minGrade = Math.min(...gradesValues);
            const range = maxGrade - minGrade || 1;
            
            ctx.clearRect(0, 0, width, height);
            ctx.beginPath();
            
            gradesValues.forEach((grade, index) => {
                const x = (index / (gradesValues.length - 1)) * width;
                const y = height - ((grade - minGrade) / range) * height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.strokeStyle = '#6C63FF';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // =============================================================================
        // FONCTIONS UTILITAIRES
        // =============================================================================
        function getSubjectName(subjectId) {
            // Implémentation simplifiée - en réalité il faudrait récupérer depuis la DB
            return `Matière ${subjectId}`;
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalElement) {
            if (typeof modalElement === 'string') {
                document.getElementById(modalElement).classList.remove('active');
            } else {
                modalElement.classList.remove('active');
                if (modalElement.parentElement) {
                    modalElement.parentElement.removeChild(modalElement);
                }
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            // Sauvegarder le préférence
        }

        // =============================================================================
        // FONCTIONS STUB POUR LES FONCTIONNALITÉS MANQUANTES
        // =============================================================================
        function deleteSubject(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette matière ?')) {
                const confirmation = prompt('Tapez "SUPPRIMER" pour confirmer:');
                if (confirmation === 'SUPPRIMER') {
                    // Implémenter la suppression
                    console.log('Suppression matière:', id);
                }
            }
        }

        function deleteCategory(id) {
            if (confirm('Supprimer cette catégorie ?')) {
                console.log('Suppression catégorie:', id);
            }
        }

        function showAddContentModal() {
            alert('Fonctionnalité à implémenter: Ajout de contenu');
        }

        function showAddTimeslotModal() {
            alert('Fonctionnalité à implémenter: Ajout de créneau');
        }

        function openPdf(id) {
            alert(`Ouvrir PDF ${id} - Fonctionnalité à implémenter`);
        }

        function deletePdf(id) {
            if (confirm('Supprimer ce PDF ?')) {
                console.log('Suppression PDF:', id);
            }
        }

        function exportData() {
            alert('Fonctionnalité export à implémenter');
        }

        function importData(file) {
            alert('Fonctionnalité import à implémenter');
        }

        function toggleDevMode() {
            alert('Mode développeur activé/désactivé');
        }

        function showResetModal() {
            if (confirm('Réinitialiser toutes les données ? Cette action est irréversible.')) {
                const confirmation = prompt('Tapez "RÉINITIALISER" pour confirmer:');
                if (confirmation === 'RÉINITIALISER') {
                    alert('Réinitialisation - Fonctionnalité à implémenter');
                }
            }
        }

        // =============================================================================
        // SELF-TEST POUR LE MODE DÉVELOPPEUR
        // =============================================================================
        function selfTest() {
            console.log('=== SELF-TEST MODE DÉVELOPPEUR ===');
            
            // Test de moyenne
            const testGrades = [
                { grade: 15, coefficient: 1 },
                { grade: 18, coefficient: 2 },
                { grade: 12, coefficient: 1 }
            ];
            console.log('Test moyenne:', calculateSubjectAverage(testGrades));
            
            // Test autres fonctionnalités...
            console.log('=== SELF-TEST COMPLÉTÉ ===');
        }
    </script>
</body>
</html>
